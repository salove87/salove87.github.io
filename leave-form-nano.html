<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast{position:fixed;bottom:20px;right:20px;color:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;z-index:50}
    .toast.success{background:#16a34a}.toast.error{background:#dc2626}.toast.show{opacity:1;transform:translateY(0)}
    .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:12px;max-width:450px;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    .btn{display:inline-flex;align-items:center;gap:.5rem}
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
  <!-- HEADER + RULES -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <img src="https://i.postimg.cc/kMHv7FsP/loko-nano.png" alt="NANO Logo" class="h-10" onerror="this.style.display='none'">
      <div>
        <h1 class="text-xl font-bold text-gray-800">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h1>
        <p class="text-sm text-gray-500">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
      </div>
    </div>

    <div class="bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-lg mb-4 text-sm">
      <p class="font-semibold">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
      <ul class="list-disc ml-5">
        <li>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
        <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
        <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
        <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</li>
      </ul>
    </div>

    <!-- FORM -->
    <form id="leaveForm" class="space-y-4">
      <div>
        <label class="block text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="text" id="empId" class="w-full p-2 border rounded-lg" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="empName" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <input type="text" id="department" class="w-full p-2 border rounded-lg" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <select id="leaveType" class="w-full p-2 border rounded-lg" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
          <option>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
          <option>‡∏å‡∏≤‡∏õ‡∏ì‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
          <input type="date" id="startDate" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤</label>
          <input type="date" id="endDate" class="w-full p-2 border rounded-lg" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
        <input type="text" id="leaveDays" readonly class="w-full p-2 border bg-gray-100 rounded-lg">
      </div>
      <div>
        <label class="block text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <textarea id="reason" rows="3" class="w-full p-2 border rounded-lg" required></textarea>
      </div>
      <div>
        <label class="block text-gray-700">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
        <input type="text" id="approver" class="w-full p-2 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</label>
          <input type="date" id="submitDate" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
          <input type="text" id="systemTime" readonly class="w-full p-2 border bg-gray-100 rounded-lg">
        </div>
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
    </form>
  </div>

  <!-- LIST + CSV -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-6xl p-6 mt-2">
    <div class="flex justify-between items-center mb-4">
      <button id="downloadCSV" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm shadow">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
      <h2 class="text-xl font-bold text-blue-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)</h2>
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
      <table class="w-full text-sm text-left text-gray-700">
        <thead class="bg-gradient-to-r from-blue-100 to-blue-50 border-b text-blue-900">
          <tr>
            <th class="p-3 text-center">‡∏£‡∏´‡∏±‡∏™</th>
            <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th class="p-3 text-center">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
            <th class="p-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
            <th class="p-3 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="leaveTable" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</h3>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤:</label>
      <input type="date" id="editStart" class="w-full p-2 border rounded mb-2">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤:</label>
      <input type="date" id="editEnd" class="w-full p-2 border rounded mb-2">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤:</label>
      <input type="text" id="editDays" readonly class="w-full p-2 border bg-gray-100 rounded mb-2">
      <div class="flex justify-end gap-2 mt-3">
        <button id="saveEdit" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="cancelEdit" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD MODAL (DELETE) -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <input type="password" id="hrPasswordInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-2 border rounded mb-3">
      <div class="flex justify-end gap-2">
        <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded">‡∏•‡∏ö</button>
        <button id="cancelDelete" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast success">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Elements ---
      const form = document.getElementById('leaveForm');
      const leaveTable = document.getElementById('leaveTable');
      const toast = document.getElementById('toast');
      const downloadCSVBtn = document.getElementById('downloadCSV');

      const empId = document.getElementById('empId');
      const empName = document.getElementById('empName');
      const department = document.getElementById('department');
      const leaveType = document.getElementById('leaveType');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      const leaveDays = document.getElementById('leaveDays');
      const reason = document.getElementById('reason');
      const approver = document.getElementById('approver');
      const submitDate = document.getElementById('submitDate');
      const systemTimeEl = document.getElementById('systemTime');

      // Edit/Delete modals
      const editModal = document.getElementById('editModal');
      const editStart = document.getElementById('editStart');
      const editEnd = document.getElementById('editEnd');
      const editDays = document.getElementById('editDays');
      const saveEdit = document.getElementById('saveEdit');
      const cancelEdit = document.getElementById('cancelEdit');

      const passwordModal = document.getElementById('passwordModal');
      const hrPasswordInput = document.getElementById('hrPasswordInput');
      const confirmDelete = document.getElementById('confirmDelete');
      const cancelDelete = document.getElementById('cancelDelete');

      const HR_PASSWORD = '303647';

      // --- Helpers ---
      function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3500);
      }

      function updateSystemTime(){ systemTimeEl.value = new Date().toLocaleString('th-TH',{hour12:false}); }
      updateSystemTime();
      setInterval(updateSystemTime, 1000);

      function calcDays(){
        const s = new Date(startDate.value); const e = new Date(endDate.value);
        if(!isNaN(s) && !isNaN(e) && e>=s){
          const d = Math.floor((e - s)/(1000*60*60*24)) + 1;
          leaveDays.value = `${d} ‡∏ß‡∏±‡∏ô`;
        }else{ leaveDays.value = ''; }
      }
      startDate.addEventListener('change', calcDays);
      endDate.addEventListener('change', calcDays);

      // --- Client-side storage fallback (no backend) ---
      const storeKey = 'leave-requests:nano';
      function loadData(){
        try{ return JSON.parse(localStorage.getItem(storeKey)||'[]'); }catch{ return []; }
      }
      function saveData(arr){ localStorage.setItem(storeKey, JSON.stringify(arr)); }

      // --- Render table ---
      function renderTable(){
        const data = loadData().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        leaveTable.innerHTML = '';
        data.forEach((row, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class='p-3 text-center'>${row.empId||'-'}</td>
            <td class='p-3'>${row.empName||''}</td>
            <td class='p-3'>${row.leaveType||''}</td>
            <td class='p-3 text-center'>${row.startDate||''}</td>
            <td class='p-3 text-center'>${row.endDate||''}</td>
            <td class='p-3 text-center'>${row.leaveDays||''}</td>
            <td class='p-3 text-center'>${row.submitDate||''}</td>
            <td class='p-3 text-center'>${row.systemTime||''}</td>
            <td class='p-3 text-center'>${row.updatedAt||row.createdAt||''}</td>
            <td class='p-3 text-center'>
              <button class='text-blue-600 hover:text-blue-800 underline mr-2' data-action='edit' data-id='${row.id}'>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class='text-red-600 hover:text-red-800 underline' data-action='delete' data-id='${row.id}'>üóëÔ∏è ‡∏•‡∏ö</button>
            </td>`;
          leaveTable.appendChild(tr);
        });
      }

      // initial render
      renderTable();

      // --- Submit ---
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        // Vacation rule: submit at least 1 day before start
        if(leaveType.value === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô'){
          const start = new Date(startDate.value);
          const submit = new Date(submitDate.value);
          const diffDays = (start - submit)/(1000*60*60*24);
          if(diffDays < 1){
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô','error');
            return;
          }
        }
        const data = loadData();
        const row = {
          id: crypto.randomUUID(),
          empId: empId.value.trim(),
          empName: empName.value.trim(),
          department: department.value.trim(),
          leaveType: leaveType.value,
          startDate: startDate.value,
          endDate: endDate.value,
          leaveDays: leaveDays.value,
          reason: reason.value.trim(),
          approver: approver.value.trim(),
          submitDate: submitDate.value,
          systemTime: systemTimeEl.value,
          createdAt: new Date().toLocaleString('th-TH',{hour12:false}),
          updatedAt: new Date().toLocaleString('th-TH',{hour12:false})
        };
        data.unshift(row); saveData(data); renderTable(); form.reset(); calcDays(); updateSystemTime();
        showToast('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß','success');
      });

      // --- Edit / Delete actions (event delegation) ---
      document.addEventListener('click',(ev)=>{
        const btn = ev.target.closest('button'); if(!btn) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id'); if(!action || !id) return;
        const data = loadData(); const idx = data.findIndex(r=> r.id===id);
        if(idx<0) return;

        if(action==='edit'){
          // open modal with current values
          editStart.value = data[idx].startDate || '';
          editEnd.value = data[idx].endDate || '';
          // pre-calc
          if(editStart.value && editEnd.value){
            const s=new Date(editStart.value), e=new Date(editEnd.value);
            editDays.value = (isNaN(s)||isNaN(e)||e<s)? '' : (Math.floor((e-s)/(1000*60*60*24))+1)+ ' ‡∏ß‡∏±‡∏ô';
          }else{ editDays.value=''; }
          editModal.style.display='block';

          // live calc in modal
          const recalc=()=>{
            const s=new Date(editStart.value), e=new Date(editEnd.value);
            if(!isNaN(s)&&!isNaN(e)&&e>=s){ editDays.value = (Math.floor((e-s)/(1000*60*60*24))+1)+ ' ‡∏ß‡∏±‡∏ô'; }
            else{ editDays.value=''; }
          };
          editStart.onchange = recalc; editEnd.onchange = recalc;

          saveEdit.onclick = ()=>{
            if(!editStart.value || !editEnd.value){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error'); return; }
            const s=new Date(editStart.value), e=new Date(editEnd.value);
            if(e<s){ showToast('‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); return; }
            const days = Math.floor((e-s)/(1000*60*60*24))+1;
            data[idx].startDate = editStart.value;
            data[idx].endDate = editEnd.value;
            data[idx].leaveDays = days + ' ‡∏ß‡∏±‡∏ô';
            data[idx].updatedAt = new Date().toLocaleString('th-TH',{hour12:false});
            saveData(data); renderTable(); editModal.style.display='none'; showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
          };
          cancelEdit.onclick = ()=>{ editModal.style.display='none'; };
        }

        if(action==='delete'){
          // open password modal
          passwordModal.style.display='block'; hrPasswordInput.value='';
          confirmDelete.onclick = ()=>{
            if(hrPasswordInput.value !== HR_PASSWORD){ showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); return; }
            data.splice(idx,1); saveData(data); renderTable(); passwordModal.style.display='none'; showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
          };
          cancelDelete.onclick = ()=>{ passwordModal.style.display='none'; };
        }
      });

      // --- CSV Download ---
      function tableToCSV(){
        const rows = [['‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤','‡πÄ‡∏£‡∏¥‡πà‡∏°','‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤','‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á','‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î']];
        loadData().forEach(r=>{
          rows.push([r.empId||'', r.empName||'', r.leaveType||'', r.startDate||'', r.endDate||'', r.leaveDays||'', r.submitDate||'', r.systemTime||'', r.updatedAt||r.createdAt||'']);
        });
        return rows.map(cols=> cols.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      }
      downloadCSVBtn.addEventListener('click', ()=>{
        const csv = tableToCSV();
        const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'}); // BOM for Excel UTF-8
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'leave-requests.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    });
  </script>
</body>
</html>
