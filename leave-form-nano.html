<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast{position:fixed;bottom:20px;right:20px;color:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;z-index:50}
    .toast.success{background:#16a34a}.toast.error{background:#dc2626}.toast.show{opacity:1;transform:translateY(0)}
    .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:12px;max-width:540px;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    .btn{display:inline-flex;align-items:center;gap:.5rem}
    .badge{display:inline-flex;align-items:center;border-radius:9999px;font-size:.75rem;padding:.125rem .5rem}
    .badge.ok{background:#e6f7ef;color:#065f46;border:1px solid #34d399}
    .badge.fail{background:#fef2f2;color:#991b1b;border:1px solid #fca5a5}
    details.debug summary{cursor:pointer}
    .pill{font-size:.75rem;padding:.125rem .5rem;border-radius:9999px;border:1px solid #e5e7eb}
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
  <!-- HEADER + RULES -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <img src="https://i.postimg.cc/kMHv7FsP/loko-nano.png" alt="NANO Logo" class="h-10" onerror="this.style.display='none'">
      <div>
        <h1 class="text-xl font-bold text-gray-800">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h1>
        <p class="text-sm text-gray-500">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
      </div>
    </div>

<div class="bg-red-50 border border-red-200 text-red-800 p-3 rounded-lg mb-4 text-sm">
  <p class="font-semibold">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
  <ul class="list-disc ml-5">
    <li>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
    <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
    <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
    <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</li>
    <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á HR ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô ‡∏Å‡πá ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
  </ul>
</div>

    <!-- FORM -->
    <form id="leaveForm" class="space-y-4">
      <div>
        <label class="block text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="text" id="empId" class="w-full p-2 border rounded-lg" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="empName" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <input type="text" id="department" class="w-full p-2 border rounded-lg" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <select id="leaveType" class="w-full p-2 border rounded-lg" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
          <option>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
          <option>‡∏å‡∏≤‡∏õ‡∏ì‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
          <input type="date" id="startDate" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤</label>
          <input type="date" id="endDate" class="w-full p-2 border rounded-lg" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤</label>
        <input type="number" step="0.5" min="0.5" id="leaveDays" class="w-full p-2 border rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.5, 1, 1.5" required>
      </div>
      <div>
        <label class="block text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <textarea id="reason" rows="3" class="w-full p-2 border rounded-lg" required></textarea>
      </div>
      <div>
        <label class="block text-gray-700">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
        <input type="text" id="approver" class="w-full p-2 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</label>
          <input type="date" id="submitDate" class="w-full p-2 border rounded-lg" required readonly>
        </div>
        <div>
          <label class="block text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
          <input type="text" id="systemTime" readonly class="w-full p-2 border bg-gray-100 rounded-lg">
        </div>
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
    </form>
  </div>

  <!-- LIST + CSV -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-6xl p-6 mt-2">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
      <div class="flex items-center gap-2">
        <button id="downloadCSV" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm shadow">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV (‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ Excel)</button>
        
      </div>
      <h2 class="text-xl font-bold text-blue-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)</h2>
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
      <table class="w-full text-sm text-left text-gray-700">
        <thead class="bg-gradient-to-r from-blue-100 to-blue-50 border-b text-blue-900">
          <tr>
            <th class="p-3 text-center">‡∏£‡∏´‡∏±‡∏™</th>
            <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th class="p-3 text-center">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
            <th class="p-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
            <th class="p-3 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="leaveTable" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤</h3>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤:</label>
      <input type="date" id="editStart" class="w-full p-2 border rounded mb-2">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤:</label>
      <input type="date" id="editEnd" class="w-full p-2 border rounded mb-2">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 0.5):</label>
      <input type="number" step="0.5" min="0.5" id="editDays" class="w-full p-2 border rounded mb-2">
      <div class="flex justify-end gap-2 mt-3">
        <button id="saveEdit" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="cancelEdit" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD MODAL (DELETE) -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <input type="password" id="hrPasswordInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-2 border rounded mb-3">
      <div class="flex justify-end gap-2">
        <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded">‡∏•‡∏ö</button>
        <button id="cancelDelete" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast success">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ==== Firebase Config (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì) ====
    const firebaseConfig = {
      apiKey: "AIzaSyB9Gzqb2sgYdhg0G5_ivc_GemeQp0yUy8Y",
      authDomain: "leave-form-cd603.firebaseapp.com",
      projectId: "leave-form-cd603",
      storageBucket: "leave-form-cd603.firebasestorage.app",
      messagingSenderId: "180376619525",
      appId: "1:180376619525:web:8270c8a3a0ec5196e5ea6c",
      measurementId: "G-V9Z02K9LT6"
    };

    // === Global toast & error surfacing ===
    const toast = document.getElementById('toast');
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3500);
    }
    window.addEventListener('error', (e)=>{ showToast(`‚ö†Ô∏è JS Error: ${e.message}`, 'error'); });
    window.addEventListener('unhandledrejection', (e)=>{ showToast(`‚ö†Ô∏è Promise Error: ${e.reason?.message || e.reason}`, 'error'); });

    // === App Init ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const systemTimeEl = document.getElementById('systemTime');
    function updateSystemTime(){
      try{
        if(systemTimeEl){
          systemTimeEl.value = new Date().toLocaleString('th-TH',{hour12:false,timeZone:'Asia/Bangkok'});
        }
      }catch(e){}
    }
    updateSystemTime();
    setInterval(updateSystemTime, 1000);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) updateSystemTime(); });
    window.addEventListener('focus', updateSystemTime);

    function explainFirestoreError(err){
      const code = err?.code || '';
      const map = {
        'permission-denied': '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠ (Firestore Rules ‡∏ö‡∏•‡πá‡∏≠‡∏Å). ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏é‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó',
        'unauthenticated': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡∏ï‡∏£‡∏ß‡∏à Anonymous Sign-in ‡πÅ‡∏•‡∏∞ Authorized domains ‡πÉ‡∏ô Firebase Auth)',
        'failed-precondition': '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö',
        'unavailable': '‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ Firestore ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß',
        'not-found': '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏ö',
        'cancelled': '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        'invalid-argument': '‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        'resource-exhausted': '‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏î'
      };
      return map[code] || (err?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
    }

    // ===== Preflight & Drivers (Firestore ‚Üî Local fallback) =====
    const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const dbModePill = document.getElementById('dbModePill');

    // Local driver
    const LS_KEY = 'leave-requests:nano';
    function lsLoad(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
    function lsSave(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

    function makeLocalDriver(){
      let listeners = [];
      function notify(){ listeners.forEach(fn => fn(lsLoad())); }
      window.addEventListener('storage', (e)=>{ if(e.key===LS_KEY) notify(); });
      return {
        kind: 'local',
        subscribe(onData){ listeners.push(onData); onData(lsLoad()); return ()=>{ listeners = listeners.filter(f=>f!==onData); } },
        async create(payload){
          const data = lsLoad();
          const row = { id: crypto.randomUUID(), ...payload, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
          data.unshift(row); lsSave(data); notify(); return { id: row.id };
        },
        async update(id, payload){
          const data = lsLoad(); const i = data.findIndex(x=>x.id===id); if(i<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
          data[i] = { ...data[i], ...payload, updatedAt: new Date().toISOString() }; lsSave(data); notify();
        },
        async remove(id){ const data = lsLoad().filter(x=>x.id!==id); lsSave(data); notify(); }
      };
    }

    // Firestore driver
    function makeFirestoreDriver(){
      const colRef = collection(db, 'leave_requests');
      return {
        kind: 'firestore',
        subscribe(onData, onError){
          const q = query(colRef, orderBy('createdAt','desc'));
          const unsub = onSnapshot(q, snap => {
            onData(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          }, err => onError?.(err));
          return unsub;
        },
        async create(payload){ return addDoc(colRef, { ...payload, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); },
        async update(id, payload){ return updateDoc(doc(db, 'leave_requests', id), { ...payload, updatedAt: serverTimestamp() }); },
        async remove(id){ return deleteDoc(doc(db, 'leave_requests', id)); }
      };
    }

    let driver = null;   // active storage driver
    let unsubscribe = null;
    let cache = [];

    function setDBMode(mode){ /* UI pill hidden ‚Üí no-op */ }

    function attachSubscription(){
      if(unsubscribe) try{ unsubscribe(); }catch{}
      unsubscribe = driver.subscribe(rows => { cache = rows; renderTable(); }, (err)=>{
        console.error('@firebase/firestore subscribe', err);
        showToast('Firestore ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + explainFirestoreError(err), 'error');
        // auto fallback
        driver = makeLocalDriver();
        setDBMode('Local');
        attachSubscription();
        showToast('‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Local (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'error');
      });
    }

    function useLocal(reason){
      driver = makeLocalDriver();
      setDBMode('Local');
      attachSubscription();
      if(reason) showToast(reason, 'error');
    }

    // Try Firestore only on secure origins
    if(!isSecureOrigin){
      useLocal('‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô https ‡∏´‡∏£‡∏∑‡∏≠ localhost ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (file:// ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Firestore)');
    }else{
      // Auth ‚Üí then subscribe
      signInAnonymously(auth).then(()=>{
        driver = makeFirestoreDriver();
        setDBMode('Firestore');
        attachSubscription();
      }).catch((err)=>{
        console.error('signInAnonymously', err);
        useLocal('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Anonymous ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err));
      });
    }

    // ===== Utility =====
    function isWeekendOrHoliday(iso){
      if(!iso) return false;
      const d = new Date(iso + 'T00:00:00');
      const day = d.getDay(); // 0=‡∏≠‡∏≤, 6=‡πÄ‡∏™‡∏≤‡∏£‡πå
      return day === 0 || day === 6 || HOLIDAYS.has(iso);
    }

    const HOLIDAYS = new Set([ /* ‡πÄ‡∏ä‡πà‡∏ô '2025-12-05' ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô */ ]);

    function normalizeLeaveDays(val){
      const t = String(val ?? '').trim();
      if(!t) return '';
      return /‡∏ß‡∏±‡∏ô$/.test(t) ? t : (t + ' ‡∏ß‡∏±‡∏ô');
    }
    function fmtTS(ts){
      try{ if(ts?.toDate) return ts.toDate().toLocaleString('th-TH',{hour12:false}); }catch{}
      try{ return new Date(ts).toLocaleString('th-TH',{hour12:false}); }catch{}
      return '';
    }
    function todayISO(){
      const d = new Date();
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }

    // Elements
    const form = document.getElementById('leaveForm');
    const leaveTable = document.getElementById('leaveTable');
    const downloadCSVBtn = document.getElementById('downloadCSV');
    const runUnitTestsBtn = document.getElementById('runUnitTests');
    const runDBProbeBtn = document.getElementById('runDBProbe');
    const testResults = document.getElementById('testResults');

    const empId = document.getElementById('empId');
    const empName = document.getElementById('empName');
    const department = document.getElementById('department');
    const leaveType = document.getElementById('leaveType');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const leaveDays = document.getElementById('leaveDays');
    const reason = document.getElementById('reason');
    const approver = document.getElementById('approver');
    const submitDate = document.getElementById('submitDate');

    // === Autofill: ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å) ===
    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ~100 ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô": "‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
    const EMP_MAP = {
      "E001": "‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ",
      "E002": "‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á",
      "10010": "‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏°‡∏µ‡∏Å‡∏∏‡∏•",
      "10139": "‡∏Ç‡∏ß‡∏±‡∏ç‡πÉ‡∏à ‡∏ö‡∏∏‡∏ç‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á",
      "10141": "‡πÄ‡∏Å‡∏©‡∏£ ‡∏Å‡∏≠‡∏á‡∏ß‡∏á‡∏Ñ‡πå",
      "10180": "‡∏£‡∏∏‡πà‡∏á‡∏£‡∏∞‡∏ß‡∏µ ‡πÇ‡∏™‡∏°‡∏π‡∏•",
      "10349": "‡πÄ‡∏Å‡∏©‡∏°‡∏™‡∏∏‡∏Ç ‡πÄ‡∏ä‡∏¥‡∏î‡∏ä‡∏π",
      "10350": "‡∏£‡∏±‡∏ä‡∏ô‡∏µ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥",
      "10353": "‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏ô ‡πÅ‡∏™‡∏ô‡∏†‡∏π‡∏°‡∏¥",
      "10365": "‡∏™‡∏∏‡∏û‡∏±‡∏ï‡∏£‡∏≤ ‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ä‡∏≤‡∏ï‡∏¥",
      "10385": "‡∏û‡∏á‡∏®‡πå‡∏û‡∏±‡∏ô‡∏ò‡πå ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏≠‡∏á‡∏î‡∏µ",
      "10440": "‡∏ô‡∏¥‡∏†‡∏≤‡∏û‡∏£ ‡∏õ‡∏¥‡∏¢‡∏≤‡πÇ‡∏¢‡∏Ñ",
      "10442": "‡∏î‡∏≤‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏ß‡∏¥‡∏£‡∏∞‡∏®‡∏£‡∏µ",
      "10452": "‡∏≠‡∏£‡∏™‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏û‡∏¥‡∏°‡∏û‡πå",
      "10461": "‡∏Ç‡∏à‡∏£ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏°‡∏ô",
      "10470": "‡∏°‡∏á‡∏Ñ‡∏• ‡∏≠‡∏á‡∏≠‡∏≤‡∏à",
      "10499": "‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏ö‡∏±‡∏ß‡πÄ‡∏Ç‡πá‡∏°",
      "10506": "‡∏≠‡∏£‡∏∏‡∏ì‡∏µ ‡∏™‡∏≠‡∏ô‡∏ß‡∏á‡∏©‡πå",
      "10516": "‡∏™‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏î‡∏ä‡πÇ‡∏õ‡∏£‡∏î",
      "10518": "‡∏ò‡∏ß‡∏±‡∏ä ‡∏ó‡∏±‡∏ô‡πÉ‡∏à",
      "10520": "‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏£‡∏ì‡πå ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå",
      "10525": "‡∏ò‡∏¥‡∏ç‡∏≤‡∏î‡∏≤ ‡∏ä‡∏≤‡∏•‡∏µ‡∏ß‡∏±‡∏ô",
      "10526": "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á",
      "10527": "‡∏ä‡∏π‡∏û‡∏á‡∏®‡πå ‡∏ó‡∏≥‡∏î‡∏µ",      
      "10553": "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤",
      "10556": "‡∏™‡∏Å‡∏∏‡∏ì‡∏≤ ‡∏Å‡∏£‡∏£‡∏ì‡∏¥‡∏Å‡∏≤",
      "10564": "‡∏ß‡∏±‡∏ä‡∏£‡∏≤‡∏§‡∏ó‡∏ò‡∏¥‡πå ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤",
      "10565": "‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏ó‡∏≤‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå",
      "10583": "‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏≠‡∏£ ‡∏™‡∏≠‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå",
      "10606": "‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤ ‡∏î‡∏≥‡∏î‡∏µ",
      "10620": "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏î‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏¢‡∏≠",
      "10627": "‡∏ô‡∏û‡∏î‡∏• ‡∏ï‡∏µ‡πä‡∏ö‡∏ö‡∏∏‡∏ç‡∏®‡∏£‡∏µ",
      "10630": "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏™‡∏ô‡∏ó‡∏∞‡∏ß‡∏á‡∏Ñ‡πå",
      "10635": "‡∏£‡∏™‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏û‡∏á‡∏®‡πå",
      "10636": "‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï ‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏•‡πâ‡∏≥",
      "10637": "‡∏ï‡πâ‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏• ‡∏°‡∏∏‡∏á‡∏Ñ‡∏∏‡∏•‡∏Ñ‡∏≥‡∏ã‡∏≤‡∏ß",
      "10640": "‡∏®‡∏∏‡∏†‡∏Å‡∏£ ‡πÅ‡∏£‡∏á‡πÉ‡∏´‡∏°‡πà",
      "10641": "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏î‡∏≤ ‡∏û‡∏¥‡πÑ‡∏ä‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡∏à‡∏¥‡∏ô‡∏î‡∏≤",
      "10642": "‡∏ß‡∏¥‡∏™‡∏∏‡∏î‡∏≤ ‡∏û‡∏¥‡πÑ‡∏ä‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡∏à‡∏¥‡∏ô‡∏î‡∏≤",
      "10648": "‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏≤ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°",
      "10660": "‡∏à‡∏¥‡∏£‡∏†‡∏¥‡∏ç‡∏ç‡∏≤ ‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏Ü",
      "10661": "‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏£‡∏ì ‡∏™‡∏ô‡πÉ‡∏à",
      "10669": "‡πÇ‡∏Å‡∏ß‡∏¥‡∏ó ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏†‡∏≤",
      "10670": "‡∏≠‡∏±‡∏Ñ‡∏£‡∏û‡∏±‡∏ä‡∏£‡πå ‡∏Å‡∏£‡∏á‡πÄ‡∏ï‡πâ‡∏ô",
      "12453": "‡∏à‡∏≤‡∏£‡∏∏‡∏ì‡∏µ ‡∏Ñ‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏°",
      "30070": "NAW TIN TIN HTWE TIN HTWE @ THUY",
      "30072": "MYOLATT",
      "30078": "NGWE HTIKE",
      "30079": "EI EI THET",
      "30087": "MYO THET",
      "30113": "THIN THIN AUNG",
      "30115": "AUNG TIN MYINT",
      "30117": "KHIN CHO OO",
      "30149": "ZAW ZAW AUNG",
      "30171": "MIN ZAW MIN",
      "30221": "TUN AUNG SHEIN",
      "30249": "KHAING THA ZIN PHYO",
      "30251": "KO KO KU KU",
      "30257": "TOE NAING",
      "30265": "HNIN THET",
      "30268": "KYAT PHA",
      "30269": "NINE NINE @ HNIN HNIN",
      "30270": "KHON THEIN SAUNG",
      "30292": "SAI MAUNG MAUNG",
      "30294": "THUZAR",
      "30313": "AUNG TUN OO",
      "30315": "KYAW LIN",
      "30318": "SAW AHL HTO",
      "30328": "THEINGI WIN",
      "30329": "THI THI KHINE",
      "30333": "YE LIN TUN",
      "30334": "PHYU PHYU THEIN",
      "30335": "YE LIN HTIKE",
      "30336": "AYE PWINT PHYU",
      "30337": "AYE THANDAR ZAW",
      "30338": "CHIT HTWE",
      "30340": "SHAN MA LAY",
      "30341": "NAING PHYO KYAW",
      "30342": "NAW SAN THIDA NYEIN",
      "30348": "PHYO MIN WAI",
      "30349": "SOE MOE KYAW",
      "30350": "YE ZAW",
      "30351": "TIN MYO KO",
      "30352": "NWAY JUNG ZIN LATT",
      "30353": "SAI KYAW KYAW",
      "30354": "KYAW THURA SOE",
      "30362": "EA LA SOE",
      "30366": "‡∏ô‡∏¥ ‡∏ä‡∏≤‡∏¢",
      "30367": "‡∏Ñ‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô",
      "30368": "‡∏Å‡∏≠‡∏á‡∏õ‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏ß"
    };
    function normalizeEmpId(raw){ return String(raw||'').trim(); }
    function autofillNameFromEmpId(rawId){
      const id = normalizeEmpId(rawId);
      const name = id && EMP_MAP[id];
      if(name){
        // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á)
        empName.value = name;
      }
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‚Üí ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
    }
    let empIdTimer;
    empId.addEventListener('input', ()=>{
      clearTimeout(empIdTimer);
      empIdTimer = setTimeout(()=>autofillNameFromEmpId(empId.value), 250);
    });
    empId.addEventListener('blur', ()=>autofillNameFromEmpId(empId.value));

    // ‡∏û‡∏£‡∏µ‡∏ü‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å
    submitDate.value = todayISO();
    submitDate.setAttribute('readonly','readonly');
    submitDate.addEventListener('keydown', e => e.preventDefault());
    submitDate.addEventListener('click', e => e.preventDefault());

    const HR_PASSWORD = '303647';

    // ===== Validation (pure function) =====
    function validateRow(values){
      const errors = [];
      const warnings = [];
      const v = { ...values };

      // Required
      const required = ['empId','empName','department','leaveType','startDate','endDate','leaveDays','reason','approver','submitDate'];
      required.forEach(k=>{ if(!String(v[k] ?? '').trim()) errors.push(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ${k}`); });

      // Date order
      const s = new Date(v.startDate + 'T00:00:00');
      const e = new Date(v.endDate + 'T00:00:00');
      if(isNaN(s) || isNaN(e)) errors.push('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      else if(e < s) errors.push('‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°)');

      // Weekend/Holiday submit
      if(isWeekendOrHoliday(v.submitDate)) errors.push('‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î');

      // Vacation rule: convert if retroactive/same-day
      if(v.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && !isNaN(s)){
        const sub = new Date(v.submitDate + 'T00:00:00');
        const diffDays = (s - sub)/86400000;
        if(diffDays < 1){
          v.leaveType = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
          warnings.push('‡∏™‡πà‡∏á‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á/‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡∏≤‡∏Å‡∏¥‡∏à"');
        }
      }

      // Days min 0.5
      const daysNum = parseFloat(String(v.leaveDays).replace(' ‡∏ß‡∏±‡∏ô',''));
      if(isNaN(daysNum) || daysNum < 0.5) errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 0.5 ‡∏ß‡∏±‡∏ô');
      v.leaveDays = normalizeLeaveDays(daysNum);

      return { ok: errors.length === 0, errors, warnings, value: v };
    }

    // ===== Render =====
    function renderTable(){
      leaveTable.innerHTML = '';
      cache.forEach(row => {
        const tr = document.createElement('tr');

        const tdEmpId = document.createElement('td'); tdEmpId.className='p-3 text-center'; tdEmpId.textContent = row.empId || '-';
        const tdName = document.createElement('td'); tdName.className='p-3'; tdName.textContent = row.empName || '';
        const tdType = document.createElement('td'); tdType.className='p-3'; tdType.textContent = row.leaveType || '';
        const tdStart = document.createElement('td'); tdStart.className='p-3 text-center'; tdStart.textContent = row.startDate || '';
        const tdEnd = document.createElement('td'); tdEnd.className='p-3 text-center'; tdEnd.textContent = row.endDate || '';
        const tdDays = document.createElement('td'); tdDays.className='p-3 text-center'; tdDays.textContent = row.leaveDays || '';
        const tdSubmit = document.createElement('td'); tdSubmit.className='p-3 text-center'; tdSubmit.textContent = row.submitDate || '';
        const tdSys = document.createElement('td'); tdSys.className='p-3 text-center'; tdSys.textContent = row.systemTime || '';
        const tdUpd = document.createElement('td'); tdUpd.className='p-3 text-center'; tdUpd.textContent = row.updatedAt ? fmtTS(row.updatedAt) : (row.createdAt ? fmtTS(row.createdAt) : '');

        const tdActions = document.createElement('td'); tdActions.className='p-3 text-center';
        const btnEdit = document.createElement('button'); btnEdit.className='text-blue-600 hover:text-blue-800 underline mr-2'; btnEdit.textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; btnEdit.dataset.action='edit'; btnEdit.dataset.id=row.id;
        const btnDel = document.createElement('button'); btnDel.className='text-red-600 hover:text-red-800 underline'; btnDel.textContent='üóëÔ∏è ‡∏•‡∏ö'; btnDel.dataset.action='delete'; btnDel.dataset.id=row.id;
        tdActions.appendChild(btnEdit); tdActions.appendChild(btnDel);

        tr.appendChild(tdEmpId); tr.appendChild(tdName); tr.appendChild(tdType);
        tr.appendChild(tdStart); tr.appendChild(tdEnd); tr.appendChild(tdDays);
        tr.appendChild(tdSubmit); tr.appendChild(tdSys); tr.appendChild(tdUpd);
        tr.appendChild(tdActions);

        leaveTable.appendChild(tr);
      });
    }

    // ===== Start subscription (set by driver) =====
    // attachSubscription() is called during driver selection above

    // ===== Submit handler (create) =====
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const row = {
        empId: empId.value.trim(),
        empName: empName.value.trim(),
        department: department.value.trim(),
        leaveType: leaveType.value,
        startDate: startDate.value,
        endDate: endDate.value,
        leaveDays: leaveDays.value,
        reason: reason.value.trim(),
        approver: approver.value.trim(),
        submitDate: submitDate.value,
        systemTime: systemTimeEl.value
      };

      const { ok, errors, warnings, value } = validateRow(row);
      if(!ok){ showToast('‚ùå ' + errors.join(' | '), 'error'); return; }
      if(warnings.length){ showToast('‚ö†Ô∏è ' + warnings.join(' | '), 'error'); }

      try{
        await driver.create(value);
        form.reset();
        submitDate.value = todayISO();
        showToast('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß','success');
      }catch(err){
        console.error('create()', err);
        const msg = explainFirestoreError(err);
        showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg, 'error');
        // auto fallback
        if(driver.kind==='firestore'){
          useLocal('‡∏™‡∏•‡∏±‡∏ö Local ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + msg);
        }
      }
    });

    // ===== Edit / Delete (delegation) =====
    const editModal = document.getElementById('editModal');
    const editStart = document.getElementById('editStart');
    const editEnd = document.getElementById('editEnd');
    const editDays = document.getElementById('editDays');
    const saveEdit = document.getElementById('saveEdit');
    const cancelEdit = document.getElementById('cancelEdit');

    const passwordModal = document.getElementById('passwordModal');
    const hrPasswordInput = document.getElementById('hrPasswordInput');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');

    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id'); if(!action || !id) return;
      const idx = cache.findIndex(r=> r.id===id);
      if(idx<0) return;

      if(action==='edit'){
        editStart.value = cache[idx].startDate || '';
        editEnd.value = cache[idx].endDate || '';
        const currentDays = String(cache[idx].leaveDays || '').replace(' ‡∏ß‡∏±‡∏ô','');
        editDays.value = currentDays || 1;
        editModal.style.display='block';

        saveEdit.onclick = async ()=>{
          const upd = { startDate: editStart.value, endDate: editEnd.value, leaveDays: editDays.value, submitDate: cache[idx].submitDate };
          const { ok, errors, warnings, value } = validateRow({ ...cache[idx], ...upd });
          if(!ok){ showToast('‚ùå ' + errors.join(' | '), 'error'); return; }
          if(warnings.length){ showToast('‚ö†Ô∏è ' + warnings.join(' | '), 'error'); }
          try{
            await driver.update(id, value);
            editModal.style.display='none'; showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
          }catch(err){
            console.error('update()', err);
            const msg = explainFirestoreError(err);
            showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg, 'error');
            if(driver.kind==='firestore'){
              useLocal('‡∏™‡∏•‡∏±‡∏ö Local ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + msg);
            }
          }
        };
        cancelEdit.onclick = ()=>{ editModal.style.display='none'; };
      }

      if(action==='delete'){
        passwordModal.style.display='block'; hrPasswordInput.value='';
        confirmDelete.onclick = async ()=>{
          if(hrPasswordInput.value !== HR_PASSWORD){ showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); return; }
          try{
            await driver.remove(id);
            passwordModal.style.display='none'; showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
          }catch(err){
            console.error('remove()', err);
            const msg = explainFirestoreError(err);
            showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg, 'error');
            if(driver.kind==='firestore'){
              useLocal('‡∏™‡∏•‡∏±‡∏ö Local ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏•‡∏ö Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + msg);
            }
          }
        };
        cancelDelete.onclick = ()=>{ passwordModal.style.display='none'; };
      }
    });

    // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å
    ;[editModal, passwordModal].forEach(m => { m.addEventListener('click', e => { if (e.target === m) m.style.display = 'none'; }); });

    // ===== CSV export ‡∏à‡∏≤‡∏Å cache =====
    function csvEscape(value){ const s = String(value ?? '').replace(/"/g,'""'); return '"' + s + '"'; }
    function tableToCSV(){
      const rows = [[ '‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤','‡πÄ‡∏£‡∏¥‡πà‡∏°','‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤','‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á','‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' ]];
      cache.forEach(r=>{ rows.push([ r.empId||'', r.empName||'', r.leaveType||'', r.startDate||'', r.endDate||'', r.leaveDays||'', r.submitDate||'', r.systemTime||'', r.updatedAt?fmtTS(r.updatedAt):(r.createdAt?fmtTS(r.createdAt):'') ]); });
      return rows.map(cols => cols.map(csvEscape).join(',')).join('\n');
    }
    downloadCSVBtn.addEventListener('click', ()=>{
      const csv = tableToCSV();
      const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'leave-requests.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ===== Unit Tests (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ Firestore) =====
    function badge(ok){ return `<span class="badge ${ok?'ok':'fail'}">${ok?'PASS':'FAIL'}</span>`; }
    function nextSaturdayISO(){ const d = new Date(); const delta = (6 - d.getDay() + 7) % 7 || 7; const n = new Date(d.getFullYear(), d.getMonth(), d.getDate() + delta); const tz = n.getTimezoneOffset() * 60000; return new Date(n - tz).toISOString().slice(0,10); }
    function runUnitTests(){
      const cases = [];
      const base = { empId:'E001', empName:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', department:'‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï', leaveType:'‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô', startDate:'2025-11-10', endDate:'2025-11-10', leaveDays:'1', reason:'‡∏ò‡∏∏‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', approver:'‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠', submitDate: todayISO(), systemTime: new Date().toLocaleString('th-TH',{hour12:false}) };
      // ‡πÄ‡∏î‡∏¥‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏Å‡πâ)
      cases.push({ name:'Required fields validation', input:{...base, empId:''}, expectOk:false });
      cases.push({ name:'Date order invalid', input:{...base, startDate:'2025-11-12', endDate:'2025-11-10'}, expectOk:false });
      cases.push({ name:'Vacation retroactive -> convert to business leave', input:{...base, submitDate:'2025-11-10'}, expectOk:true, expectType:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à' });
      cases.push({ name:'Min days 0.5', input:{...base, leaveDays:'0.25'}, expectOk:false });
      cases.push({ name:'Valid input', input:{...base, startDate:'2025-11-12', endDate:'2025-11-13', leaveDays:'2', submitDate:'2025-11-10'}, expectOk:true, expectType:'‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' });
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
      cases.push({ name:'Exactly 0.5 day allowed', input:{...base, leaveDays:'0.5', submitOk:true }, expectOk:true });
      cases.push({ name:'Decimal days normalize 1.5 ‡∏ß‡∏±‡∏ô', input:{...base, leaveDays:'1.5 ‡∏ß‡∏±‡∏ô', submitDate:'2025-11-10'}, expectOk:true, expectDays:'1.5 ‡∏ß‡∏±‡∏ô' });
      cases.push({ name:'Same start=end OK', input:{...base, startDate:'2025-11-10', endDate:'2025-11-10', submitDate:'2025-11-08'}, expectOk:true });
      cases.push({ name:'Weekend submit should fail', input:{...base, submitDate: nextSaturdayISO()}, expectOk:false });
      cases.push({ name:'Approver required', input:{...base, approver:''}, expectOk:false });
      cases.push({ name:'Trim days with spaces', input:{...base, leaveDays:' 1.0  '}, expectOk:true, expectDays:'1 ‡∏ß‡∏±‡∏ô' });

      let html = '';
      cases.forEach(cs=>{
        const r = validateRow(cs.input);
        let ok = r.ok === cs.expectOk && (!cs.expectType || r.value.leaveType === cs.expectType);
        if(ok && cs.expectDays){ ok = r.value.leaveDays === cs.expectDays; }
        html += `<div class="flex items-center gap-2"><div>${badge(ok)}</div><div>${cs.name}</div>`;
        if(!ok){ html += `<div class=\"text-red-700\">‚Üí got ok=${r.ok}, type=${r.value.leaveType}, days=${r.value.leaveDays} errors=[${r.errors.join('; ')}]</div>`; }
        html += `</div>`;
      });
      testResults.innerHTML = html;
    }
    runUnitTestsBtn?.addEventListener('click', runUnitTests);

    // ===== Live DB probe (‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î DB) =====
    runDBProbeBtn?.addEventListener('click', async ()=>{
      try{
        const payload = { empId:'TEST', empName:'PROBE', department:'QA', leaveType:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à', startDate: todayISO(), endDate: todayISO(), leaveDays: '0.5 ‡∏ß‡∏±‡∏ô', reason:'probe', approver:'tester', submitDate: todayISO(), systemTime: new Date().toLocaleString('th-TH',{hour12:false}) };
        const { ok, value } = validateRow(payload);
        if(!ok) throw new Error('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô validation');
        if(driver.kind==='firestore'){
          const { id } = await driver.create(value); await driver.remove(id);
          testResults.innerHTML = `<div class=\"flex items-center gap-2\">${badge(true)}<div>DB probe (Firestore) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>`;
        }else{
          const { id } = await driver.create(value); await driver.remove(id);
          testResults.innerHTML = `<div class=\"flex items-center gap-2\">${badge(true)}<div>DB probe (Local) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>`;
        }
      }catch(err){
        console.error('DB probe error', err);
        testResults.innerHTML = `<div class=\"flex items-center gap-2\">${badge(false)}<div>DB probe ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${explainFirestoreError(err)}</div></div>`;
      }
    });
  </script>
</body>
</html>
