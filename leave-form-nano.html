<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤ 2026 - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast{position:fixed;bottom:20px;right:20px;color:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;z-index:50}
    .toast.success{background:#16a34a}.toast.error{background:#dc2626}.toast.show{opacity:1;transform:translateY(0)}
    .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:12px;max-width:540px;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    .btn{display:inline-flex;align-items:center;gap:.5rem}
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
  <!-- HEADER + RULES -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <img src="https://i.postimg.cc/kMHv7FsP/loko-nano.png" alt="NANO Logo" class="h-10" onerror="this.style.display='none'">
      <div>
        <h1 class="text-xl font-bold text-gray-800">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h1>
        <p class="text-sm text-gray-500">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
      </div>
    </div>

    <div class="bg-red-50 border border-red-200 text-red-800 p-3 rounded-lg mb-4 text-sm">
      <p class="font-semibold">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
      <ul class="list-disc ml-5">
        <li>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
        <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
        <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
        <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)</li>
        <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á HR ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô ‡∏Å‡πá ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
      </ul>
    </div>

    <!-- FORM -->
    <form id="leaveForm" class="space-y-4">
      <div>
        <label class="block text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="text" id="empId" class="w-full p-2 border rounded-lg" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="empName" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <input type="text" id="department" class="w-full p-2 border rounded-lg" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <select id="leaveType" class="w-full p-2 border rounded-lg" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
          <option>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î</option>
          <option>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
          <option>‡∏å‡∏≤‡∏õ‡∏ì‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
          <input type="date" id="startDate" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤</label>
          <input type="date" id="endDate" class="w-full p-2 border rounded-lg" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤</label>
        <input type="number" step="0.5" min="0.5" id="leaveDays" class="w-full p-2 border rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.5, 1, 1.5" required>
      </div>
      <div>
        <label class="block text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <textarea id="reason" rows="3" class="w-full p-2 border rounded-lg" required></textarea>
      </div>
      <div>
        <label class="block text-gray-700">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
        <input type="text" id="approver" class="w-full p-2 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</label>
          <input type="date" id="submitDate" class="w-full p-2 border rounded-lg" required readonly>
        </div>
        <div>
          <label class="block text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
          <input type="text" id="systemTime" readonly class="w-full p-2 border bg-gray-100 rounded-lg">
        </div>
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
    </form>
  </div>

  <!-- LIST + CSV -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-6xl p-6 mt-2">
    <div class="flex justify-between items-center mb-4">
      <button id="downloadCSV" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm shadow">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV (‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ Excel)</button>
      <h2 class="text-xl font-bold text-blue-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)</h2>
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
      <table class="w-full text-sm text-left text-gray-700">
        <thead class="bg-gradient-to-r from-blue-100 to-blue-50 border-b text-blue-900">
          <tr>
            <th class="p-3 text-center">‡∏£‡∏´‡∏±‡∏™</th>
            <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th class="p-3 text-center">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
            <th class="p-3 text-center">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
            <th class="p-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
            <th class="p-3 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="leaveTable" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤</h3>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤:</label>
      <input type="date" id="editStart" class="w-full p-2 border rounded mb-2">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤:</label>
      <input type="date" id="editEnd" class="w-full p-2 border rounded mb-2">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 0.5):</label>
      <input type="number" step="0.5" min="0.5" id="editDays" class="w-full p-2 border rounded mb-2">
      <div class="flex justify-end gap-2 mt-3">
        <button id="saveEdit" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="cancelEdit" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD MODAL (DELETE) -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <input type="password" id="hrPasswordInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-2 border rounded mb-3">
      <div class="flex justify-end gap-2">
        <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded">‡∏•‡∏ö</button>
        <button id="cancelDelete" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast success">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ==== Firebase Config ====
    const firebaseConfig = {
      apiKey: "AIzaSyB9Gzqb2sgYdhg0G5_ivc_GemeQp0yUy8Y",
      authDomain: "leave-form-cd603.firebaseapp.com",
      projectId: "leave-form-cd603",
      storageBucket: "leave-form-cd603.firebasestorage.app",
      messagingSenderId: "180376619525",
      appId: "1:180376619525:web:8270c8a3a0ec5196e5ea6c",
      measurementId: "G-V9Z02K9LT6"
    };

    // === Toast ===
    const toast = document.getElementById('toast');
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3500);
    }
    window.addEventListener('error', (e)=>{ showToast(`‚ö†Ô∏è JS Error: ${e.message}`, 'error'); });
    window.addEventListener('unhandledrejection', (e)=>{ showToast(`‚ö†Ô∏è Promise Error: ${e.reason?.message || e.reason}`, 'error'); });

    // === App Init ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const systemTimeEl = document.getElementById('systemTime');
    function updateSystemTime(){
      try{
        if(systemTimeEl){
          systemTimeEl.value = new Date().toLocaleString('th-TH',{hour12:false,timeZone:'Asia/Bangkok'});
        }
      }catch(e){}
    }
    updateSystemTime();
    setInterval(updateSystemTime, 1000);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) updateSystemTime(); });
    window.addEventListener('focus', updateSystemTime);

    function todayISO(){
      const d = new Date();
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }

    // DD/MM/YYYY display for table cells
    function fmtDateDMY(iso){
      if(!iso) return '';
      const s = String(iso);
      const base = s.length >= 10 ? s.slice(0,10) : s;
      const parts = base.split('-');
      if(parts.length === 3){
        const [y,m,d] = parts;
        return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
      }
      return iso;
    }

    // Elements
    const form = document.getElementById('leaveForm');
    const leaveTable = document.getElementById('leaveTable');
    const downloadCSVBtn = document.getElementById('downloadCSV');

    const empId = document.getElementById('empId');
    const empName = document.getElementById('empName');
    const department = document.getElementById('department');
    const leaveType = document.getElementById('leaveType');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const leaveDays = document.getElementById('leaveDays');
    const reason = document.getElementById('reason');
    const approver = document.getElementById('approver');
    const submitDate = document.getElementById('submitDate');

    submitDate.value = todayISO();
    submitDate.setAttribute('readonly','readonly');
    submitDate.addEventListener('keydown', e => e.preventDefault());
    submitDate.addEventListener('click', e => e.preventDefault());

    const HR_PASSWORD = '303647';

    // ===== Employee map: ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô "‡∏ä‡∏∑‡πà‡∏≠ + ‡πÅ‡∏ú‡∏ô‡∏Å" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ =====
    const EMP_MAP = {
      "10010": { name: "‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏°‡∏µ‡∏Å‡∏∏‡∏•", dept: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
      "10139": { name: "‡∏Ç‡∏ß‡∏±‡∏ç‡πÉ‡∏à ‡∏ö‡∏∏‡∏ç‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á", dept: "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" },
      "10141": { name: "‡πÄ‡∏Å‡∏©‡∏£ ‡∏Å‡∏≠‡∏á‡∏ß‡∏á‡∏Ñ‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10180": { name: "‡∏£‡∏∏‡πà‡∏á‡∏£‡∏∞‡∏ß‡∏µ ‡πÇ‡∏™‡∏°‡∏π‡∏•", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10349": { name: "‡πÄ‡∏Å‡∏©‡∏°‡∏™‡∏∏‡∏Ç ‡πÄ‡∏ä‡∏¥‡∏î‡∏ä‡∏π", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10350": { name: "‡∏£‡∏±‡∏ä‡∏ô‡∏µ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "10353": { name: "‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏ô ‡πÅ‡∏™‡∏ô‡∏†‡∏π‡∏°‡∏¥", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10365": { name: "‡∏™‡∏∏‡∏û‡∏±‡∏ï‡∏£‡∏≤ ‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ä‡∏≤‡∏ï‡∏¥", dept: "‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î" },
      "10385": { name: "‡∏û‡∏á‡∏®‡πå‡∏û‡∏±‡∏ô‡∏ò‡πå ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏≠‡∏á‡∏î‡∏µ", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10440": { name: "‡∏ô‡∏¥‡∏†‡∏≤‡∏û‡∏£ ‡∏õ‡∏¥‡∏¢‡∏≤‡πÇ‡∏¢‡∏Ñ", dept: "‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠" },
      "10442": { name: "‡∏î‡∏≤‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏ß‡∏¥‡∏£‡∏∞‡∏®‡∏£‡∏µ", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "10452": { name: "‡∏≠‡∏£‡∏™‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏û‡∏¥‡∏°‡∏û‡πå", dept: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10461": { name: "‡∏Ç‡∏à‡∏£ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏°‡∏ô", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10470": { name: "‡∏°‡∏á‡∏Ñ‡∏• ‡∏≠‡∏á‡∏≠‡∏≤‡∏à", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10499": { name: "‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏ö‡∏±‡∏ß‡πÄ‡∏Ç‡πá‡∏°", dept: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" },
      "10506": { name: "‡∏≠‡∏£‡∏∏‡∏ì‡∏µ ‡∏™‡∏≠‡∏ô‡∏ß‡∏á‡∏©‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï3" },
      "10516": { name: "‡∏™‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏î‡∏ä‡πÇ‡∏õ‡∏£‡∏î", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10518": { name: "‡∏ò‡∏ß‡∏±‡∏ä ‡∏ó‡∏±‡∏ô‡πÉ‡∏à", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10520": { name: "‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏£‡∏ì‡πå ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10525": { name: "‡∏ò‡∏¥‡∏ç‡∏≤‡∏î‡∏≤ ‡∏ä‡∏≤‡∏•‡∏µ‡∏ß‡∏±‡∏ô", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10526": { name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10527": { name: "‡∏ä‡∏π‡∏û‡∏á‡∏®‡πå ‡∏ó‡∏≥‡∏î‡∏µ", dept: "‡∏ô‡∏¥‡∏ß‡πÇ‡∏°‡πÄ‡∏î‡∏•" },
      "10553": { name: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10556": { name: "‡∏™‡∏Å‡∏∏‡∏ì‡∏≤ ‡∏Å‡∏£‡∏£‡∏ì‡∏¥‡∏Å‡∏≤", dept: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
      "10564": { name: "‡∏ß‡∏±‡∏ä‡∏£‡∏≤‡∏§‡∏ó‡∏ò‡∏¥‡πå ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10565": { name: "‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏ó‡∏≤‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10583": { name: "‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏≠‡∏£ ‡∏™‡∏≠‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10606": { name: "‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤ ‡∏î‡∏≥‡∏î‡∏µ", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10620": { name: "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏î‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏¢‡∏≠", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10627": { name: "‡∏ô‡∏û‡∏î‡∏• ‡∏ï‡∏µ‡πä‡∏ö‡∏ö‡∏∏‡∏ç‡∏®‡∏£‡∏µ", dept: "‡∏ú‡∏•‡∏¥‡∏ï3" },
      "10630": { name: "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏™‡∏ô‡∏ó‡∏∞‡∏ß‡∏á‡∏Ñ‡πå", dept: "‡∏ô‡∏¥‡∏ß‡πÇ‡∏°‡πÄ‡∏î‡∏•" },
      "10635": { name: "‡∏£‡∏™‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏û‡∏á‡∏®‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "10636": { name: "‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï ‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏•‡πâ‡∏≥", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10637": { name: "‡∏ï‡πâ‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏• ‡∏°‡∏∏‡∏á‡∏Ñ‡∏∏‡∏•‡∏Ñ‡∏≥‡∏ã‡∏≤‡∏ß", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10640": { name: "‡∏®‡∏∏‡∏†‡∏Å‡∏£ ‡πÅ‡∏£‡∏á‡πÉ‡∏´‡∏°‡πà", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10641": { name: "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏î‡∏≤ ‡∏û‡∏¥‡πÑ‡∏ä‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡∏à‡∏¥‡∏ô‡∏î‡∏≤", dept: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï" },
      "10642": { name: "‡∏ß‡∏¥‡∏™‡∏∏‡∏î‡∏≤ ‡∏û‡∏¥‡πÑ‡∏ä‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡∏à‡∏¥‡∏ô‡∏î‡∏≤", dept: "‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠" },
      "10648": { name: "‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏≤ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10660": { name: "‡∏à‡∏¥‡∏£‡∏†‡∏¥‡∏ç‡∏ç‡∏≤ ‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏Ü", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10661": { name: "‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏£‡∏ì ‡∏™‡∏ô‡πÉ‡∏à", dept: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï" },
      "10669": { name: "‡πÇ‡∏Å‡∏ß‡∏¥‡∏ó ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏†‡∏≤", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10670": { name: "‡∏≠‡∏±‡∏Ñ‡∏£‡∏û‡∏±‡∏ä‡∏£‡πå ‡∏Å‡∏£‡∏á‡πÄ‡∏ï‡πâ‡∏ô", dept: "‡∏°‡∏¥‡∏•‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢" },
      "12453": { name: "‡∏à‡∏≤‡∏£‡∏∏‡∏ì‡∏µ ‡∏Ñ‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏°", dept: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" },
      "30070": { name: "NAW TIN TIN HTWE TIN HTWE @ THUY", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "30072": { name: "MYOLATT", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30078": { name: "NGWE HTIKE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30079": { name: "EI EI THET", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30087": { name: "MYO THET", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30113": { name: "THIN THIN AUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30115": { name: "AUNG TIN MYINT", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30117": { name: "KHIN CHO OO", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30149": { name: "ZAW ZAW AUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30171": { name: "MIN ZAW MIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30221": { name: "TUN AUNG SHEIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30249": { name: "KHAING THA ZIN PHYO", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30251": { name: "KO KO KU KU", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30257": { name: "TOE NAING", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30265": { name: "HNIN THET", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30268": { name: "KYAT PHA", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30269": { name: "NINE NINE @ HNIN HNIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30270": { name: "KHON THEIN SAUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30292": { name: "SAI MAUNG MAUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30294": { name: "THUZAR", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30313": { name: "AUNG TUN OO", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30315": { name: "KYAW LIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï3" },
      "30318": { name: "SAW AHL HTO", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30328": { name: "THEINGI WIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30329": { name: "THI THI KHINE", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30333": { name: "YE LIN TUN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30334": { name: "PHYU PHYU THEIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30335": { name: "YE LIN HTIKE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30336": { name: "AYE PWINT PHYU", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30337": { name: "AYE THANDAR ZAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30338": { name: "CHIT HTWE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30340": { name: "SHAN MA LAY", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30341": { name: "NAING PHYO KYAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30342": { name: "NAW SAN THIDA NYEIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30348": { name: "PHYO MIN WAI", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30349": { name: "SOE MOE KYAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30350": { name: "YE ZAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30351": { name: "TIN MYO KO", dept: "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" },
      "30352": { name: "NWAY JUNG ZIN LATT", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30353": { name: "SAI KYAW KYAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30354": { name: "KYAW THURA SOE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30362": { name: "EA LA SOE", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30366": { name: "‡∏ô‡∏¥ ‡∏ä‡∏≤‡∏¢", dept: "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ" },
      "30367": { name: "‡∏Ñ‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30368": { name: "‡∏Å‡∏≠‡∏á‡∏õ‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏ß", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" }
    };

    function normalizeEmpId(raw){ return String(raw||'').trim(); }
    function autofillNameFromEmpId(rawId){
      const id = normalizeEmpId(rawId);
      const info = id && EMP_MAP[id];
      if(info){
        empName.value = info.name;
        department.value = info.dept || "";
      }
    }

    let empIdTimer;
    empId.addEventListener('input', ()=>{
      clearTimeout(empIdTimer);
      empIdTimer = setTimeout(()=>autofillNameFromEmpId(empId.value), 250);
    });
    empId.addEventListener('blur', ()=>autofillNameFromEmpId(empId.value));

  // ===== Validation =====
// ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏≤‡πÑ‡∏î‡πâ: ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡πÄ‡∏™‡∏≤‡∏£‡πå ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå
// ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå

const HOLIDAYS = new Set([
  // ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤)
  // '2026-01-01',
]);

function isDisallowedSubmitDate(iso){
  if(!iso) return false;
  const d = new Date(iso + 'T00:00:00');
  return d.getDay() === 0; // 0 = ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
}

function normalizeLeaveDays(val){
  const t = String(val ?? '').trim();
  if(!t) return '';
  return /‡∏ß‡∏±‡∏ô$/.test(t) ? t : (t + ' ‡∏ß‡∏±‡∏ô');
}

function validateRow(values){
  const errors = [];
  const warnings = [];
  const v = { ...values };

  const required = [
    'empId','empName','department','leaveType',
    'startDate','endDate','leaveDays',
    'reason','approver','submitDate'
  ];
  required.forEach(k=>{
    if(!String(v[k] ?? '').trim())
      errors.push(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ${k}`);
  });

  const s = new Date(v.startDate + 'T00:00:00');
  const e = new Date(v.endDate + 'T00:00:00');
  if(isNaN(s) || isNaN(e))
    errors.push('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  else if(e < s)
    errors.push('‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°)');

  // ‚ùó ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
  if(isDisallowedSubmitDate(v.submitDate))
    errors.push('‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå');

  // ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô
  if(v.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && !isNaN(s)){
    const sub = new Date(v.submitDate + 'T00:00:00');
    const diffDays = (s - sub) / 86400000;
    if(diffDays < 1){
      v.leaveType = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
      warnings.push(
        '‡∏™‡πà‡∏á‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á/‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡∏≤‡∏Å‡∏¥‡∏à"'
      );
    }
  }

  const daysNum = parseFloat(
    String(v.leaveDays).replace(' ‡∏ß‡∏±‡∏ô','')
  );
  if(isNaN(daysNum) || daysNum < 0.5)
    errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 0.5 ‡∏ß‡∏±‡∏ô');

  v.leaveDays = normalizeLeaveDays(daysNum);

  return {
    ok: errors.length === 0,
    errors,
    warnings,
    value: v
  };
}
// ===== Format Timestamp (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á) =====
function fmtTS(ts){
  try{
    if(ts?.toDate){
      return ts.toDate().toLocaleString('th-TH', { hour12:false });
    }
  }catch(e){}
  try{
    return new Date(ts).toLocaleString('th-TH', { hour12:false });
  }catch(e){}
  return '';
}


    // ===== Storage drivers (Firestore / Local fallback) =====
    function explainFirestoreError(err){
      const code = err?.code || '';
      const map = {
        'permission-denied': '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠ (Firestore Rules ‡∏ö‡∏•‡πá‡∏≠‡∏Å)',
        'unauthenticated': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (Anonymous Sign-in)',
        'failed-precondition': '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö',
        'unavailable': '‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'
      };
      return map[code] || (err?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
    }

    const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const LS_KEY = 'leave-requests:nano';
    function lsLoad(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
    function lsSave(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function makeLocalDriver(){
      let listeners = [];
      function notify(){ listeners.forEach(fn => fn(lsLoad())); }
      window.addEventListener('storage', (e)=>{ if(e.key===LS_KEY) notify(); });
      return {
        kind: 'local',
        subscribe(onData){ listeners.push(onData); onData(lsLoad()); return ()=>{ listeners = listeners.filter(f=>f!==onData); } },
        async create(payload){ const data = lsLoad(); const row = { id: crypto.randomUUID(), ...payload, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }; data.unshift(row); lsSave(data); notify(); return { id: row.id }; },
        async update(id, payload){ const data = lsLoad(); const i = data.findIndex(x=>x.id===id); if(i<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); data[i] = { ...data[i], ...payload, updatedAt: new Date().toISOString() }; lsSave(data); notify(); },
        async remove(id){ const data = lsLoad().filter(x=>x.id!==id); lsSave(data); notify(); }
      };
    }
    function makeFirestoreDriver(){
      const colRef = collection(db, 'leave_requests');
      return {
        kind: 'firestore',
        subscribe(onData, onError){ const q = query(colRef, orderBy('createdAt','desc')); return onSnapshot(q, snap => { onData(snap.docs.map(d => ({ id: d.id, ...d.data() }))); }, err => onError?.(err)); },
        async create(payload){ return addDoc(colRef, { ...payload, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); },
        async update(id, payload){ return updateDoc(doc(db, 'leave_requests', id), { ...payload, updatedAt: serverTimestamp() }); },
        async remove(id){ return deleteDoc(doc(db, 'leave_requests', id)); }
      };
    }

    let driver = null; let unsubscribe = null; let cache = [];
    function attachSubscription(){
      if(unsubscribe) try{ unsubscribe(); }catch{}
      unsubscribe = driver.subscribe(rows => { cache = rows; renderTable(); }, (err)=>{
        console.error('@firebase/firestore subscribe', err);
        showToast('Firestore ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + explainFirestoreError(err), 'error');
        driver = makeLocalDriver(); attachSubscription();
      });
    }

    if(!isSecureOrigin){ driver = makeLocalDriver(); attachSubscription(); }
    else {
      signInAnonymously(auth).then(()=>{ driver = makeFirestoreDriver(); attachSubscription(); })
      .catch(err=>{ console.error('signInAnonymously', err); driver = makeLocalDriver(); attachSubscription(); showToast('‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Local ‡πÅ‡∏ó‡∏ô: '+explainFirestoreError(err),'error'); });
    }

    // ===== Render table =====
    function renderTable(){
      leaveTable.innerHTML = '';
      cache.forEach(row => {
        const tr = document.createElement('tr');
        const tdEmpId = document.createElement('td'); tdEmpId.className='p-3 text-center'; tdEmpId.textContent = row.empId || '-';
        const tdName = document.createElement('td'); tdName.className='p-3'; tdName.textContent = row.empName || '';
        const tdType = document.createElement('td'); tdType.className='p-3'; tdType.textContent = row.leaveType || '';
        const tdStart = document.createElement('td'); tdStart.className='p-3 text-center'; tdStart.textContent = fmtDateDMY(row.startDate) || '';
        const tdEnd = document.createElement('td'); tdEnd.className='p-3 text-center'; tdEnd.textContent = fmtDateDMY(row.endDate) || '';
        const tdDays = document.createElement('td'); tdDays.className='p-3 text-center'; tdDays.textContent = row.leaveDays || '';
        const tdAppr = document.createElement('td'); tdAppr.className='p-3 text-center'; tdAppr.textContent = row.approver || '';
        const tdSubmit = document.createElement('td'); tdSubmit.className='p-3 text-center'; tdSubmit.textContent = fmtDateDMY(row.submitDate) || '';
        const tdSys = document.createElement('td'); tdSys.className='p-3 text-center'; tdSys.textContent = row.systemTime || '';
        const tdUpd = document.createElement('td'); tdUpd.className='p-3 text-center'; tdUpd.textContent = row.updatedAt ? fmtTS(row.updatedAt) : (row.createdAt ? fmtTS(row.createdAt) : '');
        const tdActions = document.createElement('td'); tdActions.className='p-3 text-center';
        const btnEdit = document.createElement('button'); btnEdit.className='text-blue-600 hover:text-blue-800 underline mr-2'; btnEdit.textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; btnEdit.dataset.action='edit'; btnEdit.dataset.id=row.id;
        const btnDel = document.createElement('button'); btnDel.className='text-red-600 hover:text-red-800 underline'; btnDel.textContent='üóëÔ∏è ‡∏•‡∏ö'; btnDel.dataset.action='delete'; btnDel.dataset.id=row.id;
        tdActions.appendChild(btnEdit); tdActions.appendChild(btnDel);
        tr.appendChild(tdEmpId); tr.appendChild(tdName); tr.appendChild(tdType);
        tr.appendChild(tdStart); tr.appendChild(tdEnd); tr.appendChild(tdDays); tr.appendChild(tdAppr);
        tr.appendChild(tdSubmit); tr.appendChild(tdSys); tr.appendChild(tdUpd);
        tr.appendChild(tdActions);
        leaveTable.appendChild(tr);
      });
    }

    // ===== Submit (create) =====
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const row = {
        empId: empId.value.trim(),
        empName: empName.value.trim(),
        department: department.value.trim(),
        leaveType: leaveType.value,
        startDate: startDate.value,
        endDate: endDate.value,
        leaveDays: leaveDays.value,
        reason: reason.value.trim(),
        approver: approver.value.trim(),
        submitDate: submitDate.value,
        systemTime: systemTimeEl.value
      };
      const { ok, errors, warnings, value } = validateRow(row);
      if(!ok){ showToast('‚ùå ' + errors.join(' | '), 'error'); return; }
      if(warnings.length){ showToast('‚ö†Ô∏è ' + warnings.join(' | '), 'error'); }
      try{
        await driver.create(value);
        form.reset();
        submitDate.value = todayISO();
        showToast('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß','success');
      }catch(err){ showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err), 'error'); }
    });

    // ===== Edit / Delete (delegation) =====
    const editModal = document.getElementById('editModal');
    const editStart = document.getElementById('editStart');
    const editEnd = document.getElementById('editEnd');
    const editDays = document.getElementById('editDays');
    const saveEdit = document.getElementById('saveEdit');
    const cancelEdit = document.getElementById('cancelEdit');

    const passwordModal = document.getElementById('passwordModal');
    const hrPasswordInput = document.getElementById('hrPasswordInput');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');

    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id'); if(!action || !id) return;
      const idx = cache.findIndex(r=> r.id===id); if(idx<0) return;

      if(action==='edit'){
        editStart.value = cache[idx].startDate || '';
        editEnd.value = cache[idx].endDate || '';
        const currentDays = String(cache[idx].leaveDays || '').replace(' ‡∏ß‡∏±‡∏ô','');
        editDays.value = currentDays || 1;
        editModal.style.display='block';

        saveEdit.onclick = async ()=>{
          const upd = { startDate: editStart.value, endDate: editEnd.value, leaveDays: editDays.value, submitDate: cache[idx].submitDate };
          const { ok, errors, warnings, value } = validateRow({ ...cache[idx], ...upd });
          if(!ok){ showToast('‚ùå ' + errors.join(' | '), 'error'); return; }
          if(warnings.length){ showToast('‚ö†Ô∏è ' + warnings.join(' | '), 'error'); }
          try{ await driver.update(id, value); editModal.style.display='none'; showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success'); }
          catch(err){ showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err), 'error'); }
        };
        cancelEdit.onclick = ()=>{ editModal.style.display='none'; };
      }

      if(action==='delete'){
        passwordModal.style.display='block'; hrPasswordInput.value='';
        confirmDelete.onclick = async ()=>{
          if(hrPasswordInput.value !== HR_PASSWORD){ showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); return; }
          try{ await driver.remove(id); passwordModal.style.display='none'; showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success'); }
          catch(err){ showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err), 'error'); }
        };
        cancelDelete.onclick = ()=>{ passwordModal.style.display='none'; };
      }
    });

    // ===== CSV export =====
    function csvEscape(value){ const s = String(value ?? '').replace(/"/g,'""'); return '"' + s + '"'; }
    function tableToCSV(){
      const rows = [[ '‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤','‡πÄ‡∏£‡∏¥‡πà‡∏°','‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô','‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤','‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤','‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á','‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' ]];
      cache.forEach(r=>{ rows.push([ r.empId||'', r.empName||'', r.leaveType||'', r.startDate||'', r.endDate||'', r.leaveDays||'', r.reason||'', r.approver||'', r.submitDate||'', r.systemTime||'', r.updatedAt?fmtTS(r.updatedAt):(r.createdAt?fmtTS(r.createdAt):'') ]); });
      return rows.map(cols => cols.map(csvEscape).join(',')).join('\n');
    }
    downloadCSVBtn.addEventListener('click', ()=>{
      const csv = tableToCSV();
      const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'leave-requests.csv'; a.click(); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>



