<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤ 2026 (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå & ‡∏Ñ‡∏∏‡∏°‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤) - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast{position:fixed;bottom:20px;right:20px;color:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;z-index:50}
    .toast.success{background:#16a34a}
    .toast.error{background:#dc2626}
    .toast.warning{background:#ea580c}
    .toast.show{opacity:1;transform:translateY(0)}
    .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4)}
    .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:12px;max-width:600px;box-shadow:0 5px 15px rgba(0,0,0,0.3);position:relative}
    .btn{display:inline-flex;align-items:center;gap:.5rem}
    .img-preview-container { text-align: center; margin-top: 10px; }
    .img-preview { max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #ddd; }
    .input-error { border-color: #dc2626 !important; background-color: #fef2f2 !important; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
  <!-- HEADER + RULES -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <img src="https://i.postimg.cc/kMHv7FsP/loko-nano.png" alt="NANO Logo" class="h-10" onerror="this.style.display='none'">
      <div>
        <h1 class="text-xl font-bold text-gray-800">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏°‡∏¥‡πÄ‡∏£‡∏≠‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡πâ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h1>
        <p class="text-sm text-gray-500">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ)</p>
      </div>
    </div>

    <div class="bg-red-50 border border-red-200 text-red-800 p-3 rounded-lg mb-4 text-sm">
      <p class="font-semibold">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
      <ul class="list-disc ml-5">
        <li>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
        <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</li>
        <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
        <li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)</li>
        <li>‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á HR ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô ‡∏Å‡πá ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
      </ul>
    </div>

    <!-- FORM -->
    <form id="leaveForm" class="space-y-4" novalidate>
      <div>
        <label class="block text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="text" id="empId" class="w-full p-2 border rounded-lg transition-colors" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="empName" class="w-full p-2 border rounded-lg transition-colors" required>
        </div>
        <div>
          <label class="block text-gray-700">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <input type="text" id="department" class="w-full p-2 border rounded-lg transition-colors" required>
        </div>
      </div>
      <div>
        <label class="block text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <select id="leaveType" class="w-full p-2 border rounded-lg transition-colors" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
          <option>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option>‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î</option>
          <option>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
          <option>‡∏å‡∏≤‡∏õ‡∏ì‡∏Å‡∏¥‡∏à</option>
          <option>‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          <option>‡∏ä‡∏≠‡πÄ‡∏ä‡∏¢/‡∏™‡∏•‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</option>
        </select>
      </div>

      <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå -->
      <div id="fileUploadSection" class="hidden bg-blue-50 p-3 rounded-lg border border-blue-200">
        <label class="block text-blue-800 font-semibold mb-2">üìé ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
        <input type="file" id="fileInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        <p class="text-xs text-gray-500 mt-1">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö jpg, png)</p>
        <img id="previewImage" class="hidden mt-2 max-h-40 rounded border border-gray-300">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
          <input type="date" id="startDate" class="w-full p-2 border rounded-lg transition-colors" required>
        </div>
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤</label>
          <input type="date" id="endDate" class="w-full p-2 border rounded-lg transition-colors" required>
        </div>
      </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div>
    <label class="block text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤</label>
    <input type="number" step="0.5" min="0.5" id="leaveDays"
      class="w-full p-2 border rounded-lg transition-colors">
  </div>

  <div>
    <label class="block text-gray-700">‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô</label>
    <select id="halfDayPeriod"
      class="w-full p-2 border rounded-lg transition-colors">
      <option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏</option>
      <option value="‡πÄ‡∏ä‡πâ‡∏≤">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤</option>
      <option value="‡∏ö‡πà‡∏≤‡∏¢">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢</option>
    </select>
  </div>
</div>

      <div>
        <label class="block text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
        <textarea id="reason" rows="3" class="w-full p-2 border rounded-lg transition-colors" required></textarea>
      </div>
      <div>
        <label class="block text-gray-700">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
        <input type="text" id="approver" class="w-full p-2 border rounded-lg transition-colors" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</label>
          <input type="date" id="submitDate" class="w-full p-2 border rounded-lg" required readonly>
        </div>
        <div>
          <label class="block text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
          <input type="text" id="systemTime" readonly class="w-full p-2 border bg-gray-100 rounded-lg">
        </div>
      </div>
      <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
    </form>
  </div>

  <!-- LIST + CSV -->
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-6xl p-6 mt-2">
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-2">
           <button id="downloadCSV" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm shadow">
             üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (CSV)
           </button>
           <span id="csvLoading" class="text-xs text-gray-500 hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
      </div>
      <h2 class="text-xl font-bold text-blue-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h2>
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
      <table class="w-full text-sm text-left text-gray-700">
        <thead class="bg-gradient-to-r from-blue-100 to-blue-50 border-b text-blue-900">
          <tr>
            <th class="p-3 text-center">‡∏£‡∏´‡∏±‡∏™</th>
            <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
            <th class="p-3 text-center">‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th class="p-3 text-center">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
            <th class="p-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
            <th class="p-3 text-center">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
            <th class="p-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</th>
            <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="leaveTable" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤</h3>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤:</label>
      <input type="date" id="editStart"
  class="w-full p-2 border rounded mb-2 bg-gray-100 cursor-not-allowed"
  readonly>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤:</label>
      <input type="date" id="editEnd" class="w-full p-2 border rounded mb-2">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤:</label>
      <input type="number" step="0.5" min="0.5" id="editDays" class="w-full p-2 border rounded mb-2">
      <label class="mt-2 block">‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô:</label>
<select id="editHalfDayPeriod" class="w-full p-2 border rounded mb-2">
  <option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏</option>
  <option value="‡πÄ‡∏ä‡πâ‡∏≤">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤</option>
  <option value="‡∏ö‡πà‡∏≤‡∏¢">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢</option>
</select>
      <div id="editImageSection" class="mt-2 mb-2 p-2 bg-gray-100 rounded">
        <label class="text-sm font-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô:</label>
        <input type="file" id="editFileInput" accept="image/*" class="w-full text-xs mt-1">
        <div id="editCurrentImgContainer" class="mt-2 hidden">
             <p class="text-xs text-gray-500">‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</p>
             <img id="editCurrentImg" class="h-20 border rounded">
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-3">
        <button id="saveEdit" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="cancelEdit" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- IMAGE VIEW MODAL -->
  <div id="imageModal" class="modal">
    <div class="modal-content text-center">
      <h3 class="text-lg font-bold mb-3 text-gray-800">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
      <div class="img-preview-container">
        <img id="modalImageDisplay" class="img-preview" src="" alt="Proof">
      </div>
      <div class="mt-4">
        <button id="closeImageModal" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD MODAL -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-3">üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <input type="password" id="hrPasswordInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-2 border rounded mb-3">
      <div class="flex justify-end gap-2">
        <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded">‡∏•‡∏ö</button>
        <button id="cancelDelete" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast success">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    // Added 'where' to Firestore imports for filtering
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, limit, getDocs, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9Gzqb2sgYdhg0G5_ivc_GemeQp0yUy8Y",
      authDomain: "leave-form-cd603.firebaseapp.com",
      projectId: "leave-form-cd603",
      storageBucket: "leave-form-cd603.firebasestorage.app",
      messagingSenderId: "180376619525",
      appId: "1:180376619525:web:8270c8a3a0ec5196e5ea6c",
      measurementId: "G-V9Z02K9LT6"
    };

    const toast = document.getElementById('toast');
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 5000); 
    }
    window.addEventListener('error', (e)=>{ showToast(`‚ö†Ô∏è JS Error: ${e.message}`, 'error'); });

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const systemTimeEl = document.getElementById('systemTime');
    function updateSystemTime(){
      try{ if(systemTimeEl) systemTimeEl.value = new Date().toLocaleString('th-TH',{hour12:false,timeZone:'Asia/Bangkok'}); }catch(e){}
    }
    updateSystemTime();
    setInterval(updateSystemTime, 1000);

    function todayISO(){
      const d = new Date();
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }

    function fmtDateDMY(iso){
      if(!iso) return '';
      const s = String(iso);
      const base = s.length >= 10 ? s.slice(0,10) : s;
      const parts = base.split('-');
      if(parts.length === 3){
        const [y,m,d] = parts;
        return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
      }
      return iso;
    }

    const form = document.getElementById('leaveForm');
    const leaveTable = document.getElementById('leaveTable');
    const downloadCSVBtn = document.getElementById('downloadCSV');
    const csvLoading = document.getElementById('csvLoading');

    const empId = document.getElementById('empId');
    const empName = document.getElementById('empName');
    const department = document.getElementById('department');
    const leaveType = document.getElementById('leaveType');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const leaveDays = document.getElementById('leaveDays');
    const reason = document.getElementById('reason');
    const approver = document.getElementById('approver');
    const submitDate = document.getElementById('submitDate');
    
    const fileUploadSection = document.getElementById('fileUploadSection');
    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');

    submitDate.value = todayISO();
    submitDate.setAttribute('readonly','readonly');

    const HR_PASSWORD = '303647';
    const MAX_VACATION_DAYS = 6; // Limit for Vacation Leave
    
    const imageModal = document.getElementById('imageModal');
    const modalImageDisplay = document.getElementById('modalImageDisplay');
    const closeImageModal = document.getElementById('closeImageModal');

    leaveType.addEventListener('change', () => {
      if(leaveType.value === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå') {
        fileUploadSection.classList.remove('hidden');
      } else {
        fileUploadSection.classList.add('hidden');
        fileInput.value = ''; 
        previewImage.classList.add('hidden');
        previewImage.src = '';
      }
    });

    fileInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        if(file.size > 10 * 1024 * 1024) { 
             alert("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô");
             this.value = '';
             return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewImage.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
      } else {
        previewImage.classList.add('hidden');
        previewImage.src = '';
      }
    });

    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_WIDTH = 800;
            const MAX_HEIGHT = 800;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
          };
          img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
      });
    }

    const EMP_MAP = {
      "10010": { name: "‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏°‡∏µ‡∏Å‡∏∏‡∏•", dept: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
      "10139": { name: "‡∏Ç‡∏ß‡∏±‡∏ç‡πÉ‡∏à ‡∏ö‡∏∏‡∏ç‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á", dept: "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" },
      "10141": { name: "‡πÄ‡∏Å‡∏©‡∏£ ‡∏Å‡∏≠‡∏á‡∏ß‡∏á‡∏Ñ‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10180": { name: "‡∏£‡∏∏‡πà‡∏á‡∏£‡∏∞‡∏ß‡∏µ ‡πÇ‡∏™‡∏°‡∏π‡∏•", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10349": { name: "‡πÄ‡∏Å‡∏©‡∏°‡∏™‡∏∏‡∏Ç ‡πÄ‡∏ä‡∏¥‡∏î‡∏ä‡∏π", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10350": { name: "‡∏£‡∏±‡∏ä‡∏ô‡∏µ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "10353": { name: "‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏ô ‡πÅ‡∏™‡∏ô‡∏†‡∏π‡∏°‡∏¥", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10365": { name: "‡∏™‡∏∏‡∏û‡∏±‡∏ï‡∏£‡∏≤ ‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ä‡∏≤‡∏ï‡∏¥", dept: "‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î" },
      "10385": { name: "‡∏û‡∏á‡∏®‡πå‡∏û‡∏±‡∏ô‡∏ò‡πå ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏≠‡∏á‡∏î‡∏µ", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10440": { name: "‡∏ô‡∏¥‡∏†‡∏≤‡∏û‡∏£ ‡∏õ‡∏¥‡∏¢‡∏≤‡πÇ‡∏¢‡∏Ñ", dept: "‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠" },
      "10442": { name: "‡∏î‡∏≤‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏ß‡∏¥‡∏£‡∏∞‡∏®‡∏£‡∏µ", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "10452": { name: "‡∏≠‡∏£‡∏™‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏û‡∏¥‡∏°‡∏û‡πå", dept: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10461": { name: "‡∏Ç‡∏à‡∏£ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏°‡∏ô", dept: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" },
      "10470": { name: "‡∏°‡∏á‡∏Ñ‡∏• ‡∏≠‡∏á‡∏≠‡∏≤‡∏à", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10499": { name: "‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏ö‡∏±‡∏ß‡πÄ‡∏Ç‡πá‡∏°", dept: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" },
      "10506": { name: "‡∏≠‡∏£‡∏∏‡∏ì‡∏µ ‡∏™‡∏≠‡∏ô‡∏ß‡∏á‡∏©‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï3" },
      "10516": { name: "‡∏™‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏î‡∏ä‡πÇ‡∏õ‡∏£‡∏î", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10518": { name: "‡∏ò‡∏ß‡∏±‡∏ä ‡∏ó‡∏±‡∏ô‡πÉ‡∏à", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10520": { name: "‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏£‡∏ì‡πå ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10525": { name: "‡∏ò‡∏¥‡∏ç‡∏≤‡∏î‡∏≤ ‡∏ä‡∏≤‡∏•‡∏µ‡∏ß‡∏±‡∏ô", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10526": { name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10527": { name: "‡∏ä‡∏π‡∏û‡∏á‡∏®‡πå ‡∏ó‡∏≥‡∏î‡∏µ", dept: "‡∏ô‡∏¥‡∏ß‡πÇ‡∏°‡πÄ‡∏î‡∏•" },
      "10553": { name: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10556": { name: "‡∏™‡∏Å‡∏∏‡∏ì‡∏≤ ‡∏Å‡∏£‡∏£‡∏ì‡∏¥‡∏Å‡∏≤", dept: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
      "10564": { name: "‡∏ß‡∏±‡∏ä‡∏£‡∏≤‡∏§‡∏ó‡∏ò‡∏¥‡πå ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10565": { name: "‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏ó‡∏≤‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10583": { name: "‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏≠‡∏£ ‡∏™‡∏≠‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10606": { name: "‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤ ‡∏î‡∏≥‡∏î‡∏µ", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10620": { name: "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏î‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏¢‡∏≠", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10627": { name: "‡∏ô‡∏û‡∏î‡∏• ‡∏ï‡∏µ‡πä‡∏ö‡∏ö‡∏∏‡∏ç‡∏®‡∏£‡∏µ", dept: "‡∏ú‡∏•‡∏¥‡∏ï3" },
      "10630": { name: "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏™‡∏ô‡∏ó‡∏∞‡∏ß‡∏á‡∏Ñ‡πå", dept: "‡∏ô‡∏¥‡∏ß‡πÇ‡∏°‡πÄ‡∏î‡∏•" },
      "10635": { name: "‡∏£‡∏™‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏û‡∏á‡∏®‡πå", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "10636": { name: "‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï ‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏•‡πâ‡∏≥", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10637": { name: "‡∏ï‡πâ‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏• ‡∏°‡∏∏‡∏á‡∏Ñ‡∏∏‡∏•‡∏Ñ‡∏≥‡∏ã‡∏≤‡∏ß", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "10640": { name: "‡∏®‡∏∏‡∏†‡∏Å‡∏£ ‡πÅ‡∏£‡∏á‡πÉ‡∏´‡∏°‡πà", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10641": { name: "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏î‡∏≤ ‡∏û‡∏¥‡πÑ‡∏ä‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡∏à‡∏¥‡∏ô‡∏î‡∏≤", dept: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï" },
      "10642": { name: "‡∏ß‡∏¥‡∏™‡∏∏‡∏î‡∏≤ ‡∏û‡∏¥‡πÑ‡∏ä‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡∏à‡∏¥‡∏ô‡∏î‡∏≤", dept: "‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠" },
      "10648": { name: "‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏≤ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10660": { name: "‡∏à‡∏¥‡∏£‡∏†‡∏¥‡∏ç‡∏ç‡∏≤ ‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏Ü", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "10661": { name: "‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏£‡∏ì ‡∏™‡∏ô‡πÉ‡∏à", dept: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï" },
      "10669": { name: "‡πÇ‡∏Å‡∏ß‡∏¥‡∏ó ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏†‡∏≤", dept: "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" },
      "10670": { name: "‡∏≠‡∏±‡∏Ñ‡∏£‡∏û‡∏±‡∏ä‡∏£‡πå ‡∏Å‡∏£‡∏á‡πÄ‡∏ï‡πâ‡∏ô", dept: "‡∏°‡∏¥‡∏•‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢" },
      "12453": { name: "‡∏à‡∏≤‡∏£‡∏∏‡∏ì‡∏µ ‡∏Ñ‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏°", dept: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" },
      "30070": { name: "NAW TIN TIN HTWE TIN HTWE @ THUY", dept: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" },
      "30072": { name: "MYOLATT", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30078": { name: "NGWE HTIKE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30079": { name: "EI EI THET", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30087": { name: "MYO THET", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30113": { name: "THIN THIN AUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30115": { name: "AUNG TIN MYINT", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30117": { name: "KHIN CHO OO", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30149": { name: "ZAW ZAW AUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30171": { name: "MIN ZAW MIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30221": { name: "TUN AUNG SHEIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30249": { name: "KHAING THA ZIN PHYO", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30251": { name: "KO KO KU KU", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30257": { name: "TOE NAING", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30265": { name: "HNIN THET", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30268": { name: "KYAT PHA", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30269": { name: "NINE NINE @ HNIN HNIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30270": { name: "KHON THEIN SAUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30292": { name: "SAI MAUNG MAUNG", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30294": { name: "THUZAR", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30313": { name: "AUNG TUN OO", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30315": { name: "KYAW LIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï3" },
      "30318": { name: "SAW AHL HTO", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30328": { name: "THEINGI WIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30329": { name: "THI THI KHINE", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30333": { name: "YE LIN TUN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30334": { name: "PHYU PHYU THEIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30335": { name: "YE LIN HTIKE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30336": { name: "AYE PWINT PHYU", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30337": { name: "AYE THANDAR ZAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30338": { name: "CHIT HTWE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30340": { name: "SHAN MA LAY", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30341": { name: "NAING PHYO KYAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30342": { name: "NAW SAN THIDA NYEIN", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30348": { name: "PHYO MIN WAI", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30349": { name: "SOE MOE KYAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30350": { name: "YE ZAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30351": { name: "TIN MYO KO", dept: "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" },
      "30352": { name: "NWAY JUNG ZIN LATT", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30353": { name: "SAI KYAW KYAW", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30354": { name: "KYAW THURA SOE", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30362": { name: "EA LA SOE", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30366": { name: "‡∏ô‡∏¥ ‡∏ä‡∏≤‡∏¢", dept: "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ" },
      "30367": { name: "‡∏Ñ‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" },
      "30368": { name: "‡∏Å‡∏≠‡∏á‡∏õ‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏ß", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30369": { name: "‡∏°‡∏¥‡∏ô ‡∏Ñ‡∏≤‡∏ô‡∏ï‡πå ‡∏ã‡∏≠", dept: "‡∏ú‡∏•‡∏¥‡∏ï1" },
      "30370": { name: "‡∏ä‡∏¥‡∏î ‡∏°‡∏¥‡∏ô ‡∏ô‡∏≤‡∏¢", dept: "‡∏ú‡∏•‡∏¥‡∏ï2" }
    };

    function normalizeEmpId(raw){ return String(raw||'').trim(); }
    function autofillNameFromEmpId(rawId){
      const id = normalizeEmpId(rawId);
      const info = id && EMP_MAP[id];
      if(info){
        empName.value = info.name;
        department.value = info.dept || "";
      }
    }

    let empIdTimer;
    empId.addEventListener('input', ()=>{
      clearTimeout(empIdTimer);
      empIdTimer = setTimeout(()=>autofillNameFromEmpId(empId.value), 250);
    });
    empId.addEventListener('blur', ()=>autofillNameFromEmpId(empId.value));

    function clearInputError(input){ input.classList.remove('input-error'); }
    function addInputError(input){ input.classList.add('input-error'); }
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', () => clearInputError(input));
        input.addEventListener('change', () => clearInputError(input));
    });

    function isDisallowedSubmitDate(iso){
      if(!iso) return false;
      const d = new Date(iso + 'T00:00:00');
      return d.getDay() === 0; 
    }

    function normalizeLeaveDays(val){
      const t = String(val ?? '').trim();
      if(!t) return '';
      return /‡∏ß‡∏±‡∏ô$/.test(t) ? t : (t + ' ‡∏ß‡∏±‡∏ô');
    }

    function validateRow(values){
      const errors = [];
      const warnings = [];
      const v = { ...values };
      const invalidFields = []; 

      const fieldConfig = {
        empId: { label: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', id: 'empId' },
        empName: { label: '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', id: 'empName' },
        department: { label: '‡πÅ‡∏ú‡∏ô‡∏Å', id: 'department' },
        leaveType: { label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤', id: 'leaveType' },
        startDate: { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤', id: 'startDate' },
        endDate: { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤', id: 'endDate' },
        leaveDays: { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤', id: 'leaveDays' },
        reason: { label: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤', id: 'reason' },
        approver: { label: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', id: 'approver' },
        submitDate: { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤', id: 'submitDate' }
      };

      Object.keys(fieldConfig).forEach(k=>{ 
          if(!String(v[k] ?? '').trim()) {
              errors.push(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "${fieldConfig[k].label}" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
              invalidFields.push(fieldConfig[k].id);
          }
      });

      const minYear = 2024; 
      const maxYear = 2100; 
      
      const checkYear = (dateStr, fieldId, label) => {
          if(!dateStr) return;
          const y = parseInt(dateStr.split('-')[0]);
          if(y < minYear){
              errors.push(`‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á "${label}" ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ ${minYear})`);
              invalidFields.push(fieldId);
          } else if (y > maxYear) {
              if(y > 2400 && y < 2600) {
                   errors.push(`‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á "${label}" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (‡πÄ‡∏ä‡πà‡∏ô ${y-543})`);
              } else {
                   errors.push(`‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á "${label}" ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏Å‡∏¥‡∏ô‡∏õ‡∏µ ${maxYear})`);
              }
              invalidFields.push(fieldId);
          }
      };

      checkYear(v.startDate, 'startDate', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤');
      checkYear(v.endDate, 'endDate', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤');

      const s = new Date(v.startDate + 'T00:00:00');
      const e = new Date(v.endDate + 'T00:00:00');
      
      if(!isNaN(s.getTime()) && !isNaN(e.getTime()) && e < s) {
          errors.push('‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°)');
          invalidFields.push('startDate');
          invalidFields.push('endDate');
      }

      if(isDisallowedSubmitDate(v.submitDate)) {
          errors.push('‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå');
          invalidFields.push('submitDate');
      }

      if(v.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && !isNaN(s.getTime())){
        const sub = new Date(v.submitDate + 'T00:00:00');
        const diffDays = (s - sub) / 86400000;
        if(diffDays < 1){
          v.leaveType = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
          warnings.push('‡∏™‡πà‡∏á‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á/‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡∏≤‡∏Å‡∏¥‡∏à"');
        }
      }

      const daysNum = parseFloat(String(v.leaveDays).replace(' ‡∏ß‡∏±‡∏ô',''));
      if(isNaN(daysNum) || daysNum < 0.5) {
          errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 0.5 ‡∏ß‡∏±‡∏ô');
          invalidFields.push('leaveDays');
      }
      v.leaveDays = normalizeLeaveDays(daysNum);

      return { ok: errors.length === 0, errors, warnings, value: v, invalidFields };
    }

    function fmtTS(ts){
      try{ if(ts?.toDate) return ts.toDate().toLocaleString('th-TH', { hour12:false }); }catch(e){}
      try{ return new Date(ts).toLocaleString('th-TH', { hour12:false }); }catch(e){}
      return '';
    }

    function explainFirestoreError(err){
      const code = err?.code || '';
      const map = { 'permission-denied': '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠', 'unauthenticated': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô', 'unavailable': '‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á' };
      return map[code] || (err?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
    }

    const LS_KEY = 'leave-requests:nano';
    function lsLoad(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
    function lsSave(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    
    function makeLocalDriver(){
      let listeners = [];
      function notify(){ listeners.forEach(fn => fn(lsLoad())); }
      window.addEventListener('storage', (e)=>{ if(e.key===LS_KEY) notify(); });
      return {
        kind: 'local',
        subscribe(onData){ listeners.push(onData); onData(lsLoad()); return ()=>{ listeners = listeners.filter(f=>f!==onData); } },
        async create(payload){ const data = lsLoad(); const row = { id: crypto.randomUUID(), ...payload, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }; data.unshift(row); lsSave(data); notify(); return { id: row.id }; },
        async update(id, payload){ const data = lsLoad(); const i = data.findIndex(x=>x.id===id); if(i<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); data[i] = { ...data[i], ...payload, updatedAt: new Date().toISOString() }; lsSave(data); notify(); },
        async remove(id){ const data = lsLoad().filter(x=>x.id!==id); lsSave(data); notify(); },
        async getAll(){ return lsLoad(); },
        // Add getEmployeeHistory for local storage
        async getEmployeeHistory(id){ 
             const all = lsLoad(); 
             return all.filter(x => x.empId === id);
        }
      };
    }
    
    function makeFirestoreDriver(){
      const colRef = collection(db, 'leave_requests');
      return {
        kind: 'firestore',
        subscribe(onData, onError){ 
            const q = query(colRef, orderBy('createdAt','desc'), limit(50)); 
            return onSnapshot(q, snap => { onData(snap.docs.map(d => ({ id: d.id, ...d.data() }))); }, err => onError?.(err)); 
        },
        async create(payload){ return addDoc(colRef, { ...payload, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); },
        async update(id, payload){ return updateDoc(doc(db, 'leave_requests', id), { ...payload, updatedAt: serverTimestamp() }); },
        async remove(id){ return deleteDoc(doc(db, 'leave_requests', id)); },
        async getAll(){ 
             const q = query(colRef, orderBy('createdAt','desc'));
             const snap = await getDocs(q);
             return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        },
        // ADDED: Fetch specific employee history
        async getEmployeeHistory(id){
             // Query by empId to get history
             const q = query(colRef, where('empId', '==', id));
             const snap = await getDocs(q);
             return snap.docs.map(d => d.data());
        }
      };
    }

    let driver = null; let unsubscribe = null; let cache = [];
    const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

    function attachSubscription(){
      if(unsubscribe) try{ unsubscribe(); }catch{}
      unsubscribe = driver.subscribe(rows => { cache = rows; renderTable(); }, (err)=>{
        console.error('Firestore Error', err);
        showToast('Firestore ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Local ‡πÅ‡∏ó‡∏ô', 'error');
        driver = makeLocalDriver(); attachSubscription();
      });
    }

    if(!isSecureOrigin){ driver = makeLocalDriver(); attachSubscription(); }
    else {
      signInAnonymously(auth).then(()=>{ driver = makeFirestoreDriver(); attachSubscription(); })
      .catch(err=>{ console.error(err); driver = makeLocalDriver(); attachSubscription(); showToast('‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Local ‡πÅ‡∏ó‡∏ô','error'); });
    }

    function renderTable(){
      leaveTable.innerHTML = '';
      cache.forEach(row => {
        const tr = document.createElement('tr');
        const cols = [
            { t: row.empId || '-', c: 'text-center' },
            { t: row.empName || '', c: '' },
            { t: row.leaveType || '', c: '' },
        ];
        
        const tdImg = document.createElement('td');
        tdImg.className = 'p-3 text-center';
        if (row.attachment) {
            const btnView = document.createElement('button');
            btnView.innerHTML = 'üì∑ ‡∏î‡∏π‡∏£‡∏π‡∏õ';
            btnView.className = 'bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs hover:bg-blue-200';
            btnView.onclick = () => {
                modalImageDisplay.src = row.attachment;
                imageModal.style.display = 'block';
            };
            tdImg.appendChild(btnView);
        } else {
            tdImg.textContent = '-';
        }

        const cols2 = [
            { t: fmtDateDMY(row.startDate) || '', c: 'text-center' },
            { t: fmtDateDMY(row.endDate) || '', c: 'text-center' },
{ 
  t: row.leaveDays 
     ? row.leaveDays + (row.halfDayPeriod ? ` (${row.halfDayPeriod})` : '')
     : '', 
  c: 'text-center' 
},
            { t: row.approver || '', c: 'text-center' },
            { t: fmtDateDMY(row.submitDate) || '', c: 'text-center' },
        ];

        const tdActions = document.createElement('td'); tdActions.className='p-3 text-center';
        const btnEdit = document.createElement('button'); btnEdit.className='text-blue-600 hover:text-blue-800 underline mr-2'; btnEdit.textContent='‚úèÔ∏è'; btnEdit.dataset.action='edit'; btnEdit.dataset.id=row.id;
        const btnDel = document.createElement('button'); btnDel.className='text-red-600 hover:text-red-800 underline'; btnDel.textContent='üóëÔ∏è'; btnDel.dataset.action='delete'; btnDel.dataset.id=row.id;
        tdActions.appendChild(btnEdit); tdActions.appendChild(btnDel);

        cols.forEach(x => { const td=document.createElement('td'); td.className=`p-3 ${x.c}`; td.textContent=x.t; tr.appendChild(td); });
        tr.appendChild(tdImg);
        cols2.forEach(x => { const td=document.createElement('td'); td.className=`p-3 ${x.c}`; td.textContent=x.t; tr.appendChild(td); });
        tr.appendChild(tdActions);

        leaveTable.appendChild(tr);
      });
    }

    closeImageModal.onclick = () => { imageModal.style.display = 'none'; };
    window.onclick = (e) => {
        if(e.target === imageModal) imageModal.style.display = 'none';
        if(e.target === editModal) editModal.style.display = 'none';
        if(e.target === passwordModal) passwordModal.style.display = 'none';
    };

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

      form.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

      try {
        let attachmentBase64 = null;
        if(fileInput.files.length > 0){
            attachmentBase64 = await compressImage(fileInput.files[0]);
        }

        const row = {
            empId: empId.value.trim(),
            empName: empName.value.trim(),
            department: department.value.trim(),
            leaveType: leaveType.value,
            startDate: startDate.value,
            endDate: endDate.value,
            leaveDays: leaveDays.value,
            reason: reason.value.trim(),
            approver: approver.value.trim(),
            submitDate: submitDate.value,
            systemTime: systemTimeEl.value,
            attachment: attachmentBase64,
            halfDayPeriod: document.getElementById('halfDayPeriod').value || '',
        };

        const { ok, errors, warnings, value, invalidFields } = validateRow(row);
        
        if(!ok){ 
            showToast('‚ùå ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errors[0], 'error'); 
            if(invalidFields && invalidFields.length > 0){
                invalidFields.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) addInputError(el);
                });
            }
            submitBtn.disabled = false; submitBtn.textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
            return; 
        }

        // === Vacation Leave Quota Check ===
        if (value.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') {
            const history = await driver.getEmployeeHistory(value.empId);
            
            // Check specific year based on start date
            const reqYear = parseInt(value.startDate.split('-')[0]);
            
            // Calculate used days for this year
            let usedDays = 0;
            history.forEach(h => {
                if (h.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && h.startDate && h.startDate.startsWith(String(reqYear))) {
                    const d = parseFloat(String(h.leaveDays).replace(' ‡∏ß‡∏±‡∏ô','')) || 0;
                    usedDays += d;
                }
            });

            const requesting = parseFloat(String(value.leaveDays).replace(' ‡∏ß‡∏±‡∏ô','')) || 0;
            
            if (usedDays + requesting > MAX_VACATION_DAYS) {
                 showToast(`‚ùå ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${usedDays}, ‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° ${requesting}, ‡∏£‡∏ß‡∏° ${usedDays+requesting} > ${MAX_VACATION_DAYS} ‡∏ß‡∏±‡∏ô)`, 'error');
                 submitBtn.disabled = false; 
                 submitBtn.textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
                 return; // Stop submission
            }
        }
        // ==================================

        submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        await driver.create(value);
        
        form.reset();
        fileUploadSection.classList.add('hidden'); 
        previewImage.classList.add('hidden');
        submitDate.value = todayISO();
        
        if(warnings.length > 0){
             showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‚ö†Ô∏è ${warnings.join(' | ')})`, 'warning');
        } else {
             showToast('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

      } catch(err){
        console.error(err);
        showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err), 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
      }
    });

    const editModal = document.getElementById('editModal');
    const editStart = document.getElementById('editStart');
    const editEnd = document.getElementById('editEnd');
    const editDays = document.getElementById('editDays');
    const saveEdit = document.getElementById('saveEdit');
    const cancelEdit = document.getElementById('cancelEdit');
    const editFileInput = document.getElementById('editFileInput');
    const editCurrentImgContainer = document.getElementById('editCurrentImgContainer');
    const editCurrentImg = document.getElementById('editCurrentImg');

    const passwordModal = document.getElementById('passwordModal');
    const hrPasswordInput = document.getElementById('hrPasswordInput');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');

    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id'); if(!action || !id) return;
      const idx = cache.findIndex(r=> r.id===id); if(idx<0) return;

      if(action==='edit'){
        editStart.value = cache[idx].startDate || '';
        editEnd.value = cache[idx].endDate || '';
        const currentDays = String(cache[idx].leaveDays || '').replace(' ‡∏ß‡∏±‡∏ô','');
        editDays.value = currentDays || 1;
        document.getElementById('editHalfDayPeriod').value = cache[idx].halfDayPeriod || '';
        editFileInput.value = ''; 
        if(cache[idx].attachment){
            editCurrentImg.src = cache[idx].attachment;
            editCurrentImgContainer.classList.remove('hidden');
        } else {
            editCurrentImgContainer.classList.add('hidden');
        }

        editModal.style.display='block';

        saveEdit.onclick = async ()=>{
          let newAttachment = cache[idx].attachment;
          if(editFileInput.files.length > 0){
              try {
                  saveEdit.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
                  newAttachment = await compressImage(editFileInput.files[0]);
              } catch(e) {
                  alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ");
                  saveEdit.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                  return;
              }
          }

          const upd = { 
            startDate: editStart.value, 
            endDate: editEnd.value, 
            leaveDays: editDays.value, 
            halfDayPeriod: document.getElementById('editHalfDayPeriod').value || '',
            submitDate: cache[idx].submitDate,
            attachment: newAttachment
            };
          
          const fullRow = { ...cache[idx], ...upd };
          const { ok, errors, warnings, value } = validateRow(fullRow);
          
          if(!ok){ showToast('‚ùå ' + errors.join(' | '), 'error'); return; }
          
          try{ 
              await driver.update(id, value); 
              editModal.style.display='none'; 
              
              if(warnings.length > 0){
                  showToast(`‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‚ö†Ô∏è ${warnings.join(' | ')})`, 'warning');
              } else {
                  showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success'); 
              }
          }
          catch(err){ showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err), 'error'); }
          finally { saveEdit.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; }
        };
        cancelEdit.onclick = ()=>{ editModal.style.display='none'; };
      }

      if(action==='delete'){
        passwordModal.style.display='block'; hrPasswordInput.value='';
        confirmDelete.onclick = async ()=>{
          if(hrPasswordInput.value !== HR_PASSWORD){ showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); return; }
          try{ await driver.remove(id); passwordModal.style.display='none'; showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success'); }
          catch(err){ showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + explainFirestoreError(err), 'error'); }
        };
        cancelDelete.onclick = ()=>{ passwordModal.style.display='none'; };
      }
    });

    function csvEscape(value){ const s = String(value ?? '').replace(/"/g,'""'); return '"' + s + '"'; }
    function generateCSV(data){
     const rows = [[
  '‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡πÅ‡∏ú‡∏ô‡∏Å','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤','‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö',
  '‡πÄ‡∏£‡∏¥‡πà‡∏°','‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô','‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤',
  '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤','‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á'
]];
      data.forEach(r=>{ 
        const hasFile = r.attachment ? "‡∏°‡∏µ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå" : "‡πÑ‡∏°‡πà‡∏°‡∏µ";
        rows.push([
  r.empId||'',
  r.empName||'',
  r.department||'',      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  r.leaveType||'',
  hasFile,
  r.startDate||'',
  r.endDate||'',
  r.leaveDays||'',
  r.reason||'',
  r.approver||'',
  r.submitDate||'',
  r.systemTime||''
]);
      return rows.map(cols => cols.map(csvEscape).join(',')).join('\n');
    }

    downloadCSVBtn.addEventListener('click', async ()=>{
      try {
          csvLoading.classList.remove('hidden');
          downloadCSVBtn.disabled = true;
          const allData = await driver.getAll();
          const csv = generateCSV(allData);
          const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'leave-requests-all.csv'; a.click(); URL.revokeObjectURL(url);
      } catch(e){
          console.error(e);
          showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } finally {
          csvLoading.classList.add('hidden');
          downloadCSVBtn.disabled = false;
      }
    });
  </script>
</body>
</html>















