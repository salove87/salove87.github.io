<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการใช้รถ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .btn-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            box-shadow: 0 10px 15px -3px rgba(45, 212, 191, 0.3), 0 4px 6px -4px rgba(45, 212, 191, 0.2);
            transform: translateY(-2px);
        }
        .btn-delete {
            transition: all 0.2s;
        }
        .btn-delete:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        .log-table {
            border-collapse: separate;
            border-spacing: 0 8px; /* Add space between rows */
        }
        .log-table th, .log-table td {
            padding: 12px 16px;
        }
        /* Mobile-specific table adjustments */
        @media (max-width: 768px) {
            .log-table th, .log-table td {
                padding: 8px 10px;
                font-size: 0.875rem; /* Smaller font on mobile */
            }
            .log-table thead {
                display: none; /* Hide header on mobile for card layout */
            }
            .log-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }
            .log-table td {
                display: flex;
                justify-content: space-between;
                border-bottom: 1px solid #f3f4f6;
            }
            .log-table td:before {
                /* Add label text using data attributes */
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563;
            }
            .log-table td:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ระบบบันทึกการใช้รถ</h1>
        <p class="text-center text-sm text-gray-500 mb-4" id="auth-status">กำลังเชื่อมต่อ...</p>

        <!-- Form Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-teal-600 mb-4">บันทึกการใช้รถใหม่</h2>
            <form id="car-log-form">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Vehicle Selection -->
                    <div>
                        <label for="vehicle" class="block text-sm font-medium text-gray-700 mb-1">เลือกรถยนต์</label>
                        <select id="vehicle" name="vehicle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            <option value="">-- เลือกรถ --</option>
                            <option value="Nissan Almera">นิสสัน อเมร่า (Nissan Almera)</option>
                            <option value="EV">รถยนต์ไฟฟ้า (EV)</option>
                        </select>
                    </div>

                    <!-- User Name -->
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้งาน</label>
                        <input type="text" id="userName" name="userName" required placeholder="เช่น สมหญิง / User ID"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>

                    <!-- Odometer Out -->
                    <div>
                        <label for="odometerOut" class="block text-sm font-medium text-gray-700 mb-1">เลขไมค์ ขาออก (กม.)</label>
                        <input type="number" id="odometerOut" name="odometerOut" required min="0" step="1" placeholder="ตัวเลขเท่านั้น"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>

                    <!-- Odometer In -->
                    <div>
                        <label for="odometerIn" class="block text-sm font-medium text-gray-700 mb-1">เลขไมค์ ขาเข้า (กม.)</label>
                        <input type="number" id="odometerIn" name="odometerIn" required min="0" step="1" placeholder="ตัวเลขเท่านั้น"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div id="form-message" class="mt-3 text-sm font-medium text-red-500 hidden"></div>

                <!-- Submit Button -->
                <button type="submit"
                        class="btn-primary w-full mt-6 bg-teal-500 text-white p-3 rounded-lg font-semibold hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                    บันทึกข้อมูลการใช้รถ
                </button>
            </form>
        </div>

        <!-- Utility Buttons -->
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
            <button id="delete-latest-btn" disabled
                    class="btn-delete w-full sm:w-1/2 bg-red-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">
                ลบรายการล่าสุด (Delete Latest)
            </button>
            <button id="download-btn" disabled
                    class="btn-primary w-full sm:w-1/2 bg-blue-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                ดาวน์โหลดข้อมูล (CSV)
            </button>
        </div>


        <!-- Records Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">รายการบันทึกล่าสุด</h2>

            <div class="overflow-x-auto">
                <table class="log-table w-full text-left text-gray-600">
                    <thead class="bg-gray-50 text-xs uppercase text-gray-500 rounded-lg">
                        <tr>
                            <th scope="col" class="rounded-l-lg">วันที่/เวลา</th>
                            <th scope="col">รถยนต์</th>
                            <th scope="col">ผู้ใช้งาน</th>
                            <th scope="col">ไมค์ออก</th>
                            <th scope="col">ไมค์เข้า</th>
                            <th scope="col" class="rounded-r-lg">ระยะทาง (กม.)</th>
                        </tr>
                    </thead>
                    <tbody id="log-list">
                        <tr><td colspan="6" class="text-center py-8">ไม่มีรายการบันทึก</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Loading/Empty State -->
            <div id="loading-state" class="text-center py-4 text-gray-500 hidden">กำลังโหลดข้อมูล...</div>
        </div>

        <!-- Custom Modal for Messages (Instead of alert/confirm) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <div class="flex justify-end space-x-2">
                    <button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ปิด</button>
                </div>
            </div>
        </div>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: The global variables __app_id, __firebase_config, and __initial_auth_token are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // User's provided configuration (Hardcoded as per request)
        const userProvidedConfig = {
            apiKey: "AIzaSyDKfJvn9yh-g1J5OMA9EBLEyp740b-NyH4",
            authDomain: "vehicle-mileage-31238.firebaseapp.com",
            projectId: "vehicle-mileage-31238",
            storageBucket: "vehicle-mileage-31238.firebasestorage.app",
            messagingSenderId: "968556830605",
            appId: "1:968556830605:web:4708cecdbfc44737c267c4",
            measurementId: "G-42QZMXH8VF"
        };
        // Use the user's config, overriding the environment's config.
        const firebaseConfig = userProvidedConfig; 
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore configuration
        let db;
        let auth;
        let userId = null;
        let vehicleLogsRef;
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/vehicle_logs`;

        // UI elements
        const form = document.getElementById('car-log-form');
        const logList = document.getElementById('log-list');
        const authStatus = document.getElementById('auth-status');
        const deleteLatestBtn = document.getElementById('delete-latest-btn');
        const downloadBtn = document.getElementById('download-btn');
        const loadingState = document.getElementById('loading-state');
        const formMessage = document.getElementById('form-message');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');

        // --- Utility Functions ---

        /** Shows a custom modal message instead of using alert() */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });


        /** Converts Firestore Timestamp to a readable Thai date/time string */
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'ไม่ระบุ';
            const date = timestamp.toDate();
            const options = {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false,
                timeZone: 'Asia/Bangkok'
            };
            return date.toLocaleTimeString('th-TH', options);
        }

        // --- Firebase Initialization and Authentication ---

        async function initFirebase() {
            try {
                setLogLevel('debug'); // *** ACTIVE DEBUG LOGGING ***
                console.log("[Firebase] Starting initialization with config:", firebaseConfig.projectId);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("[Firebase] Firestore and Auth services initialized.");

                // Set up authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`[Firebase] Auth SUCCESS. User ID: ${userId.substring(0, 8)}...`);
                        authStatus.textContent = `เชื่อมต่อแล้ว (User ID: ${userId.substring(0, 8)}...)`;
                        vehicleLogsRef = collection(db, COLLECTION_PATH);
                        
                        // Start listening for logs only after auth is ready
                        listenForLogs();
                        
                        // Enable utility buttons
                        deleteLatestBtn.disabled = false;
                        downloadBtn.disabled = false;

                    } else {
                        console.log("[Firebase] Auth status changed: No user (waiting for signIn attempt).");
                        // User is signed out, attempt sign-in
                        await signInUser();
                    }
                });

                // Initial sign-in attempt
                await signInUser();

            } catch (error) {
                console.error("[Firebase] Fatal Initialization failed:", error);
                authStatus.textContent = `ข้อผิดพลาดในการเชื่อมต่อ Firebase: ${error.code || error.message}`;
                showModal('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ โปรดตรวจสอบการตั้งค่า Firebase Console.');
            }
        }

        async function signInUser() {
            try {
                // *** FIX: Removed Custom Token check to resolve auth/custom-token-mismatch ***
                // Since a custom Firebase config is provided by the user, the environment's 
                // initialAuthToken is invalid. We proceed directly to anonymous sign-in 
                // which satisfies the need for an authenticated user (request.auth != null).
                
                console.log("[Firebase] Attempting signInAnonymously (Skipping Custom Token due to user's config)...");
                await signInAnonymously(auth);
                authStatus.textContent = 'ลงชื่อเข้าใช้แบบไม่ระบุตัวตน...';
                
            } catch (error) {
                console.error("[Firebase] Authentication failed:", error);
                authStatus.textContent = `การยืนยันตัวตนล้มเหลว: ${error.message}`;
                // Show modal only if authentication (not init) failed
                showModal('ข้อผิดพลาดในการเข้าสู่ระบบ', `ไม่สามารถยืนยันตัวตนได้: ${error.message} โปรดตรวจสอบ Firebase Authentication.`);
            }
        }

        // --- Data Handling ---

        /** Renders the list of vehicle logs to the UI table. */
        function renderLogs(logs) {
            loadingState.classList.add('hidden');
            logList.innerHTML = '';
            
            if (logs.length === 0) {
                logList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">ไม่มีรายการบันทึก</td></tr>';
                deleteLatestBtn.disabled = true;
                downloadBtn.disabled = true;
                return;
            }

            deleteLatestBtn.disabled = false;
            downloadBtn.disabled = false;

            logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-50 hover:bg-gray-100 transition duration-150 ease-in-out border-b border-gray-200';
                
                // Calculate distance
                const distance = (log.odometerIn && log.odometerOut) ? Math.max(0, log.odometerIn - log.odometerOut) : 0;
                
                tr.innerHTML = `
                    <td data-label="วันที่/เวลา" class="font-medium text-gray-900">${formatTimestamp(log.timestamp)}</td>
                    <td data-label="รถยนต์" class="font-semibold text-teal-700">${log.vehicle}</td>
                    <td data-label="ผู้ใช้งาน">${log.userName}</td>
                    <td data-label="ไมค์ออก" class="text-right">${log.odometerOut.toLocaleString()}</td>
                    <td data-label="ไมค์เข้า" class="text-right">${log.odometerIn.toLocaleString()}</td>
                    <td data-label="ระยะทาง (กม.)" class="font-bold text-blue-600 text-right">${distance.toLocaleString()}</td>
                `;
                logList.appendChild(tr);
            });
        }

        /** Sets up real-time listener for the vehicle logs. */
        function listenForLogs() {
            if (!db || !userId) {
                console.warn("[Firebase] Cannot listen for logs: DB or UserID is missing.");
                return;
            }

            loadingState.classList.remove('hidden');
            console.log(`[Firebase] Attaching real-time listener for collection: ${COLLECTION_PATH}`);

            // Query: ordered by timestamp (descending) for "Latest Records" view
            const q = query(
                vehicleLogsRef,
                orderBy('timestamp', 'desc'),
                limit(20) // Show up to 20 latest records
            );

            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach((doc) => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                renderLogs(logs);
            }, (error) => {
                console.error("[Firebase] Error listening to logs:", error);
                showModal('ข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลบันทึกการใช้รถได้');
            });
        }

        // --- Event Handlers ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            formMessage.classList.add('hidden');

            if (!db || !userId) {
                // This is the check that triggers the modal shown in the image
                console.error("[Submit] Database not ready: db=", db, "userId=", userId);
                showModal('ข้อผิดพลาด', 'ฐานข้อมูลยังไม่พร้อมใช้งาน โปรดรอสักครู่');
                return;
            }

            const vehicle = document.getElementById('vehicle').value;
            const userName = document.getElementById('userName').value.trim();
            const odometerOut = parseInt(document.getElementById('odometerOut').value, 10);
            const odometerIn = parseInt(document.getElementById('odometerIn').value, 10);

            if (!vehicle || !userName || isNaN(odometerOut) || isNaN(odometerIn)) {
                formMessage.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน';
                formMessage.classList.remove('hidden');
                return;
            }

            if (odometerIn < odometerOut) {
                formMessage.textContent = 'เลขไมค์ขาเข้า ต้องมากกว่าหรือเท่ากับ เลขไมค์ขาออกเสมอ';
                formMessage.classList.remove('hidden');
                return;
            }
            
            // Disable button during submission
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'กำลังบันทึก...';

            try {
                const newLog = {
                    vehicle,
                    userName,
                    odometerOut,
                    odometerIn,
                    distance: odometerIn - odometerOut,
                    timestamp: serverTimestamp(), // Use server timestamp for ordering
                    userId: userId, // Record who created the entry
                };

                await addDoc(vehicleLogsRef, newLog);
                
                showModal('สำเร็จ!', 'บันทึกข้อมูลการใช้รถเรียบร้อยแล้ว');
                form.reset(); // Clear the form on successful submission

            } catch (error) {
                console.error("[Firebase] Error adding document: ", error);
                formMessage.textContent = `ข้อผิดพลาดในการบันทึก: ${error.message}`;
                formMessage.classList.remove('hidden');
                // Show more detailed error for database write failure
                showModal('ข้อผิดพลาดในการบันทึก', `ไม่สามารถบันทึกข้อมูลได้: ${error.message} โปรดตรวจสอบ Firebase Security Rules.`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'บันทึกข้อมูลการใช้รถ';
            }
        });

        deleteLatestBtn.addEventListener('click', async () => {
            if (!db || !userId) return;

            // Simple confirmation modal logic (no user action needed for now, but a good practice to show this message)
            showModal('ยืนยันการลบ', 'คุณต้องการลบรายการบันทึกที่ล่าสุดใช่หรือไม่?');

            deleteLatestBtn.disabled = true;
            const originalText = deleteLatestBtn.textContent;
            deleteLatestBtn.textContent = 'กำลังลบ...';

            try {
                // 1. Query the latest document (order by timestamp descending, limit 1)
                const q = query(vehicleLogsRef, orderBy('timestamp', 'desc'), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showModal('ไม่พบข้อมูล', 'ไม่พบรายการบันทึกใดๆ ที่จะลบ');
                    return;
                }

                // 2. Get the document ID of the latest log
                const latestDoc = querySnapshot.docs[0];
                const docId = latestDoc.id;

                // 3. Delete the document
                await deleteDoc(doc(db, COLLECTION_PATH, docId));

                showModal('สำเร็จ!', `รายการล่าสุด (${latestDoc.data().userName} / ${docId.substring(0, 8)}...) ถูกลบแล้ว`);

            } catch (error) {
                console.error("Error deleting document: ", error);
                showModal('ข้อผิดพลาด', `ไม่สามารถลบรายการได้: ${error.message}`);
            } finally {
                deleteLatestBtn.disabled = false;
                deleteLatestBtn.textContent = originalText;
            }
        });

        downloadBtn.addEventListener('click', async () => {
            if (!db || !userId) return;
            
            downloadBtn.disabled = true;
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'กำลังเตรียมไฟล์...';

            try {
                // 1. Fetch ALL data (ordered by timestamp ascending for chronological CSV)
                const q = query(vehicleLogsRef, orderBy('timestamp', 'asc'));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showModal('ไม่มีข้อมูล', 'ไม่มีข้อมูลบันทึกให้ดาวน์โหลด');
                    return;
                }

                const logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push(doc.data());
                });

                // 2. Prepare CSV data
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM for Thai characters
                const headers = ["ID บันทึก", "วันที่/เวลา", "รถยนต์", "ผู้ใช้งาน", "ไมค์ออก (กม.)", "ไมค์เข้า (กม.)", "ระยะทาง (กม.)"];
                csvContent += headers.join(",") + "\r\n";

                logs.forEach(log => {
                    const timestampStr = formatTimestamp(log.timestamp);
                    const distance = log.odometerIn - log.odometerOut;
                    
                    const row = [
                        log.userId.substring(0, 8), // Use a snippet of the ID for simplicity
                        `"${timestampStr}"`, // Wrap in quotes to handle commas/spaces
                        `"${log.vehicle}"`,
                        `"${log.userName}"`,
                        log.odometerOut,
                        log.odometerIn,
                        distance
                    ];
                    csvContent += row.join(",") + "\r\n";
                });

                // 3. Create and trigger download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `car_logbook_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showModal('ดาวน์โหลดสำเร็จ!', 'ไฟล์ CSV ถูกดาวน์โหลดไปยังเครื่องของคุณแล้ว');

            } catch (error) {
                console.error("Error downloading data: ", error);
                showModal('ข้อผิดพลาด', `ไม่สามารถดาวน์โหลดข้อมูลได้: ${error.message}`);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }
        });


        // --- Start Application ---
        initFirebase();

    </script>
</body>
</html>
