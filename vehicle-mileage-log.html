<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .btn-primary { transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);} 
        .btn-primary:hover { box-shadow: 0 10px 15px -3px rgba(45,212,191,0.3), 0 4px 6px -4px rgba(45,212,191,0.2); transform: translateY(-2px); }
        .btn-delete { transition: all 0.2s; }
        .btn-delete:hover { transform: scale(1.05); opacity: 0.9; }
        .log-table { border-collapse: separate; border-spacing: 0 8px; }
        .log-table th, .log-table td { padding: 12px 16px; }
        .action-btn { padding:6px 8px; border-radius:6px; font-size:0.875rem; }
        .action-edit { background:#fff7ed; color:#92400e; border:1px solid #fcd34d; }
        .action-delete { background:#fff1f2; color:#9f1239; border:1px solid #fecaca; }
        .warning { color:#92400e; background:#fff7ed; padding:8px; border-radius:6px; }
        .badge { display:inline-block; background:#e6fffa; color:#0f766e; padding:6px 10px; border-radius:8px; font-weight:600; margin-right:8px; }
        /* Responsive Table */
        @media (max-width: 768px) {
            .log-table th, .log-table td { padding: 8px 10px; font-size: 0.875rem; }
            .log-table thead { display: none; }
            .log-table tbody tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .log-table td { display:flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6; }
            .log-table td:before { content: attr(data-label); font-weight: 600; color: #4b5563; }
            .log-table td:last-child { border-bottom: none; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</h1>
    <!-- üîî ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ -->
<div class="mb-6 rounded-xl border border-orange-300 bg-orange-50 p-4 shadow-sm">
  <div class="flex items-start gap-3">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M13 16h-1v-4h-1m1-4h.01M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>

    <div>
      <p class="font-semibold text-orange-800">
        ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö
      </p>
      <p class="text-sm text-orange-700 mt-1">
        ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå <span class="font-semibold">‡∏ô‡∏¥‡∏™‡∏™‡∏±‡∏ô (Nissan Almera)</span>
        ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á
        <br class="hidden sm:block">
        ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠ <span class="font-semibold">‡∏á‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</span>
        ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </p>
    </div>
  </div>
</div>
    <p id="auth-status" class="text-center text-sm text-gray-500 mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>

    <div id="current-date-time" class="text-center text-sm font-semibold text-teal-700 mb-6 p-2 bg-teal-50 rounded-lg shadow-inner"></div>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold text-teal-600 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h2>
        <form id="car-log-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="vehicle" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</label>
                    <select id="vehicle" name="vehicle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>
                        <option value="Nissan Almera">‡∏ô‡∏¥‡∏™‡∏™‡∏±‡∏ô ‡∏≠‡πÄ‡∏°‡∏£‡πà‡∏≤ (Nissan Almera)</option>
                        <option value="EV">‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (EV)</option>
                    </select>
                    <div id="last-odom-display" class="mt-2 text-sm text-gray-600"></div>
                </div>

                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                    <input id="userName" name="userName" type="text" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á / User ID" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                </div>

                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <select id="department" name="department" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                        <option>‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                        <option>‡∏°‡∏¥‡∏•‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢</option>
                        <option>‡∏ô‡∏¥‡∏ß‡πÇ‡∏°‡πÄ‡∏î‡∏•</option>
                        <option>‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï 1</option>
                        <option>‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï 2</option>
                        <option>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (QA)</option>
                        <option>‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                        <option>‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
                        <option>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</option>
                        <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
                        <option>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                        <option>‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
                        <option>‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• / HR</option>
                        <option>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</option>
                        <option>‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠</option>
                    </select>
                </div>

                <div>
                    <label for="easyPass" class="block text-sm font-medium text-gray-700 mb-1">Easy Pass ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</label>
                    <input id="easyPass" name="easyPass" type="number" step="0.25" min="0" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 120.50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                </div>

                <div class="md:col-span-2">
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Location)</label>
                    <input id="location" name="location" type="text" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø > ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà / ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                </div>

                <div>
                    <label for="odometerOut" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå ‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡∏Å‡∏°.)</label>
                    <input id="odometerOut" name="odometerOut" type="number" required min="0" step="1" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                    <p id="odometer-out-hint" class="text-xs text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                </div>

                <div>
                    <label for="odometerIn" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå ‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏Å‡∏°.)</label>
                    <input id="odometerIn" name="odometerIn" type="number" required min="0" step="1" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                    <p id="odometer-in-hint" class="text-xs text-gray-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ</p>
                </div>

            </div>

            <div id="form-message" class="mt-3 text-sm font-medium text-red-500 hidden"></div>

            <button type="submit" id="submit-btn" class="btn-primary w-full mt-6 bg-teal-500 text-white p-3 rounded-lg font-semibold hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</button>
        </form>
    </div>

    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
        <button id="delete-latest-btn" disabled class="btn-delete w-full sm:w-1/2 bg-red-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Delete Latest)</button>
        <button id="download-btn" disabled class="btn-primary w-full sm:w-1/2 bg-blue-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CSV)</button>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        <div class="overflow-x-auto">
            <table class="log-table w-full text-left text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase text-gray-500 rounded-lg">
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</th>
                        <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>Easy Pass (‡∏ö‡∏≤‡∏ó)</th>
                        <th>‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å</th>
                        <th>‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
                        <th class="rounded-r-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="log-list"><tr><td colspan="10" class="text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr></tbody>
            </table>
        </div>
        <div id="loading-state" class="text-center py-4 text-gray-500 hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div class="text-center mt-4">
            <button id="load-more-btn" class="px-4 py-2 bg-teal-100 text-teal-700 rounded-lg border border-teal-200 hover:bg-teal-200">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-2"><button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">‡∏õ‡∏¥‡∏î</button></div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
    apiKey: "AIzaSyDKfJvn9yh-g1J5OMA9EBLEyp740b-NyH4",
    authDomain: "vehicle-mileage-31238.firebaseapp.com",
    projectId: "vehicle-mileage-31238",
    storageBucket: "vehicle-mileage-31238.firebasestorage.app",
    messagingSenderId: "968556830605",
    appId: "1:968556830605:web:4708cecdbfc44737c267c4",
    measurementId: "G-42QZMXH8VF"
};

const COLLECTION_PATH = `/artifacts/${appId}/public/data/vehicle_logs`;
let db, auth, userId = null, vehicleLogsRef;
let unsubscribe = null, displayLimit = 20;

let lastOdometers = { 'Nissan Almera': 77634, 'EV': 3045 };
const USE_MOCK = false; // connected to Firebase now
const MOCK_LOGS = [
    { id: 'mock1', vehicle: 'Nissan Almera', userName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢', department: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', location: '‡∏Å‡∏ó‡∏°. > ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', easyPass: 50.00, odometerOut: 77634, odometerIn: 77690, clientTimestamp: new Date().toISOString() },
    { id: 'mock2', vehicle: 'EV', userName: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á', department: '‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î', location: '‡∏Å‡∏ó‡∏°. > ‡∏£‡∏∞‡∏¢‡∏≠‡∏á', easyPass: 0.00, odometerOut: 3045, odometerIn: 3100, clientTimestamp: new Date(Date.now()-3600*1000).toISOString() }
];

// Elements
const form = document.getElementById('car-log-form');
const logList = document.getElementById('log-list');
const authStatus = document.getElementById('auth-status');
const deleteLatestBtn = document.getElementById('delete-latest-btn');
const downloadBtn = document.getElementById('download-btn');
const loadingState = document.getElementById('loading-state');
const formMessage = document.getElementById('form-message');
const modal = document.getElementById('custom-modal');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalClose = document.getElementById('modal-close');
const currentDateTimeDiv = document.getElementById('current-date-time');
const loadMoreBtn = document.getElementById('load-more-btn');
const vehicleSelect = document.getElementById('vehicle');
const odometerOutInput = document.getElementById('odometerOut');
const odometerInInput = document.getElementById('odometerIn');
const odometerOutHint = document.getElementById('odometer-out-hint');
const odometerInHint = document.getElementById('odometer-in-hint');
const submitBtn = document.getElementById('submit-btn');
const lastOdomDisplay = document.getElementById('last-odom-display');

function showModal(title, message) { modalTitle.textContent = title; modalMessage.textContent = message; modal.classList.remove('hidden'); }
modalClose.addEventListener('click', () => modal.classList.add('hidden'));
function safeParseDate(v){ if(!v) return null; try{ const d=new Date(v); return isNaN(d)?null:d }catch(e){return null} }
function formatTimestamp(timestamp){ if(!timestamp) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; try{ if(typeof timestamp==='string'){ const d=safeParseDate(timestamp); if(d) return d.toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Asia/Bangkok'}); } if(timestamp && typeof timestamp.toDate==='function'){ const d=timestamp.toDate(); return d.toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Asia/Bangkok'}); } if(timestamp instanceof Date){ return timestamp.toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Asia/Bangkok'}); } }catch(e){console.warn('formatTimestamp failed',e,timestamp)} return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; }
function updateDateTimeDisplay(){ const now=new Date(); const options={weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Bangkok'}; currentDateTimeDiv.textContent=`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏£‡∏∞‡∏ö‡∏ö): ${now.toLocaleString('th-TH',options)} (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)` }
updateDateTimeDisplay(); setInterval(updateDateTimeDisplay,1000);

// Update the lastOdometers from a list of logs (take the max odometerIn per vehicle)
function recomputeLastOdometersFromLogs(logs){ const map = {}; logs.forEach(l=>{ if(!l || !l.vehicle) return; const inKm = Number(l.odometerIn) || 0; if(!(l.vehicle in map) || inKm > map[l.vehicle]) map[l.vehicle] = inKm; }); // fill defaults if missing
    ['Nissan Almera','EV'].forEach(v=>{ if(!(v in map)) map[v] = lastOdometers[v] || 0; }); lastOdometers = map; updateLastOdomDisplay(); }

function updateLastOdomDisplay(){ // show the current recorded last odometers
    const parts = [];
    for(const [k,v] of Object.entries(lastOdometers)){
        parts.push(`${k}: ${Number(v).toLocaleString('th-TH')} ‡∏Å‡∏°.`);
    }
    lastOdomDisplay.textContent = parts.join(' ‚Ä¢ ');
}
updateLastOdomDisplay();

function renderLogs(logs){ loadingState.classList.add('hidden'); logList.innerHTML=''; if(!logs||logs.length===0){ logList.innerHTML='<tr><td colspan="10" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>'; deleteLatestBtn.disabled=true; downloadBtn.disabled=true; return; } deleteLatestBtn.disabled=false; downloadBtn.disabled=false;
    // recompute last odometers so UI reflects newest saved data
    recomputeLastOdometersFromLogs(logs);

    function getLogTime(item){ try{ if(item&&item.timestamp&&typeof item.timestamp.toDate==='function') return item.timestamp.toDate().getTime(); if(item&&item.clientTimestamp){ const d=safeParseDate(item.clientTimestamp); if(d) return d.getTime(); const n=new Date(item.clientTimestamp); if(!isNaN(n)) return n.getTime(); } }catch(e){} return 0; }
    logs.sort((a,b)=>getLogTime(b)-getLogTime(a));

    logs.forEach(log=>{ const tr=document.createElement('tr'); tr.className='bg-gray-50 hover:bg-gray-100 transition duration-150 ease-in-out border-b border-gray-200'; const distance=(Number.isFinite(log.odometerIn)&&Number.isFinite(log.odometerOut))?Math.max(0,log.odometerIn-log.odometerOut):0; const easyPass=(log.easyPass!==undefined&&log.easyPass!==null)?Number(log.easyPass).toFixed(2):'-'; const ts=log.timestamp||log.clientTimestamp||null; const tsDisplay=formatTimestamp(ts);
        // action buttons: edit / delete
        const editBtn = `<button class="action-btn action-edit" data-id="${log.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`;
        const delBtn = `<button class="action-btn action-delete ml-2" data-id="${log.id}">‡∏•‡∏ö</button>`;
        tr.innerHTML=`<td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤" class="font-medium text-gray-900">${tsDisplay}</td><td data-label="‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå" class="font-semibold text-teal-700">${log.vehicle||''}</td><td data-label="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">${log.userName||''}</td><td data-label="‡πÅ‡∏ú‡∏ô‡∏Å">${log.department||'-'}</td><td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">${log.location||'-'}</td><td data-label="Easy Pass" class="text-right">${easyPass}</td><td data-label="‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å" class="text-right">${(log.odometerOut??'').toLocaleString('th-TH')}</td><td data-label="‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏Ç‡πâ‡∏≤" class="text-right">${(log.odometerIn??'').toLocaleString('th-TH')}</td><td data-label="‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)" class="font-bold text-blue-600 text-right">${distance.toLocaleString('th-TH')}</td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" class="text-right">${editBtn}${delBtn}</td>`;
        logList.appendChild(tr);
    });

    // Attach event listeners for newly created buttons
    document.querySelectorAll('.action-delete').forEach(btn=>{ btn.addEventListener('click', async (e)=>{ const id = btn.getAttribute('data-id'); if(!id) return; const confirmed = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?'); if(!confirmed) return; try{ if(USE_MOCK){ const idx = MOCK_LOGS.findIndex(x=>String(x.id)===String(id)); if(idx>=0){ MOCK_LOGS.splice(idx,1); renderLogs(MOCK_LOGS); showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } } else { await deleteDoc(doc(db, COLLECTION_PATH, id)); showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } } catch(err){ console.error('delete failed',err); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ: ${err.message}`); } }); });

    document.querySelectorAll('.action-edit').forEach(btn=>{ btn.addEventListener('click', async (e)=>{ const id = btn.getAttribute('data-id'); if(!id) return; // find record
            let record = null;
            if(USE_MOCK) record = MOCK_LOGS.find(x=>String(x.id)===String(id));
            else {
                // fetch single doc
                try{ const q = query(collection(db, COLLECTION_PATH), orderBy('timestamp','desc'), limit(displayLimit)); // fallback if needed
                }catch(e){}
            }
            // Build simple edit modal
            const editModal = document.createElement('div'); editModal.className='fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[9999]';
            editModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (ID: ${id.substring(0,8)})</h3>
                    <div class="space-y-2">
                        <label class="block text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                        <input id="edit-user" class="w-full p-2 border rounded" value="${(record?.userName)||''}" />
                        <label class="block text-sm">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input id="edit-dept" class="w-full p-2 border rounded" value="${(record?.department)||''}" />
                        <label class="block text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input id="edit-loc" class="w-full p-2 border rounded" value="${(record?.location)||''}" />
                        <label class="block text-sm">Easy Pass</label>
                        <input id="edit-easy" type="number" step="0.25" class="w-full p-2 border rounded" value="${(record?.easyPass)||''}" />
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-sm">‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å</label><input id="edit-out" type="number" class="w-full p-2 border rounded" value="${(record?.odometerOut)||''}" /></div>
                            <div><label class="block text-sm">‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏Ç‡πâ‡∏≤</label><input id="edit-in" type="number" class="w-full p-2 border rounded" value="${(record?.odometerIn)||''}" /></div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2"><button id="cancel-edit" class="px-4 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="save-edit" class="px-4 py-2 bg-teal-500 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                </div>
            `;
            document.body.appendChild(editModal);
            document.getElementById('cancel-edit').onclick = ()=>{ editModal.remove(); };
            document.getElementById('save-edit').onclick = async ()=>{
                const newUser = document.getElementById('edit-user').value.trim();
                const newDept = document.getElementById('edit-dept').value.trim();
                const newLoc = document.getElementById('edit-loc').value.trim();
                const newEasy = parseFloat(document.getElementById('edit-easy').value) || 0;
                const newOut = parseInt(document.getElementById('edit-out').value,10);
                const newIn = parseInt(document.getElementById('edit-in').value,10);
                if(isNaN(newOut) || isNaN(newIn)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡∏Ñ‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
                if(newIn < newOut){ alert('‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á >= ‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å'); return; }
                try{
                    if(USE_MOCK){ const idx = MOCK_LOGS.findIndex(x=>String(x.id)===String(id)); if(idx>=0){ MOCK_LOGS[idx] = { ...MOCK_LOGS[idx], userName:newUser, department:newDept, location:newLoc, easyPass:newEasy, odometerOut:newOut, odometerIn:newIn }; renderLogs(MOCK_LOGS); }
                    } else {
                        await updateDoc(doc(db, COLLECTION_PATH, id), { userName:newUser, department:newDept, location:newLoc, easyPass:newEasy, odometerOut:newOut, odometerIn:newIn, clientTimestamp:new Date().toISOString() });
                    }
                    editModal.remove(); showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } catch(err){ console.error('update failed',err); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ: ${err.message}`); }
            };
    }); });
}

// Firebase init + auth
async function initFirebase(){ try{ setLogLevel('debug'); const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
        onAuthStateChanged(auth, async (user)=>{ if(user){ userId = user.uid; authStatus.textContent = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (User ID: ${userId.substring(0,8)}...)`; vehicleLogsRef = collection(db, COLLECTION_PATH); listenForLogs(); deleteLatestBtn.disabled=false; downloadBtn.disabled=false; } else { await signInUser(); } });
        await signInUser(); } catch(err){ authStatus.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase: ${err.message || err.code}`; showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Console.'); } }

async function signInUser(){ try{ await signInAnonymously(auth); authStatus.textContent = '‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...'; } catch(err){ authStatus.textContent = `‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`; showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ: ${err.message}`); } }

function listenForLogs(){ if(!db) return; loadingState.classList.remove('hidden'); if(typeof unsubscribe === 'function') unsubscribe(); try{ const q = query(collection(db, COLLECTION_PATH), orderBy('timestamp','desc'), limit(displayLimit)); unsubscribe = onSnapshot(q, (snapshot)=>{ const logs = []; snapshot.forEach(docSnap=>logs.push({ id: docSnap.id, ...docSnap.data() })); renderLogs(logs); if(snapshot.size < displayLimit) loadMoreBtn.classList.add('hidden'); else loadMoreBtn.classList.remove('hidden'); }, (err)=>{ console.error('Firestore listen failed:', err); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÑ‡∏î‡πâ'); loadingState.classList.add('hidden'); }); } catch(err){ console.error('listenForLogs error', err); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${err.message || err}`); loadingState.classList.add('hidden'); } }

loadMoreBtn.addEventListener('click', ()=>{ displayLimit += 20; loadMoreBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...'; loadMoreBtn.disabled = true; listenForLogs(); setTimeout(()=>{ loadMoreBtn.disabled = false; loadMoreBtn.textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'; }, 800); });

// Validation utilities
function showFormError(message){ formMessage.textContent = message; formMessage.classList.remove('hidden'); }
function hideFormError(){ formMessage.textContent = ''; formMessage.classList.add('hidden'); }

vehicleSelect.addEventListener('change', ()=>{ hideFormError(); const v = vehicleSelect.value; const last = lastOdometers[v] ?? null; if(last !== null){ odometerOutInput.placeholder = `‡πÄ‡∏ä‡πà‡∏ô ${last} (‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á ${v})`; odometerInInput.placeholder = `‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ${last}`; odometerOutHint.textContent = `‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ: ${last.toLocaleString('th-TH')} ‡∏Å‡∏°.`; odometerInHint.textContent = `‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏µ‡πà >= ‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ ${last.toLocaleString('th-TH')} ‡∏Å‡∏°.`; odometerOutInput.min = last; odometerInInput.min = last; } else { odometerOutInput.placeholder = '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'; odometerInInput.placeholder = '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'; odometerOutHint.textContent = '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; odometerInHint.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ'; odometerOutInput.removeAttribute('min'); odometerInInput.removeAttribute('min'); } updateLastOdomDisplay(); });

function validateOdometerFields(){ hideFormError(); const v = vehicleSelect.value; const last = lastOdometers[v] ?? null; const outVal = odometerOutInput.value ? parseInt(odometerOutInput.value,10) : NaN; const inVal = odometerInInput.value ? parseInt(odometerInInput.value,10) : NaN; if(isNaN(outVal) || isNaN(inVal)) return true; if(inVal < outVal){ showFormError('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å'); return false; } if(last !== null){ if(outVal < last || inVal < last){ showFormError(`‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${v} = ${last.toLocaleString('th-TH')} ‡∏Å‡∏°.) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`); return false; } } for(const [otherVehicle, otherLast] of Object.entries(lastOdometers)){ if(otherVehicle === v) continue; if(Math.abs(outVal - otherLast) <= 1000 || Math.abs(inVal - otherLast) <= 1000){ showFormError(`‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á ${otherVehicle} (‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${otherLast.toLocaleString('th-TH')} ‡∏Å‡∏°.) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`); return false; } } return true; }
odometerOutInput.addEventListener('input', validateOdometerFields);
odometerInInput.addEventListener('input', validateOdometerFields);

// Form submit
form.addEventListener('submit', async (e)=>{ e.preventDefault(); hideFormError(); if(!db && !USE_MOCK){ showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà'); return; }
    const vehicle = vehicleSelect.value; const userName = document.getElementById('userName').value.trim(); const department = document.getElementById('department').value.trim(); const location = document.getElementById('location').value.trim(); const odometerOut = odometerOutInput.value ? parseInt(odometerOutInput.value,10) : NaN; const odometerIn = odometerInInput.value ? parseInt(odometerInInput.value,10) : NaN; const easyPassVal = document.getElementById('easyPass').value; const easyPass = easyPassVal !== '' ? parseFloat(easyPassVal) : null;
    if(!vehicle || !userName || !department || !location || easyPassVal === '' || isNaN(odometerOut) || isNaN(odometerIn)) { showFormError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)'); return; }
    if(odometerIn < odometerOut) { showFormError('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏°‡∏≠'); return; }
    const last = lastOdometers[vehicle] ?? null; if(last !== null && (odometerOut < last || odometerIn < last)) { showFormError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ ${vehicle} (‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${last.toLocaleString('th-TH')} ‡∏Å‡∏°.)`); return; }
    for(const [otherVehicle, otherLast] of Object.entries(lastOdometers)){ if(otherVehicle === vehicle) continue; if(Math.abs(odometerOut - otherLast) <= 1000 || Math.abs(odometerIn - otherLast) <= 1000){ showFormError(`‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á ${otherVehicle} (‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${otherLast.toLocaleString('th-TH')} ‡∏Å‡∏°.) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`); return; } }
    submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    try{
        const newLog = { vehicle, userName, department, location, easyPass, odometerOut, odometerIn, distance: odometerIn - odometerOut, timestamp: serverTimestamp(), clientTimestamp: new Date().toISOString(), userId };
        if(USE_MOCK){ MOCK_LOGS.push({ id: `mock-${Date.now()}`, ...newLog }); renderLogs(MOCK_LOGS); }
        else { await addDoc(collection(db, COLLECTION_PATH), newLog); }
        showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); form.reset(); lastOdometers[vehicle] = Math.max(lastOdometers[vehicle] || 0, odometerIn); vehicleSelect.dispatchEvent(new Event('change'));
    } catch(err){ console.error('Firestore addDoc failed:', err); showFormError(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${err.message}`); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${err.message} ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules.`); } finally { submitBtn.disabled = false; submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ'; }
});

// Delete latest (keeps existing function)
deleteLatestBtn.addEventListener('click', async ()=>{
    if(!db && !USE_MOCK) return; deleteLatestBtn.disabled = true; const originalText = deleteLatestBtn.textContent; deleteLatestBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
    try{
        if(USE_MOCK){ if(MOCK_LOGS.length === 0){ showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö'); return; } const latest = MOCK_LOGS.pop(); renderLogs(MOCK_LOGS); showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${latest.userName} / ${String(latest.id).substring(0,8)}...) ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß`); }
        else {
            const q = query(collection(db, COLLECTION_PATH), orderBy('timestamp','desc'), limit(1)); const querySnapshot = await getDocs(q); if(querySnapshot.empty){ showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö'); return; } const latestDoc = querySnapshot.docs[0]; const docId = latestDoc.id;
            const confirmed = await new Promise(resolve => { const confirmModal = document.createElement('div'); confirmModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[9999]'; confirmModal.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full"><h3 class="text-xl font-bold mb-3 text-gray-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3><p class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢ ${latestDoc.data().userName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p><div class="flex justify-end space-x-2"><button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div>`; document.body.appendChild(confirmModal); document.getElementById('cancel-delete').onclick = ()=>{ confirmModal.remove(); resolve(false); }; document.getElementById('confirm-delete').onclick = ()=>{ confirmModal.remove(); resolve(true); }; });
            if(confirmed){ await deleteDoc(doc(db, COLLECTION_PATH, docId)); showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${latestDoc.data().userName} / ${docId.substring(0,8)}...) ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß`); } else { showModal('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'); }
        }
    } catch(err){ console.error('Firestore delete failed:', err); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ${err.message}`); } finally { deleteLatestBtn.disabled = false; deleteLatestBtn.textContent = originalText; }
});

// Download CSV (fixed BOM/newline)
downloadBtn.addEventListener('click', async ()=>{
    if(!db && !USE_MOCK) return; downloadBtn.disabled = true; const originalText = downloadBtn.textContent; downloadBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå...';
    try{
        let logs = [];
        if(USE_MOCK) logs = MOCK_LOGS.slice();
        else { const q = query(collection(db, COLLECTION_PATH), orderBy('timestamp','asc')); const querySnapshot = await getDocs(q); if(querySnapshot.empty){ showModal('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); downloadBtn.disabled = false; downloadBtn.textContent = originalText; return; } querySnapshot.forEach(docSnap => logs.push(docSnap.data())); }

        const headers = ["ID ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤","‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå","‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô","‡πÅ‡∏ú‡∏ô‡∏Å","‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà","Easy Pass (‡∏ö‡∏≤‡∏ó)","‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å (‡∏Å‡∏°.)","‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏Å‡∏°.)","‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)"];
        const rows = [headers];
        logs.forEach(log => {
            const timestampStr = formatTimestamp(log.timestamp || log.clientTimestamp);
            const distance = (log.odometerIn ?? 0) - (log.odometerOut ?? 0);
            const row = [ log.userId ? String(log.userId).substring(0,8) : (log.id ? String(log.id).substring(0,8) : '-'), timestampStr, log.vehicle ?? '', log.userName ?? '', log.department ?? '', log.location ?? '', (log.easyPass ?? ''), (log.odometerOut ?? ''), (log.odometerIn ?? ''), distance ];
            rows.push(row);
        });

        // Build CSV with BOM and CRLF safely
        const csvString = '\uFEFF' + rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a'); link.setAttribute('href', url); link.setAttribute('download', `car_logbook_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
        showModal('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß');
    } catch(err){ console.error('Download failed:', err); showModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${err.message}`); } finally { downloadBtn.disabled = false; downloadBtn.textContent = originalText; }
});

// Initialize
if(USE_MOCK){ renderLogs(MOCK_LOGS); authStatus.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: Mock data (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Firebase)'; deleteLatestBtn.disabled = false; downloadBtn.disabled = false; updateLastOdomDisplay(); } else { initFirebase(); }

</script>
</body>
</html>







