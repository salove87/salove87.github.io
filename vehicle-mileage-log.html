<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบบันทึกการใช้รถ</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .btn-primary { transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);} 
        .btn-primary:hover { box-shadow: 0 10px 15px -3px rgba(45,212,191,0.3), 0 4px 6px -4px rgba(45,212,191,0.2); transform: translateY(-2px); }
        .btn-delete { transition: all 0.2s; }
        .btn-delete:hover { transform: scale(1.05); opacity: 0.9; }
        .log-table { border-collapse: separate; border-spacing: 0 8px; }
        .log-table th, .log-table td { padding: 12px 16px; }
        /* Responsive Table */
        @media (max-width: 768px) {
            .log-table th, .log-table td { padding: 8px 10px; font-size: 0.875rem; }
            .log-table thead { display: none; }
            .log-table tbody tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .log-table td { display:flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6; }
            .log-table td:before { content: attr(data-label); font-weight: 600; color: #4b5563; }
            .log-table td:last-child { border-bottom: none; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ระบบบันทึกการใช้รถ</h1>
    <p id="auth-status" class="text-center text-sm text-gray-500 mb-4">กำลังเชื่อมต่อ...</p>

    <div id="current-date-time" class="text-center text-sm font-semibold text-teal-700 mb-6 p-2 bg-teal-50 rounded-lg shadow-inner"></div>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold text-teal-600 mb-4">บันทึกการใช้รถใหม่</h2>
        <form id="car-log-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="vehicle" class="block text-sm font-medium text-gray-700 mb-1">เลือกรถยนต์</label>
                    <select id="vehicle" name="vehicle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        <option value="">-- เลือกรถ --</option>
                        <option value="Nissan Almera">นิสสัน อเมร่า (Nissan Almera)</option>
                        <option value="EV">รถยนต์ไฟฟ้า (EV)</option>
                    </select>
                    <p id="vehicle-hint" class="text-xs text-gray-500 mt-1">หมายเหตุ: ระบบจะตรวจสอบเลขไมค์ให้สอดคล้องกับรถที่เลือก</p>
                </div>

                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้งาน</label>
                    <input id="userName" name="userName" type="text" required placeholder="เช่น สมหญิง / User ID" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                </div>

                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">แผนก</label>
                    <select id="department" name="department" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        <option value="">-- เลือกแผนก --</option>
                        <option>บริหาร</option>
                        <option>มิลิเนีย</option>
                        <option>ฝ่ายผลิต 1</option>
                        <option>ฝ่ายผลิต 2</option>
                        <option>ประกันคุณภาพ (QA)</option>
                        <option>ซ่อมบำรุง</option>
                        <option>สโตร์วัตถุดิบ</option>
                        <option>วางแผน</option>
                        <option>จัดส่ง</option>
                        <option>บัญชี</option>
                        <option>การตลาด</option>
                        <option>บุคคล / HR</option>
                        <option>ระบบคุณภาพ</option>
                        <option>จัดซื้อ</option>
                    </select>
                </div>

                <div>
                    <label for="easyPass" class="block text-sm font-medium text-gray-700 mb-1">Easy Pass คงเหลือ (บาท)</label>
                    <input id="easyPass" name="easyPass" type="number" step="0.25" min="0" required placeholder="เช่น 120.50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                </div>

                <div class="md:col-span-2">
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-1">สถานที่ใช้งาน (Location)</label>
                    <input id="location" name="location" type="text" required placeholder="เช่น กรุงเทพฯ > เชียงใหม่ / ส่งของบริษัท" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                </div>

                <div>
                    <label for="odometerOut" class="block text-sm font-medium text-gray-700 mb-1">เลขไมค์ ขาออก (กม.)</label>
                    <input id="odometerOut" name="odometerOut" type="number" required min="0" step="1" placeholder="ตัวเลขเท่านั้น" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                    <p id="odometer-out-hint" class="text-xs text-gray-500 mt-1">ระบบจะแสดงค่าไมค์ล่าสุดของรถที่เลือกเพื่อช่วยตรวจสอบ</p>
                </div>

                <div>
                    <label for="odometerIn" class="block text-sm font-medium text-gray-700 mb-1">เลขไมค์ ขาเข้า (กม.)</label>
                    <input id="odometerIn" name="odometerIn" type="number" required min="0" step="1" placeholder="ตัวเลขเท่านั้น" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                    <p id="odometer-in-hint" class="text-xs text-gray-500 mt-1">กรุณากรอกไมค์ที่มากกว่าหรือเท่ากับไมค์ขาออก และไม่ต่ำกว่าไมค์ล่าสุดของรถ</p>
                </div>

            </div>

            <div id="form-message" class="mt-3 text-sm font-medium text-red-500 hidden"></div>

            <button type="submit" id="submit-btn" class="btn-primary w-full mt-6 bg-teal-500 text-white p-3 rounded-lg font-semibold hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">บันทึกข้อมูลการใช้รถ</button>
        </form>
    </div>

    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
        <button id="delete-latest-btn" disabled class="btn-delete w-full sm:w-1/2 bg-red-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">ลบรายการล่าสุด (Delete Latest)</button>
        <button id="download-btn" disabled class="btn-primary w-full sm:w-1/2 bg-blue-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">ดาวน์โหลดข้อมูล (CSV)</button>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">รายการบันทึกล่าสุด</h2>
        <div class="overflow-x-auto">
            <table class="log-table w-full text-left text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase text-gray-500 rounded-lg">
                    <tr>
                        <th>วันที่/เวลา</th>
                        <th>รถยนต์</th>
                        <th>ผู้ใช้งาน</th>
                        <th>แผนก</th>
                        <th>สถานที่</th>
                        <th>Easy Pass (บาท)</th>
                        <th>ไมค์ออก</th>
                        <th>ไมค์เข้า</th>
                        <th class="rounded-r-lg">ระยะทาง (กม.)</th>
                    </tr>
                </thead>
                <tbody id="log-list"><tr><td colspan="9" class="text-center py-8">ไม่มีรายการบันทึก</td></tr></tbody>
            </table>
        </div>
        <div id="loading-state" class="text-center py-4 text-gray-500 hidden">กำลังโหลดข้อมูล...</div>
        <div class="text-center mt-4">
            <button id="load-more-btn" class="px-4 py-2 bg-teal-100 text-teal-700 rounded-lg border border-teal-200 hover:bg-teal-200">แสดงรายการเพิ่มเติม</button>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-2"><button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ปิด</button></div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// CONFIG (use your real config or keep as-is)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
    apiKey: "AIzaSyDKfJvn9yh-g1J5OMA9EBLEyp740b-NyH4",
    authDomain: "vehicle-mileage-31238.firebaseapp.com",
    projectId: "vehicle-mileage-31238",
    storageBucket: "vehicle-mileage-31238.firebasestorage.app",
    messagingSenderId: "968556830605",
    appId: "1:968556830605:web:4708cecdbfc44737c267c4",
    measurementId: "G-42QZMXH8VF"
};

const COLLECTION_PATH = `/artifacts/${appId}/public/data/vehicle_logs`;

let db, auth, userId = null, vehicleLogsRef;
let unsubscribe = null;
let displayLimit = 20;

// Last known odometer readings (start with values you provided)
const lastOdometers = {
    'Nissan Almera': 77634,
    'EV': 3045
};

// Mock/test data (test cases) - set USE_MOCK = true to use these without Firebase
const USE_MOCK = false; // change to true to test without Firebase
const MOCK_LOGS = [
    { id: 'mock1', vehicle: 'Nissan Almera', userName: 'สมชาย', department: 'จัดส่ง', location: 'กทม. > ชลบุรี', easyPass: 50.00, odometerOut: 77634, odometerIn: 77690, clientTimestamp: new Date().toISOString() },
    { id: 'mock2', vehicle: 'EV', userName: 'สมหญิง', department: 'การตลาด', location: 'กทม. > ระยอง', easyPass: 0.00, odometerOut: 3045, odometerIn: 3100, clientTimestamp: new Date(Date.now()-3600*1000).toISOString() }
];

// Elements
const form = document.getElementById('car-log-form');
const logList = document.getElementById('log-list');
const authStatus = document.getElementById('auth-status');
const deleteLatestBtn = document.getElementById('delete-latest-btn');
const downloadBtn = document.getElementById('download-btn');
const loadingState = document.getElementById('loading-state');
const formMessage = document.getElementById('form-message');
const modal = document.getElementById('custom-modal');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalClose = document.getElementById('modal-close');
const currentDateTimeDiv = document.getElementById('current-date-time');
const loadMoreBtn = document.getElementById('load-more-btn');

const vehicleSelect = document.getElementById('vehicle');
const odometerOutInput = document.getElementById('odometerOut');
const odometerInInput = document.getElementById('odometerIn');
const odometerOutHint = document.getElementById('odometer-out-hint');
const odometerInHint = document.getElementById('odometer-in-hint');
const submitBtn = document.getElementById('submit-btn');

// Helper modal
function showModal(title, message) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.classList.remove('hidden');
}
modalClose.addEventListener('click', () => modal.classList.add('hidden'));

function formatTimestamp(timestamp) {
    if (!timestamp) return 'ไม่ระบุ';
    try {
        if (typeof timestamp === 'string') {
            const d = new Date(timestamp);
            if (!isNaN(d)) return d.toLocaleString('th-TH', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Asia/Bangkok' });
        }
        if (timestamp && typeof timestamp.toDate === 'function') {
            const d = timestamp.toDate();
            return d.toLocaleString('th-TH', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Asia/Bangkok' });
        }
        if (timestamp instanceof Date) {
            return timestamp.toLocaleString('th-TH', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Asia/Bangkok' });
        }
    } catch (e) { console.warn('formatTimestamp failed', e, timestamp); }
    return 'ไม่ระบุ';
}

function updateDateTimeDisplay() {
    const now = new Date();
    const options = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone:'Asia/Bangkok' };
    // use toLocaleString to include time as well (toLocaleDateString may ignore time components in some browsers)
    currentDateTimeDiv.textContent = `วันที่และเวลาปัจจุบัน (ระบบ): ${now.toLocaleString('th-TH', options)} (เวลาที่บันทึกจริงจะใช้เวลาเซิร์ฟเวอร์)`;
}
updateDateTimeDisplay();
setInterval(updateDateTimeDisplay, 1000);

// Render logs
function renderLogs(logs) {
    loadingState.classList.add('hidden');
    logList.innerHTML = '';
    if (!logs || logs.length === 0) {
        logList.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ไม่มีรายการบันทึก</td></tr>';
        deleteLatestBtn.disabled = true; downloadBtn.disabled = true; return;
    }
    deleteLatestBtn.disabled = false; downloadBtn.disabled = false;

    // Sort by resolved timestamp (server timestamp if available) then clientTimestamp
    logs.sort((a, b) => {
        const at = (a.timestamp && typeof a.timestamp.toDate === 'function') ? a.timestamp.toDate().getTime() : (a.clientTimestamp ? new Date(a.clientTimestamp).getTime() : 0);
        const bt = (b.timestamp && typeof b.timestamp.toDate === 'function') ? b.timestamp.toDate().getTime() : (b.clientTimestamp ? new Date(b.clientTimestamp).getTime() : 0);
        return bt - at;
    });

    logs.forEach(log => {
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-50 hover:bg-gray-100 transition duration-150 ease-in-out border-b border-gray-200';
        const distance = (Number.isFinite(log.odometerIn) && Number.isFinite(log.odometerOut)) ? Math.max(0, log.odometerIn - log.odometerOut) : 0;
        const easyPass = (log.easyPass !== undefined && log.easyPass !== null) ? Number(log.easyPass).toFixed(2) : '-';
        const ts = log.timestamp || log.clientTimestamp || null;
        const tsDisplay = formatTimestamp(ts);

        // Ensure tsDisplay is always a string so the cell isn't empty
        tr.innerHTML = `
            <td data-label="วันที่/เวลา" class="font-medium text-gray-900">${tsDisplay}</td>
            <td data-label="รถยนต์" class="font-semibold text-teal-700">${log.vehicle || ''}</td>
            <td data-label="ผู้ใช้งาน">${log.userName || ''}</td>
            <td data-label="แผนก">${log.department || '-'}</td>
            <td data-label="สถานที่">${log.location || '-'}</td>
            <td data-label="Easy Pass" class="text-right">${easyPass}</td>
            <td data-label="ไมค์ออก" class="text-right">${(log.odometerOut ?? '').toLocaleString('th-TH')}</td>
            <td data-label="ไมค์เข้า" class="text-right">${(log.odometerIn ?? '').toLocaleString('th-TH')}</td>
            <td data-label="ระยะทาง (กม.)" class="font-bold text-blue-600 text-right">${distance.toLocaleString('th-TH')}</td>
        `;
        logList.appendChild(tr);
    });
}

// Firebase init + auth
async function initFirebase() {
    try {
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authStatus.textContent = `เชื่อมต่อแล้ว (User ID: ${userId.substring(0,8)}...)`;
                vehicleLogsRef = collection(db, COLLECTION_PATH);
                listenForLogs();
                deleteLatestBtn.disabled = false; downloadBtn.disabled = false;
            } else {
                await signInUser();
            }
        });

        await signInUser();
    } catch (err) {
        authStatus.textContent = `ข้อผิดพลาดในการเชื่อมต่อ Firebase: ${err.message || err.code}`;
        showModal('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ โปรดตรวจสอบการตั้งค่า Firebase Console.');
    }
}

async function signInUser() {
    try { await signInAnonymously(auth); authStatus.textContent = 'ลงชื่อเข้าใช้แบบไม่ระบุตัวตน...'; }
    catch (err) { authStatus.textContent = `การยืนยันตัวตนล้มเหลว: ${err.message}`; showModal('ข้อผิดพลาดในการเข้าสู่ระบบ', `ไม่สามารถยืนยันตัวตนได้: ${err.message}`); }
}

// Listen for logs with limit (supports load more)
function listenForLogs() {
    if (!db) return;
    loadingState.classList.remove('hidden');
    if (typeof unsubscribe === 'function') unsubscribe();
    try {
        const q = query(vehicleLogsRef, orderBy('timestamp','desc'), limit(displayLimit));
        unsubscribe = onSnapshot(q, (snapshot) => {
            const logs = [];
            snapshot.forEach(docSnap => logs.push({ id: docSnap.id, ...docSnap.data() }));
            renderLogs(logs);
            if (snapshot.size < displayLimit) loadMoreBtn.classList.add('hidden'); else loadMoreBtn.classList.remove('hidden');
        }, (err) => {
            console.error('Firestore listen failed:', err);
            showModal('ข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลบันทึกการใช้รถได้');
            loadingState.classList.add('hidden');
        });
    } catch (err) {
        console.error('listenForLogs error', err);
        showModal('ข้อผิดพลาด', `ไม่สามารถตั้งค่าการฟังข้อมูล: ${err.message || err}`);
        loadingState.classList.add('hidden');
    }
}

loadMoreBtn.addEventListener('click', () => {
    displayLimit += 20;
    loadMoreBtn.textContent = 'กำลังโหลดเพิ่มเติม...';
    loadMoreBtn.disabled = true;
    listenForLogs();
    setTimeout(() => { loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'แสดงรายการเพิ่มเติม'; }, 800);
});

// Validation utilities (same logic as before)
function showFormError(message) { formMessage.textContent = message; formMessage.classList.remove('hidden'); }
function hideFormError() { formMessage.textContent = ''; formMessage.classList.add('hidden'); }

vehicleSelect.addEventListener('change', () => {
    hideFormError();
    const v = vehicleSelect.value;
    const last = lastOdometers[v] ?? null;
    if (last !== null) {
        odometerOutInput.placeholder = `เช่น ${last} (ไมค์ล่าสุดของ ${v})`;
        odometerInInput.placeholder = `ต้องไม่น้อยกว่า ${last}`;
        odometerOutHint.textContent = `ไมค์ล่าสุดบันทึกไว้: ${last.toLocaleString('th-TH')} กม. (ระบบจะบล็อกเลขไมค์ที่น้อยกว่านี้สำหรับรถ ${v})`;
        odometerInHint.textContent = `กรอกไมค์ที่ >= ไมค์ขาออก และไม่ต่ำกว่า ${last.toLocaleString('th-TH')} กม.`;
        odometerOutInput.min = last;
        odometerInInput.min = last;
    } else {
        odometerOutInput.placeholder = 'ตัวเลขเท่านั้น';
        odometerInInput.placeholder = 'ตัวเลขเท่านั้น';
        odometerOutHint.textContent = 'ระบบจะแสดงค่าไมค์ล่าสุดของรถที่เลือกเพื่อช่วยตรวจสอบ';
        odometerInHint.textContent = 'กรุณากรอกไมค์ที่มากกว่าหรือเท่ากับไมค์ขาออก และไม่ต่ำกว่าไมค์ล่าสุดของรถ';
        odometerOutInput.removeAttribute('min');
        odometerInInput.removeAttribute('min');
    }
});

function validateOdometerFields() {
    hideFormError();
    const v = vehicleSelect.value;
    const last = lastOdometers[v] ?? null;
    const outVal = odometerOutInput.value ? parseInt(odometerOutInput.value,10) : NaN;
    const inVal = odometerInInput.value ? parseInt(odometerInInput.value,10) : NaN;
    if (isNaN(outVal) || isNaN(inVal)) return true;
    if (inVal < outVal) { showFormError('เลขไมค์ขาเข้า ต้องมากกว่าหรือเท่ากับ เลขไมค์ขาออก'); return false; }
    if (last !== null) { if (outVal < last || inVal < last) { showFormError(`เลขไมค์ที่กรอกต่ำกว่าไมค์ล่าสุดของรถที่เลือก (${v} = ${last.toLocaleString('th-TH')} กม.) กรุณาตรวจสอบ`); return false; } }
    for (const [otherVehicle, otherLast] of Object.entries(lastOdometers)) {
        if (otherVehicle === v) continue;
        if (outVal <= otherLast && inVal <= otherLast && outVal <= inVal) {
            const diff = Math.abs((last ?? 0) - otherLast);
            if (diff >= 1000) { showFormError(`ค่าที่กรอกดูเหมือนจะเป็นไมค์ของ ${otherVehicle} (ไมค์ล่าสุด ${otherLast.toLocaleString('th-TH')}). กรุณาตรวจสอบให้ตรงกับรถที่เลือก`); return false; }
        }
    }
    return true;
}
odometerOutInput.addEventListener('input', validateOdometerFields);
odometerInInput.addEventListener('input', validateOdometerFields);

// Form submit: validate then addDoc to Firestore. Also update in-memory lastOdometers on success.
form.addEventListener('submit', async (e) => {
    e.preventDefault(); hideFormError();
    if (!db && !USE_MOCK) { showModal('ข้อผิดพลาด', 'ฐานข้อมูลยังไม่พร้อมใช้งาน โปรดรอสักครู่'); return; }

    const vehicle = vehicleSelect.value;
    const userName = document.getElementById('userName').value.trim();
    const department = document.getElementById('department').value.trim();
    const location = document.getElementById('location').value.trim();
    const odometerOut = odometerOutInput.value ? parseInt(odometerOutInput.value,10) : NaN;
    const odometerIn = odometerInInput.value ? parseInt(odometerInInput.value,10) : NaN;
    const easyPassVal = document.getElementById('easyPass').value;
    const easyPass = easyPassVal !== '' ? parseFloat(easyPassVal) : null;

    if (!vehicle || !userName || !department || !location || easyPassVal === '' || isNaN(odometerOut) || isNaN(odometerIn)) { showFormError('กรุณากรอกข้อมูลให้ครบถ้วนทุกช่อง (ต้องไม่เว้นว่าง)'); return; }
    if (odometerIn < odometerOut) { showFormError('เลขไมค์ขาเข้า ต้องมากกว่าหรือเท่ากับ เลขไมค์ขาออกเสมอ'); return; }

    const last = lastOdometers[vehicle] ?? null;
    if (last !== null && (odometerOut < last || odometerIn < last)) { showFormError(`ไม่สามารถบันทึก: เลขไมค์ที่กรอกต่ำกว่าไมค์ล่าสุดของรถ ${vehicle} (ไมค์ล่าสุด ${last.toLocaleString('th-TH')} กม.)`); return; }

    for (const [otherVehicle, otherLast] of Object.entries(lastOdometers)) {
        if (otherVehicle === vehicle) continue;
        const otherDiff = Math.abs((last ?? 0) - otherLast);
        if (odometerOut <= otherLast && odometerIn <= otherLast && otherDiff >= 1000) { showFormError(`ค่าที่กรอกดูเหมือนจะเป็นไมค์ของ ${otherVehicle} (ไมค์ล่าสุด ${otherLast.toLocaleString('th-TH')}) — กรุณาตรวจสอบให้ตรงกับรถที่เลือก`); return; }
    }

    submitBtn.disabled = true; submitBtn.textContent = 'กำลังบันทึก...';

    try {
        const newLog = {
            vehicle,
            userName,
            department,
            location,
            easyPass,
            odometerOut,
            odometerIn,
            distance: odometerIn - odometerOut,
            timestamp: serverTimestamp(),
            clientTimestamp: new Date().toISOString(),
            userId
        };
        if (USE_MOCK) {
            MOCK_LOGS.push({ id: `mock-${Date.now()}`, ...newLog });
            renderLogs(MOCK_LOGS);
        } else {
            await addDoc(collection(db, COLLECTION_PATH), newLog);
        }
        showModal('สำเร็จ!', 'บันทึกข้อมูลการใช้รถเรียบร้อยแล้ว');
        form.reset();

        lastOdometers[vehicle] = Math.max(lastOdometers[vehicle] || 0, odometerIn);
        vehicleSelect.dispatchEvent(new Event('change'));

    } catch (err) {
        console.error('Firestore addDoc failed:', err);
        showFormError(`ข้อผิดพลาดในการบันทึก: ${err.message}`);
        showModal('ข้อผิดพลาดในการบันทึก', `ไม่สามารถบันทึกข้อมูลได้: ${err.message} โปรดตรวจสอบ Firebase Security Rules.`);
    } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'บันทึกข้อมูลการใช้รถ';
    }
});

// Delete latest
deleteLatestBtn.addEventListener('click', async () => {
    if (!db && !USE_MOCK) return; deleteLatestBtn.disabled = true; const originalText = deleteLatestBtn.textContent; deleteLatestBtn.textContent = 'กำลังลบ...';
    try {
        if (USE_MOCK) {
            if (MOCK_LOGS.length === 0) { showModal('ไม่พบข้อมูล', 'ไม่พบรายการบันทึกใดๆ ที่จะลบ'); return; }
            const latest = MOCK_LOGS.pop();
            renderLogs(MOCK_LOGS);
            showModal('สำเร็จ!', `รายการล่าสุด (${latest.userName} / ${String(latest.id).substring(0,8)}...) ถูกลบแล้ว`);
        } else {
            const q = query(collection(db, COLLECTION_PATH), orderBy('timestamp','desc'), limit(1));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { showModal('ไม่พบข้อมูล', 'ไม่พบรายการบันทึกใดๆ ที่จะลบ'); return; }
            const latestDoc = querySnapshot.docs[0];
            const docId = latestDoc.id;
            const confirmed = await new Promise(resolve => {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[9999]';
                confirmModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                        <h3 class="text-xl font-bold mb-3 text-gray-800">ยืนยันการลบ</h3>
                        <p class="text-gray-600 mb-4">คุณต้องการลบรายการบันทึกที่ล่าสุดโดย ${latestDoc.data().userName} ใช่หรือไม่?</p>
                        <div class="flex justify-end space-x-2">
                            <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                            <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ยืนยัน</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
                document.getElementById('cancel-delete').onclick = () => { confirmModal.remove(); resolve(false); };
                document.getElementById('confirm-delete').onclick = () => { confirmModal.remove(); resolve(true); };
            });
            if (confirmed) {
                await deleteDoc(doc(db, COLLECTION_PATH, docId));
                showModal('สำเร็จ!', `รายการล่าสุด (${latestDoc.data().userName} / ${docId.substring(0,8)}...) ถูกลบแล้ว`);
            } else { showModal('ยกเลิก', 'การลบรายการถูกยกเลิก'); }
        }
    } catch (err) {
        console.error('Firestore delete failed:', err);
        showModal('ข้อผิดพลาด', `ไม่สามารถลบรายการได้: ${err.message}`);
    } finally { deleteLatestBtn.disabled = false; deleteLatestBtn.textContent = originalText; }
});

// Download CSV
downloadBtn.addEventListener('click', async () => {
    if (!db && !USE_MOCK) return; downloadBtn.disabled = true; const originalText = downloadBtn.textContent; downloadBtn.textContent = 'กำลังเตรียมไฟล์...';
    try {
        let logs = [];
        if (USE_MOCK) logs = MOCK_LOGS.slice(); else {
            const q = query(collection(db, COLLECTION_PATH), orderBy('timestamp','asc'));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { showModal('ไม่มีข้อมูล', 'ไม่มีข้อมูลบันทึกให้ดาวน์โหลด'); return; }
            querySnapshot.forEach(docSnap => logs.push(docSnap.data()));
        }

        const headers = ["ID บันทึก","วันที่/เวลา","รถยนต์","ผู้ใช้งาน","แผนก","สถานที่","Easy Pass (บาท)","ไมค์ออก (กม.)","ไมค์เข้า (กม.)","ระยะทาง (กม.)"];
        const csvEscape = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
        const rows = [headers.map(csvEscape)];

        logs.forEach(log => {
            const timestampStr = formatTimestamp(log.timestamp || log.clientTimestamp);
            const distance = (log.odometerIn ?? 0) - (log.odometerOut ?? 0);
            const row = [ log.userId ? String(log.userId).substring(0,8) : (log.id ? String(log.id).substring(0,8) : '-'), timestampStr, log.vehicle ?? '', log.userName ?? '', log.department ?? '', log.location ?? '', (log.easyPass ?? ''), (log.odometerOut ?? ''), (log.odometerIn ?? ''), distance ];
            rows.push(row.map(csvEscape));
        });

        // Use unicode escape sequences to avoid embedding literal BOM/newline characters in source
        const csvString = '\uFEFF' + rows.map(r => r.join(',')).join('\r\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a'); link.setAttribute('href', url); link.setAttribute('download', `car_logbook_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showModal('ดาวน์โหลดสำเร็จ!', 'ไฟล์ CSV ถูกดาวน์โหลดไปยังเครื่องของคุณแล้ว');
    } catch (err) {
        console.error('Download failed:', err);
        showModal('ข้อผิดพลาด', `ไม่สามารถดาวน์โหลดข้อมูลได้: ${err.message}`);
    } finally { downloadBtn.disabled = false; downloadBtn.textContent = originalText; }
});

// Initialize
if (USE_MOCK) {
    renderLogs(MOCK_LOGS);
    authStatus.textContent = 'โหมดทดสอบ: Mock data (ยังไม่ได้เชื่อม Firebase)';
    deleteLatestBtn.disabled = false; downloadBtn.disabled = false;
} else {
    initFirebase();
}

</script>
</body>
</html>
