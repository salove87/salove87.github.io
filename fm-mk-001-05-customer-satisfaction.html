<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>แบบสำรวจความพึงพอใจลูกค้า | Customer Satisfaction Survey</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
    /* ให้ช่องกรอกเห็นขอบชัดเจน (ไม่ใช้ @apply เพื่อความเข้ากันได้กับ CDN) */
    input[type="text"], input[type="email"], input[type="date"], textarea, select {
      border: 2px solid #e5e7eb; /* gray-300 */
      border-radius: 0.5rem; /* rounded-lg */
      padding: 0.5rem 0.75rem; /* px-3 py-2 */
      outline: none;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
      border-color: #6b7280; /* gray-500 */
    }
    .radio-cell input { width: 1.2rem; height: 1.2rem; }
    .section-card {
      background: #fff;
      border-radius: 1rem; /* rounded-2xl */
      box-shadow: 0 1px 2px rgba(0,0,0,.05), 0 1px 3px rgba(0,0,0,.1);
      padding: 1.25rem; /* p-5 */
      border: 1px solid #f3f4f6; /* gray-100 */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="mb-6 md:mb-10">
      <h1 class="text-2xl md:text-3xl font-bold">แบบสำรวจความพึงพอใจลูกค้า</h1>
      <p class="text-sm md:text-base text-gray-600">Customer Satisfaction Survey (D/Q/C = 100 คะแนน)</p>
    </header>

    <!-- ผู้ประเมิน -->
    <section class="section-card mb-6">
      <h2 class="text-xl font-semibold mb-4">ข้อมูลผู้ประเมิน / Evaluator</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">บริษัท / Company</label>
          <input id="company" type="text" placeholder="เช่น ABC Co., Ltd." class="w-full" />
        </div>
        <div>
          <label class="block text-sm mb-1">ชื่อผู้ประเมิน / Name</label>
          <input id="evaluator" type="text" placeholder="ชื่อ-สกุล" class="w-full" />
        </div>
        <div>
          <label class="block text-sm mb-1">ตำแหน่ง / Position (ไม่บังคับ)</label>
          <input id="position" type="text" placeholder="ตำแหน่งงาน" class="w-full" />
        </div>
        <div>
          <label class="block text-sm mb-1">อีเมล / Email (ไม่บังคับ)</label>
          <input id="email" type="email" placeholder="name@example.com" class="w-full" />
        </div>
        <div>
          <label class="block text-sm mb-1">วันที่ประเมิน / Date</label>
          <input id="evalDate" type="date" class="w-full" />
        </div>
      </div>
    </section>

    <!-- คะแนนรวม สด ๆ ระหว่างกรอก -->
    <section class="section-card mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold">ภาพรวมคะแนน</h2>
          <p id="scoreText" class="text-sm text-gray-600">ยังไม่ได้กรอกคะแนน</p>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
          <div class="p-3 bg-gray-100 rounded-xl">
            <div class="text-xs text-gray-600">Delivery</div>
            <div id="scoreD" class="text-xl font-bold">0 / 40</div>
          </div>
          <div class="p-3 bg-gray-100 rounded-xl">
            <div class="text-xs text-gray-600">Quality</div>
            <div id="scoreQ" class="text-xl font-bold">0 / 40</div>
          </div>
          <div class="p-3 bg-gray-100 rounded-xl">
            <div class="text-xs text-gray-600">Cost</div>
            <div id="scoreC" class="text-xl font-bold">0 / 20</div>
          </div>
          <div class="p-3 bg-gray-800 text-white rounded-xl">
            <div class="text-xs opacity-80">รวม / Total</div>
            <div id="scoreTotal" class="text-xl font-bold">0 / 100</div>
            <div id="scoreGrade" class="text-sm opacity-90">เกรด: -</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ฟอร์มหลัก จะ Render ด้วย JS จากโครงสร้างคำถาม -->
    <form id="surveyForm" class="space-y-6"></form>

    <!-- รายละเอียดเพิ่มเติม -->
    <section class="section-card my-6">
      <label class="block text-sm mb-2 font-medium">รายละเอียดเพิ่มเติม / Additional comments</label>
      <textarea id="additional" rows="4" class="w-full" placeholder="ข้อคิดเห็นเพิ่มเติม ข้อเสนอแนะอื่น ๆ"></textarea>
    </section>

    <!-- แผงสรุปผล & ลิงก์คำตอบ (จะแสดงหลังส่งฟอร์ม) -->
    <section id="resultPanel" class="section-card my-6 hidden">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold">ส่งแบบฟอร์มสำเร็จ ✅</h2>
          <p class="text-sm text-gray-600">สรุปผลคะแนนและลิงก์คำตอบของคุณ</p>
        </div>
        <button id="btnNew" type="button" class="no-print px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm">เริ่มกรอกใหม่</button>
      </div>

      <div class="grid md:grid-cols-4 gap-3 mt-4">
        <div class="p-3 bg-gray-50 rounded-xl text-center">
          <div class="text-xs text-gray-600">Delivery</div>
          <div id="r_D" class="text-xl font-bold">-</div>
        </div>
        <div class="p-3 bg-gray-50 rounded-xl text-center">
          <div class="text-xs text-gray-600">Quality</div>
          <div id="r_Q" class="text-xl font-bold">-</div>
        </div>
        <div class="p-3 bg-gray-50 rounded-xl text-center">
          <div class="text-xs text-gray-600">Cost</div>
          <div id="r_C" class="text-xl font-bold">-</div>
        </div>
        <div class="p-3 bg-gray-800 text-white rounded-xl text-center">
          <div class="text-xs opacity-80">รวม / Total</div>
          <div id="r_total" class="text-xl font-bold">-</div>
          <div class="text-sm opacity-90">เกรด <span id="r_grade">-</span></div>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-3 gap-3 text-sm">
        <div class="p-3 bg-white rounded-xl border">
          <div class="text-gray-500">บริษัท</div>
          <div id="r_company" class="font-medium">-</div>
        </div>
        <div class="p-3 bg-white rounded-xl border">
          <div class="text-gray-500">ผู้ประเมิน</div>
          <div id="r_evaluator" class="font-medium">-</div>
        </div>
        <div class="p-3 bg-white rounded-xl border">
          <div class="text-gray-500">วันที่ประเมิน</div>
          <div id="r_date" class="font-medium">-</div>
        </div>
      </div>

      <div id="r_link_wrap" class="mt-4 bg-white rounded-xl border p-3 hidden">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-sm text-gray-600">ลิงก์คำตอบของคุณ:</span>
          <a id="r_link" href="#" class="text-blue-600 break-all underline" target="_blank" rel="noopener">#</a>
          <button id="btnCopyLink" type="button" class="no-print px-3 py-1 rounded-lg bg-blue-600 text-white text-sm">คัดลอกลิงก์</button>
          <span id="copyNote" class="text-xs text-green-600 hidden">คัดลอกแล้ว</span>
        </div>
        <p class="text-xs text-gray-500 mt-2">* ลิงก์จะมีให้เมื่อใช้โหมด Firestore เท่านั้น</p>
      </div>

      <div class="mt-3 flex gap-2 no-print">
        <button id="btnSendMarketing" type="button" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm">ส่งผลให้ฝ่ายการตลาด</button>
        <span class="text-xs text-gray-500 self-center">(เปิดอีเมลพร้อมลิงก์และสรุปคะแนน)</span>
      </div>
    </section>

    <!-- ปุ่มทำงาน -->
    <div class="flex flex-col md:flex-row gap-3 no-print">
      <button id="btnExportXLSX" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">ดาวน์โหลดผลคะแนน Excel (.xlsx)</button>
      <button id="btnEmailOnly" class="px-5 py-3 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">ส่ง Email</button>
      <button id="btnPrint" type="button" class="px-5 py-3 rounded-xl bg-gray-700 text-white font-semibold hover:bg-gray-800">พิมพ์/บันทึกเป็น PDF</button>
      <details class="ml-0 md:ml-auto bg-white border rounded-xl p-3 max-w-xl">
        <summary class="cursor-pointer font-semibold">เชื่อมต่อฐานข้อมูล (ตัวเลือกเสริม)</summary>
        <div class="text-sm mt-2 space-y-2">
          <p>ปุ่ม “ดาวน์โหลดผลคะแนน Excel (.xlsx)” ใช้งานได้ทันที ไม่ต้องตั้งค่าใด ๆ</p>
          <p>หากต้องการบันทึกออนไลน์จริง ให้เลือกอย่างใดอย่างหนึ่ง:</p>
          <ol class="list-decimal ml-5 space-y-1">
            <li><b>Google Apps Script → Google Sheets</b>: นำ URL ของ Web App มาวางในตัวแปร <code>SCRIPT_URL</code></li>
            <li><b>Firebase Firestore</b>: ใส่ค่า <code>firebaseConfig</code> แล้วเปลี่ยนโหมดส่งเป็น <b>"firebase"</b></li>
          </ol>
        </div>
      </details>
    </div>

    <footer class="mt-10 text-xs text-gray-500">FM-MK-001-05 • เกณฑ์เกรด: A 95-100, B 90-94, C 80-89, D 70-79, E &lt; 70</footer>

    <!-- ผลการทดสอบ (Unit-like tests) -->
    <details class="mt-6 section-card no-print">
      <summary class="cursor-pointer font-semibold">ผลการทดสอบภายในหน้า (สำหรับดีบัก)</summary>
      <ul id="testList" class="list-disc pl-6 text-sm mt-2"></ul>
    </details>
  </div>

  <script>
    'use strict';
    // ===== ตั้งค่าส่งข้อมูล (เลือกวิธีหนึ่ง) =====
    // (โหมดเริ่มต้นของสา: ใช้ Excel + Email เท่านั้น) คงตัวแปรไว้เพื่อความยืดหยุ่น
    let submitMode = "download"; // "download" | "script" | "firebase"

    // 2) Google Apps Script Web App (หากใช้ ให้เปลี่ยน submitMode = "script")
    const SCRIPT_URL = ""; // วาง URL ของ Web App ที่เชื่อม Google Sheet

    // 3) Firebase Firestore (หากใช้ ให้เปลี่ยน submitMode = "firebase")
    const firebaseConfig = {
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    // อีเมลฝ่ายการตลาด (แก้เป็นของจริงได้หลายอีเมล)
    const marketingEmails = ["marketing@yourdomain.com"]; // ตัวอย่าง: ["mkt@domain.com","brand@domain.com"]
    // โหมดเปิดหน้าส่งเมล: 'outlookWeb' | 'mailto' | 'auto'
    const EMAIL_MODE = 'outlookWeb';

    // ===== โครงสร้างคำถาม (จากไฟล์ Excel) =====
    const SURVEY = [
      {
        code: "D",
        title: "D การจัดส่ง / Delivery (40 คะแนน)",
        max: 40,
        items: [
          { no: 1, th: "การส่งมอบสินค้าตรงเวลา ที่ลูกค้าต้องการรวมถึงกรณีที่มีการเรียกงานพิเศษ", en: "Delivery on time (including urgent calls)" },
          { no: 2, th: "การให้ความร่วมมือของเจ้าหน้าที่ในด้านการจัดส่ง", en: "Cooperation of delivery staff" },
          { no: 3, th: "ปฏิบัติตามกฏระเบียบของลูกค้า", en: "Following customer's rules" },
          { no: 4, th: "ปัญหาการจัดส่งที่ทำให้ลูกค้าต้องหยุดชะงัก", en: "Customer stop line regarding delivery problem" },
          { no: 5, th: "ข้อร้องเรียน/การตักเตือนเกี่ยวกับปัญหาด้านการจัดส่ง", en: "Customer complaint/warning re delivery" },
          { no: 6, th: "ส่งมอบสินค้าครบถ้วนตามที่ลูกค้ากำหนด", en: "Deliver correct product as specified" },
          { no: 7, th: "การให้ความร่วมมือด้านการรับ-ส่งเอกสาร (P/O, FORECAST)", en: "Responding to P/O, FORECAST" },
          { no: 8, th: "ความรวดเร็วในการแก้ปัญหาในการจัดส่ง", en: "Rapidity to correct delivery problem" }
        ]
      },
      {
        code: "Q",
        title: "Q การควบคุมคุณภาพ / Quality (40 คะแนน)",
        max: 40,
        items: [
          { no: 1, th: "ผลิตภัณฑ์มีคุณภาพเป็นไปตามที่ลูกค้ากำหนด", en: "Product quality as per customer spec" },
          { no: 2, th: "ความรวดเร็วในการแก้ปัญหาคุณภาพ", en: "Rapidity to correct quality problem" },
          { no: 3, th: "ความสามารถในการตอบสนองความต้องการของลูกค้าได้อย่างทันท่วงที", en: "Quick action for customer need" },
          { no: 4, th: "สภาพการบรรจุหีบห่อเป็นไปตามมาตรฐานบรรจุภัณฑ์", en: "Packaging as per standard" },
          { no: 5, th: "ข้อร้องเรียนจากผู้ใช้งานหรือเรียกคืนสินค้าในช่วงรับประกัน", en: "End user complaints / recalled within warranty" },
          { no: 6, th: "เอกสารควบคุมคุณภาพ/เอกสารการส่งมอบถูกต้องครบถ้วน", en: "Quality/Shipping documents are correct" },
          { no: 7, th: "ปัญหาด้านคุณภาพที่ทำให้ลูกค้าต้องหยุดชะงัก", en: "Customer stop line regarding quality problem" },
          { no: 8, th: "ข้อร้องเรียน/การตักเตือนเกี่ยวกับปัญหาด้านคุณภาพ", en: "Customer complaint/warning re quality" }
        ]
      },
      {
        code: "C",
        title: "C การควบคุมราคา / Cost (20 คะแนน)",
        max: 20,
        items: [
          { no: 1, th: "ราคาของผลิตภัณฑ์เหมาะสม", en: "Product price is reasonable" },
          { no: 2, th: "เสนอราคาทันตามที่ลูกค้ากำหนด", en: "Quotation provided on time" },
          { no: 3, th: "ตอบสนองความต้องการของลูกค้าได้อย่างทันท่วงที", en: "Respond promptly to customer needs" },
          { no: 4, th: "รับฟังความคิดเห็นและข้อเสนอแนะจากลูกค้า", en: "Listening to customer suggestions" }
        ]
      }
    ];

    // ===== เครื่องมือช่วย =====
    const scale = [
      { value: 5, label: "ดีมาก" },
      { value: 4, label: "ดี" },
      { value: 3, label: "ปานกลาง" },
      { value: 2, label: "น้อย" },
      { value: 1, label: "ปรับปรุง" },
    ];

    function gradeOf(total) {
      if (total >= 95) return "A";
      if (total >= 90) return "B";
      if (total >= 80) return "C";
      if (total >= 70) return "D";
      return "E";
    }

    function todayISO() {
      const d = new Date();
      const tzOffset = d.getTimezoneOffset();
      const local = new Date(d.getTime() - tzOffset * 60000);
      return local.toISOString().slice(0,10);
    }

    // ===== สร้างตารางคำถามของแต่ละหมวด =====
    function renderSection(section) {
      const card = document.createElement('section');
      card.className = 'section-card';

      const h = document.createElement('h3');
      h.className = 'text-lg md:text-xl font-semibold mb-3';
      h.textContent = section.title;
      card.appendChild(h);

      // ตารางหัว
      const table = document.createElement('div');
      table.className = 'overflow-x-auto';

      const header = document.createElement('div');
      header.className = 'grid grid-cols-[auto,1fr,repeat(5,110px),minmax(180px,1fr)] text-sm font-semibold bg-gray-100 rounded-lg';
      header.innerHTML = `
        <div class="p-3 border-b">ลำดับ</div>
        <div class="p-3 border-b">รายการประเมิน</div>
        ${scale.map(s => `<div class='p-3 text-center border-b'>${s.label}<div class='text-[11px] text-gray-500'>${s.value}</div></div>`).join('')}
        <div class="p-3 border-b">ข้อเสนอแนะ</div>
      `;
      table.appendChild(header);

      section.items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-[auto,1fr,repeat(5,110px),minmax(180px,1fr)] text-sm items-center border-b last:border-b-0';

        const nameCell = document.createElement('div');
        nameCell.className = 'p-3 font-medium';
        nameCell.textContent = item.no;

        const descCell = document.createElement('div');
        descCell.className = 'p-3';
        descCell.innerHTML = `
          <div class="font-medium">${item.th}</div>
          <div class="text-[11px] text-gray-500 italic">${item.en || ''}</div>
        `;

        row.appendChild(nameCell);
        row.appendChild(descCell);

        // Radio 5→1 เรียงตามหัวตาราง
        scale.forEach(s => {
          const cell = document.createElement('label');
          cell.className = 'radio-cell p-3 flex justify-center';
          const id = `${section.code}_${item.no}_${s.value}`;
          cell.innerHTML = `<input type="radio" name="${section.code}_${item.no}" id="${id}" value="${s.value}" class="accent-gray-700" />`;
          row.appendChild(cell);
        });

        const suggestCell = document.createElement('div');
        suggestCell.className = 'p-2 md:p-3';
        suggestCell.innerHTML = `<input type="text" class="w-full" name="${section.code}_${item.no}_suggest" placeholder="ขอเสนอแนะ (ถ้ามี)" />`;

        row.appendChild(suggestCell);
        table.appendChild(row);
      });

      // สรุปคะแนนหมวด
      const footer = document.createElement('div');
      footer.className = 'flex items-center justify-end gap-3 mt-3';
      footer.innerHTML = `
        <div class="text-sm text-gray-600">คะแนนหมวดนี้</div>
        <div id="sum_${section.code}" class="px-3 py-1 rounded-lg bg-gray-100 font-semibold">0 / ${section.max}</div>
      `;

      card.appendChild(table);
      card.appendChild(footer);
      return card;
    }

    function renderForm() {
      const form = document.getElementById('surveyForm');
      form.innerHTML = '';
      SURVEY.forEach(sec => form.appendChild(renderSection(sec)));

      // bind update score
      form.addEventListener('change', updateScores);
    }

    function updateScores() {
      let total = 0;
      let d = 0, q = 0, c = 0;

      SURVEY.forEach(sec => {
        let secSum = 0;
        sec.items.forEach(it => {
          const radios = document.getElementsByName(`${sec.code}_${it.no}`);
          radios.forEach(r => { if (r.checked) secSum += Number(r.value); });
        });
        document.getElementById(`sum_${sec.code}`).textContent = `${secSum} / ${sec.max}`;
        total += secSum;
        if (sec.code === 'D') d = secSum; if (sec.code === 'Q') q = secSum; if (sec.code === 'C') c = secSum;
      });

      document.getElementById('scoreD').textContent = `${d} / 40`;
      document.getElementById('scoreQ').textContent = `${q} / 40`;
      document.getElementById('scoreC').textContent = `${c} / 20`;
      document.getElementById('scoreTotal').textContent = `${total} / 100`;
      document.getElementById('scoreGrade').textContent = `เกรด: ${gradeOf(total)}`;

      const scoreText = total > 0 ? `คะแนนรวมขณะนี้ ${total}/100 (${gradeOf(total)})` : 'ยังไม่ได้กรอกคะแนน';
      document.getElementById('scoreText').textContent = scoreText;
    }

    function collectData() {
      const data = {
        company: document.getElementById('company').value.trim(),
        evaluator: document.getElementById('evaluator').value.trim(),
        position: document.getElementById('position').value.trim(),
        email: document.getElementById('email').value.trim(),
        evalDate: document.getElementById('evalDate').value,
        additional: document.getElementById('additional').value.trim(),
        sections: [],
        score: { D: 0, Q: 0, C: 0, total: 0, grade: '-' }
      };

      SURVEY.forEach(sec => {
        const items = [];
        let secSum = 0;
        sec.items.forEach(it => {
          const name = `${sec.code}_${it.no}`;
          let score = '';
          document.getElementsByName(name).forEach(r => { if (r.checked) score = Number(r.value); });
          if (score) secSum += score;
          const suggest = document.querySelector(`input[name='${name}_suggest']`)?.value || '';
          items.push({ code: name, no: it.no, th: it.th, en: it.en, score, suggest });
        });
        data.sections.push({ code: sec.code, title: sec.title, max: sec.max, sum: secSum, items });
        data.score[sec.code] = secSum;
        data.score.total += secSum;
      });
      data.score.grade = gradeOf(data.score.total);
      return data;
    }

    // สร้าง CSV เป็นสตริง (เพื่อให้ทดสอบได้) แล้วจึงดาวน์โหลดไฟล์
    function buildCSV(data){
      const head = [
        'Company','Evaluator','Position','Email','Date','Section','ItemNo','Topic(TH)','Topic(EN)','Score','Suggestion','Sum(D)','Sum(Q)','Sum(C)','Total','Grade'
      ];
      const rows = [head];
      data.sections.forEach(sec => {
        sec.items.forEach(it => {
          rows.push([
            data.company,
            data.evaluator,
            data.position,
            data.email,
            data.evalDate,
            sec.code,
            it.no,
            it.th,
            it.en || '',
            it.score || '',
            (it.suggest || '').replaceAll('\n',' ').trim(),
            data.score.D,
            data.score.Q,
            data.score.C,
            data.score.total,
            data.score.grade
          ]);
        });
      });
      const csv = rows.map(r => r.map(v => `"${String(v ?? '').replaceAll('"','""')}"`).join(',')).join('\n');
      return csv;
    }

    // ===== ส่วนแสดงผลหลังส่ง + ลิงก์คำตอบ =====
    function qs(sel){ return document.querySelector(sel); }
    function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
    function urlId(){ return new URLSearchParams(location.search).get('id'); }

    function toggleResult(show=true){
      const el = qs('#resultPanel');
      if (!el) return;
      el.classList.toggle('hidden', !show);
    }

    function fillResult(data, shareUrl){
      if(!data) return;
      // เก็บค่าล่าสุดไว้ใช้กับปุ่มส่งอีเมล/ใช้งานอื่น ๆ
      window.__lastData = data;
      window.__lastShareUrl = shareUrl || null;

      qs('#r_company').textContent = data.company || '-';
      qs('#r_evaluator').textContent = data.evaluator || '-';
      qs('#r_date').textContent = data.evalDate || '-';
      qs('#r_D').textContent = `${data.score?.D ?? 0}/40`;
      qs('#r_Q').textContent = `${data.score?.Q ?? 0}/40`;
      qs('#r_C').textContent = `${data.score?.C ?? 0}/20`;
      qs('#r_total').textContent = `${data.score?.total ?? 0}/100`;
      qs('#r_grade').textContent = data.score?.grade ?? '-';

      const linkWrap = qs('#r_link_wrap');
      const linkEl = qs('#r_link');
      if(shareUrl){
        linkEl.href = shareUrl;
        linkEl.textContent = shareUrl;
        linkWrap.classList.remove('hidden');
        const copyBtn = qs('#btnCopyLink');
        if (copyBtn) {
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(shareUrl);
            qs('#copyNote').classList.remove('hidden');
            setTimeout(()=>qs('#copyNote').classList.add('hidden'), 1500);
          };
        }
      }else{
        linkWrap.classList.add('hidden');
      }

      // ปุ่มส่งอีเมลฝ่ายการตลาดในแผงสรุปผล
      const sendBtn = qs('#btnSendMarketing');
      if (sendBtn) {
        sendBtn.onclick = () => openMarketingEmail(window.__lastData || data, window.__lastShareUrl || null);
      }

      // แสดงผล + ทำให้ฟอร์มแก้ไขไม่ได้ เพื่อลดความสับสน
      toggleResult(true);
      qs('#surveyForm').classList.add('hidden');
      qsa('section.section-card').forEach(s => s.classList.add('opacity-70','pointer-events-none'));
    }

    // ดาวน์โหลด CSV (เก็บไว้ใช้ทดสอบ / เผื่อจำเป็น)
    function downloadCSV(data) {
      const csv = buildCSV(data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      const dt = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = URL.createObjectURL(blob);
      a.download = `customer-satisfaction-${dt}.csv`;
      a.click();
      fillResult(data, null);
    }

    // สร้างและดาวน์โหลดไฟล์ Excel (.xlsx)
    function downloadXLSX(data){
      if (!window.XLSX) { alert('ไม่พบไลบรารี XLSX'); return; }
      const head = ['Company','Evaluator','Position','Email','Date','Section','ItemNo','Topic(TH)','Topic(EN)','Score','Suggestion','Sum(D)','Sum(Q)','Sum(C)','Total','Grade'];
      const rows = [head];
      data.sections.forEach(sec => {
        sec.items.forEach(it => {
          rows.push([
            data.company,
            data.evaluator,
            data.position,
            data.email,
            data.evalDate,
            sec.code,
            it.no,
            it.th,
            it.en || '',
            it.score || '',
            (it.suggest || '').replaceAll('\n',' ').trim(),
            data.score.D,
            data.score.Q,
            data.score.C,
            data.score.total,
            data.score.grade
          ]);
        });
      });
      const wb = XLSX.utils.book_new();
      const wsData = rows;
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Scores');

      // แผ่นสรุป
      const sum = [
        ['Company', data.company || ''],
        ['Evaluator', data.evaluator || ''],
        ['Date', data.evalDate || ''],
        ['Delivery (40)', `${data.score.D || 0}`],
        ['Quality (40)', `${data.score.Q || 0}`],
        ['Cost (20)', `${data.score.C || 0}`],
        ['Total (100)', `${data.score.total || 0}`],
        ['Grade', data.score.grade || '-']
      ];
      const ws2 = XLSX.utils.aoa_to_sheet(sum);
      XLSX.utils.book_append_sheet(wb, ws2, 'Summary');

      const dt = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      XLSX.writeFile(wb, `customer-satisfaction-${dt}.xlsx`);

      // แสดงผลบนหน้า
      fillResult(data, null);
    }

    // แยกตัวสร้างลิงก์ mailto ออกมาเพื่อทดสอบได้
    function buildMarketingMailto(data, shareUrl, recipients){
      const to = (recipients || []).join(',');
      const subj = `CSAT ${data.company || ''} ${data.evalDate || ''} — รวม ${data.score?.total ?? 0}/100 (${data.score?.grade || '-'})`;
      const lines = [
        'สรุปผลแบบสำรวจความพึงพอใจลูกค้า',
        `บริษัท: ${data.company || '-'}`,
        `ผู้ประเมิน: ${data.evaluator || '-'}`,
        `วันที่ประเมิน: ${data.evalDate || '-'}`,
        '',
        `Delivery: ${data.score?.D ?? 0}/40`,
        `Quality: ${data.score?.Q ?? 0}/40`,
        `Cost: ${data.score?.C ?? 0}/20`,
        `รวม: ${data.score?.total ?? 0}/100`,
        `เกรด: ${data.score?.grade || '-'}`
      ];
      if (shareUrl) {
        lines.push('', `ดูรายละเอียด/ตอบกลับ: ${shareUrl}`);
      } else {
        lines.push('', '(ไม่มีลิงก์คำตอบ — เปิดใช้โหมด Firestore เพื่อสร้างลิงก์อัตโนมัติ)');
      }
      return `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(lines.join('\n'))}`;
    }

    // ตัวสร้างลิงก์ Compose สำหรับ Outlook Web หรือ mailto
    function buildEmailComposeUrl(mode, data, shareUrl, recipients){
      const toList = (recipients || []);
      const to = mode === 'outlookWeb' ? toList.join(';') : toList.join(',');
      const subj = `CSAT ${data.company || ''} ${data.evalDate || ''} — รวม ${data.score?.total ?? 0}/100 (${data.score?.grade || '-'})`;
      const lines = [
        'สรุปผลแบบสำรวจความพึงพอใจลูกค้า',
        `บริษัท: ${data.company || '-'}`,
        `ผู้ประเมิน: ${data.evaluator || '-'}`,
        `วันที่ประเมิน: ${data.evalDate || '-'}`,
        '',
        `Delivery: ${data.score?.D ?? 0}/40`,
        `Quality: ${data.score?.Q ?? 0}/40`,
        `Cost: ${data.score?.C ?? 0}/20`,
        `รวม: ${data.score?.total ?? 0}/100`,
        `เกรด: ${data.score?.grade || '-'}`
      ];
      if (shareUrl) { lines.push('', `ดูรายละเอียด/ตอบกลับ: ${shareUrl}`); }
      else { lines.push('', '(ไม่มีลิงก์คำตอบ — เปิดใช้โหมด Firestore เพื่อสร้างลิงก์อัตโนมัติ)'); }
      const body = lines.join('\n');

      if (mode === 'outlookWeb' || mode === 'auto'){
        // ใช้ Outlook on the web deeplink
        const base = 'https://outlook.office.com/mail/deeplink/compose';
        const q = new URLSearchParams({ to, subject: subj, body });
        return `${base}?${q.toString()}`;
      }
      // fallback: mailto
      return buildMarketingMailto(data, shareUrl, recipients);
    }

    // เปิดอีเมลไคลเอนต์จริง
    function openMarketingEmail(data, shareUrl){
      try {
        const url = buildEmailComposeUrl(EMAIL_MODE, data, shareUrl, marketingEmails);
        if (EMAIL_MODE === 'outlookWeb') {
          window.open(url, '_blank');
        } else {
          window.location.href = url;
        }
      } catch(err){ console.error(err); alert('เปิดอีเมลไม่สำเร็จ'); }
    }

    async function submitToScript(data) {
      if (!SCRIPT_URL) { alert('กรุณาตั้งค่า SCRIPT_URL ก่อน'); return; }
      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          // ถ้าต้องการอ่านค่าตอบกลับ ให้ตั้งค่า CORS ใน Apps Script และใช้ mode: 'cors'
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        alert('ส่งข้อมูลไปยัง Google Sheets แล้ว (ตรวจสอบชีตของคุณ)');
        fillResult(data, null);
      } catch (e) {
        console.error(e); alert('ส่งไม่สำเร็จ ลองใหม่หรือตรวจค่า SCRIPT_URL');
      }
    }

    async function ensureFirebase(){
      const [{ initializeApp }, { getFirestore, addDoc, collection, serverTimestamp, doc, getDoc }, { getAuth, signInAnonymously }] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js'),
        import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js')
      ]);
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      try { await signInAnonymously(auth); } catch(e) { /* อาจเปิด anonymous auth แล้ว หรือกำลังใช้งานอยู่ */ }
      return { app, getFirestore, addDoc, collection, serverTimestamp, doc, getDoc };
    }

    async function submitToFirebase(data) {
      if (!firebaseConfig || !firebaseConfig.apiKey) {
        alert('กรุณาตั้งค่า firebaseConfig ให้ครบก่อน'); return;
      }
      try {
        const { getFirestore, addDoc, collection, serverTimestamp } = await ensureFirebase();
        const db = getFirestore();
        const docRef = await addDoc(collection(db, 'customer_satisfaction'), { ...data, createdAt: serverTimestamp() });
        const shareUrl = `${location.origin}${location.pathname}?id=${docRef.id}`;
        alert('บันทึกเข้า Firestore สำเร็จ');
        fillResult(data, shareUrl);
      } catch (e) {
        console.error(e); alert('บันทึก Firestore ไม่สำเร็จ');
      }
    }

    async function loadFromFirebaseById(id){
      if (!firebaseConfig || !firebaseConfig.apiKey) return alert('ต้องตั้งค่า firebaseConfig เพื่อโหลดข้อมูลจากลิงก์');
      try {
        const { getFirestore, doc, getDoc } = await ensureFirebase();
        const db = getFirestore();
        const snap = await getDoc(doc(db, 'customer_satisfaction', id));
        if(snap.exists()){
          const data = snap.data();
          fillResult(data, location.href);
        } else {
          alert('ไม่พบทึกข้อมูลตามลิงก์นี้');
        }
      } catch(e){
        console.error(e); alert('โหลดข้อมูลไม่สำเร็จ');
      }
    }

    // ===== Events =====
    document.getElementById('btnPrint').addEventListener('click', () => window.print());

    const btnExportXLSX = document.getElementById('btnExportXLSX');
    if (btnExportXLSX){
      btnExportXLSX.addEventListener('click', (e) => {
        e.preventDefault();
        const data = collectData();
        if (!data.company || !data.evaluator || !data.evalDate) {
          alert('กรุณากรอก บริษัท, ชื่อผู้ประเมิน และ วันที่ประเมิน');
          return;
        }
        downloadXLSX(data);
      });
    }

    const btnEmailOnly = document.getElementById('btnEmailOnly');
    if (btnEmailOnly){
      btnEmailOnly.addEventListener('click', (e) => {
        e.preventDefault();
        const data = collectData();
        if (!data.company || !data.evaluator || !data.evalDate) {
          alert('กรุณากรอก บริษัท, ชื่อผู้ประเมิน และ วันที่ประเมิน');
          return;
        }
        openMarketingEmail(data, window.__lastShareUrl || null);
      });
    }

    document.getElementById('btnNew').addEventListener('click', () => {
      location.href = location.pathname; // รีเฟรชกลับโหมดกรอกใหม่ (ลบพารามิเตอร์ id)
    });

    // ===== Init =====
    document.getElementById('evalDate').value = todayISO();
    renderForm();

    // ถ้าเปิดด้วยลิงก์ ?id=xxxx ให้โหลดผลมาแสดงทันที (โหมดดูผล)
    const _id = urlId();
    if(_id){ toggleResult(true); loadFromFirebaseById(_id); }

    // ===== Tests =====
    (function runTests(){
      const out = document.getElementById('testList');
      const add = (ok, msg) => {
        const li = document.createElement('li');
        li.textContent = (ok ? '✅ ' : '❌ ') + msg;
        li.className = ok ? 'text-emerald-700' : 'text-red-600';
        out.appendChild(li);
      };

      try {
        // (คง test เดิมตามคำสั่ง)
        add(gradeOf(95)==='A', 'gradeOf(95) → A');
        add(gradeOf(94)==='B', 'gradeOf(94) → B');
        add(gradeOf(80)==='C', 'gradeOf(80) → C');
        add(gradeOf(70)==='D', 'gradeOf(70) → D');
        add(gradeOf(69)==='E', 'gradeOf(69) → E');

        add(/^\d{4}-\d{2}-\d{2}$/.test(todayISO()), 'todayISO() รูปแบบ YYYY-MM-DD');

        const sample = {
          company: 'ACME', evaluator: 'Alice "A"', position: 'Mgr', email: 'a@acme.com', evalDate: '2025-11-10', additional: '',
          sections: [ { code:'D', title:'', max:40, sum:5, items:[{no:1, th:'T', en:'E', score:5, suggest:'มี\nบรรทัดใหม่'}] } ],
          score: { D:5, Q:0, C:0, total:5, grade:'E' }
        };
        const csv = buildCSV(sample);
        add(csv.includes('Company'), 'CSV มีหัวคอลัมน์');
        add(csv.includes('Alice ""A""'), 'CSV escape อัญประกาศถูกต้อง');
        add(csv.includes('\n'), 'CSV ใช้ตัวคั่นบรรทัดเป็น "\\n"');
        add(!csv.includes('"\n"'), 'CSV ไม่มีตัวอักษรขึ้นบรรทัดใหม่ผิดที่');

        // (เพิ่ม test ใหม่ตามคำสั่ง)
        const mailto = buildMarketingMailto(sample, 'https://example.com/?id=123', ['mkt@example.com','brand@example.com']);
        add(/^mailto:/.test(mailto), 'mailto เริ่มต้นด้วย mailto:');
        add(/subject=/.test(mailto) && /body=/.test(mailto), 'mailto มีพารามิเตอร์ subject และ body');

        // ทดสอบ CSV กรณีมีลูกน้ำ (,)
        const csv2 = buildCSV({
          ...sample,
          company: 'ACME, Inc.',
          sections: [{...sample.sections[0]}]
        });
        add(csv2.includes('\"ACME, Inc.\"') || csv2.includes('"ACME, Inc."'), 'CSV ครอบค่าเครื่องหมายลูกน้ำด้วยอัญประกาศ');

        // XLSX tests
        add(!!window.XLSX, 'XLSX โหลดสำเร็จ');
        if (window.XLSX){
          const ws = XLSX.utils.aoa_to_sheet([["Company","Evaluator"],["ACME","Alice"]]);
          add(!!ws['A1'] && ws['A1'].v === 'Company', 'XLSX แปลง aoa เป็นชีตได้');
        }

        // เพิ่ม test: ไม่มีลิงก์ → ใส่โน้ตในเมล
        const mailto2 = buildMarketingMailto(sample, null, ['mkt@example.com']);
        add(decodeURIComponent(mailto2).includes('(ไม่มีลิงก์คำตอบ'), 'mailto (ไม่มีลิงก์) ใส่โน้ตชัดเจน');

        // Outlook Web compose URL tests
        const outlookUrl = buildEmailComposeUrl('outlookWeb', sample, 'https://example.com/?id=123', ['mkt@example.com','brand@example.com']);
        add(/^https:\/\/outlook\./.test(outlookUrl) && /compose\?/.test(outlookUrl), 'Outlook compose URL ถูกต้อง');
        add(/body=/.test(outlookUrl), 'Outlook URL มี body=');
        add(/%0A/.test(outlookUrl), 'Outlook body เข้ารหัสบรรทัดใหม่เป็น %0A');

        // เพิ่ม test โหมด mailto ผ่าน buildEmailComposeUrl
        const mailtoUrlFromCompose = buildEmailComposeUrl('mailto', sample, null, ['mkt@example.com']);
        add(/^mailto:/.test(mailtoUrlFromCompose), 'Compose URL (mailto mode) เป็น mailto:');
      } catch (err) {
        add(false, 'เกิดข้อผิดพลาดในชุดทดสอบ: ' + (err && err.message));
      }
    })();
  </script>
</body>
</html>
