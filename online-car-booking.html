<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
        }
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alert) */
        .alert {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        /* Custom Confirmation Dialog for Delete */
        #deleteConfirmContainer {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 lg:p-12 mt-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">
                üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
            </h1>
            <!-- ‡πÅ‡∏™‡∏î‡∏á User ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Firestore -->
            <p id="userIdDisplay" class="text-sm text-gray-500 mb-4 break-words">User ID: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            <p class="text-gray-500">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ß‡∏°
            </p>
        </header>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ -->
        <form id="bookingForm" class="space-y-6 mb-10 pb-8 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">1. ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ</h2>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå -->
            <div class="bg-indigo-50 p-6 rounded-lg border-l-4 border-indigo-600">
                <!-- Row 1: Time Range -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ -->
                    <div>
                        <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" id="startTime" name="startTime" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>

                    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ -->
                    <div>
                        <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" id="endTime" name="endTime" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                </div>

                <!-- Row 2: Booker Name and Department -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Booker Name) -->
                    <div>
                        <label for="bookerName" class="block text-sm font-medium text-gray-700 mb-1">
                            ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="bookerName" name="bookerName" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                               placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>
                    <!-- ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Booker Department) -->
                    <div>
                        <label for="bookerDepartment" class="block text-sm font-medium text-gray-700 mb-1">
                            ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="bookerDepartment" name="bookerDepartment" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                               placeholder="‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢">
                    </div>
                </div>

                <!-- Row 3: Purpose -->
                <div class="mt-6">
                    <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">
                        ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á <span class="text-red-500">*</span>
                    </label>
                    <textarea id="purpose" name="purpose" rows="2" required
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà..."></textarea>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) -->
            <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-600">
                <h2 class="text-xl font-semibold text-yellow-700 mb-4">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà 1: Nissan Almera -->
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-white transition duration-150">
                        <input type="radio" name="carType" value="almera" class="text-indigo-600 focus:ring-indigo-500" required>
                        <span class="ml-3 text-lg font-bold text-gray-700">Nissan Almera</span>
                    </label>
                    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà 2: ‡∏£‡∏ñ EV (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤) -->
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-white transition duration-150">
                        <input type="radio" name="carType" value="ev" class="text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 text-lg font-bold text-gray-700">‡∏£‡∏ñ EV (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)</span>
                    </label>
                </div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alert) -->
            <div id="alertMessage" class="alert p-4 rounded transition-opacity duration-300 ease-in-out hidden" role="alert">
                <p class="font-bold" id="alertTitle"></p>
                <p id="alertText"></p>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° -->
            <div class="pt-4">
                <button type="submit" id="submitButton"
                        class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                </button>
            </div>
        </form>
        
        <!-- NEW: Mileage Log Link -->
        <div class="mt-8 mb-10 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-xl shadow-inner">
            <h3 class="font-semibold text-blue-800 mb-2">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (Mileage Log)</h3>
            <p class="text-sm text-blue-700 mb-3">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å:</p>
            <a href="https://onlineutility.app/vehicle-mileage-log.html" target="_blank"
               class="inline-flex items-center justify-center w-full sm:w-auto py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150">
                ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á 
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
            </a>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (Public Data) -->
        <section class="mt-10 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
            <!-- Delete Confirmation Container (Hidden by default) -->
            <div id="deleteConfirmContainer" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-lg mb-4 hidden">
                <p class="font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
                <p class="text-sm mt-1 mb-3">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelDeleteBtn" class="py-1 px-3 bg-gray-400 text-white text-sm font-semibold rounded-lg hover:bg-gray-500 transition duration-150">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="button" id="confirmDeleteBtn" data-booking-id="" class="py-1 px-3 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition duration-150">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                    </button>
                </div>
            </div>
            
            <div id="companyBookingsList" class="space-y-4">
                <p class="text-gray-500 text-center p-4 bg-gray-50 rounded-lg" id="publicLoadingIndicator">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...</p>
                <!-- Public Bookings will be inserted here by JavaScript -->
            </div>
        </section>

        <footer class="mt-8 text-center text-sm text-gray-400 border-t pt-4">
            
        </footer>
    </div>

    <!-- Edit Modal Structure -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á <span id="editCarName" class="text-indigo-600"></span></h3>
            <form id="editBookingForm" class="space-y-4">
                <input type="hidden" id="editBookingId">

                <!-- Time Range -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editStartTime" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</label>
                        <input type="datetime-local" id="editStartTime" required
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="editEndTime" class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="datetime-local" id="editEndTime" required
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Booker Details (Readonly) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editBookerName" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                        <input type="text" id="editBookerName" readonly
                               class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                    </div>
                    <div>
                        <label for="editBookerDepartment" class="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input type="text" id="editBookerDepartment" readonly
                               class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                    </div>
                </div>
                
                <!-- Purpose -->
                <div>
                    <label for="editPurpose" class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
                    <textarea id="editPurpose" rows="2" required
                              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="closeModalBtn"
                            class="py-2 px-4 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" id="saveEditBtn"
                            class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Edit Modal -->

    <script type="module">
        // Firebase Imports (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ type="module" ‡πÉ‡∏ô script tag)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, serverTimestamp, addDoc, updateDoc, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ***************************************************************
        // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Firebase Config (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
        // ***************************************************************
        // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô Host ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAgTPzz6xqCOVYgWUK0z8-978qKUoDvTy8",
            authDomain: "onlinecarbooking-b623d.firebaseapp.com",
            projectId: "onlinecarbooking-b623d",
            storageBucket: "onlinecarbooking-b623d.firebasestorage.app",
            messagingSenderId: "39587745476",
            appId: "1:39587745476:web:30be6ad23ac47bc3c5c391",
            measurementId: "G-KCPHGGCJ56"
        };
        
        // ‡πÉ‡∏ä‡πâ config ‡∏à‡∏≤‡∏Å Canvas (‡∏´‡∏≤‡∏Å‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ config ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        const finalConfig = (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) 
            ? JSON.parse(__firebase_config) 
            : USER_FIREBASE_CONFIG;

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firebase ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const appId = typeof __app_id !== 'undefined' ? __app_id : finalConfig.projectId || 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á Firestore
        setLogLevel('Debug');

        let app, db, auth, userId = null;
        let latestPublicBookings = []; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≠‡∏á‡∏£‡∏ß‡∏°

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        function getUsageStatus(startTimeISO, endTimeISO) {
            const now = new Date().getTime();
            const start = new Date(startTimeISO).getTime();
            const end = new Date(endTimeISO).getTime();

            if (now < start) {
                return { status: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', color: 'blue' };
            } else if (now >= start && now <= end) {
                return { status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ', color: 'green' };
            } else {
                return { status: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', color: 'gray' };
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤
        function formatDateTime(isoString, includeTime = true) {
            if (!isoString) return 'N/A';
            try {
                 // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Firestore Timestamp Object (‡∏à‡∏≤‡∏Å serverTimestamp)
                 if (typeof isoString === 'object' && typeof isoString.toDate === 'function') {
                    isoString = isoString.toDate().toISOString();
                 }

                 const date = new Date(isoString);
                 const options = { 
                     year: 'numeric', month: 'short', day: 'numeric', 
                 };
                 if (includeTime) {
                     options.hour = '2-digit';
                     options.minute = '2-digit';
                     options.hour12 = false;
                 }
                 
                 return date.toLocaleDateString('th-TH', options) + (includeTime ? ' ‡∏ô.' : '');
            } catch (e) {
                console.error("Date formatting error:", e);
                return '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            }
        }

        // --- PUBLIC BOOKINGS (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó) ---
        function renderPublicBookings(bookings) {
            const bookingsList = document.getElementById('companyBookingsList');
            if (!bookingsList) return; // Safety check for DOM element

            bookingsList.innerHTML = ''; // Clear previous list
            latestPublicBookings = bookings; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

            if (!Array.isArray(bookings) || bookings.length === 0) {
                bookingsList.innerHTML = `<p class="text-gray-500 text-center p-4 bg-gray-50 rounded-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>`;
                return;
            }

            // Normalize timestamps (handle Firestore Timestamp objects)
            function toMillis(t) {
                if (!t) return 0;
                try {
                    if (typeof t === 'object' && typeof t.toDate === 'function') return t.toDate().getTime();
                    return new Date(t).getTime();
                } catch (e) { return 0; }
            }

            // Group bookings by status
            const groups = { '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ': [], '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô': [], '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': [] };
            bookings.forEach(b => {
                const st = getUsageStatus(b.startTime, b.endTime).status;
                if (!groups[st]) groups[st] = [];
                groups[st].push(b);
            });

            // Sort each group by startTime ascending
            Object.keys(groups).forEach(k => {
                groups[k].sort((a, b) => toMillis(a.startTime) - toMillis(b.startTime));
            });

            // Decide final order: if any '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ' exist -> ['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô']
            // otherwise -> ['‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ','‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô']
            const hasActive = groups['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ'] && groups['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ'].length > 0;
            const order = hasActive ? ['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'] : ['‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ','‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'];

            // Build final list
            const orderedList = [];
            order.forEach(statusKey => {
                if (groups[statusKey] && groups[statusKey].length) orderedList.push(...groups[statusKey]);
            });

            // Render orderedList
            orderedList.forEach(booking => {
                const { status, color } = getUsageStatus(booking.startTime, booking.endTime);
                const isMine = booking.userId === userId;

                const statusClasses = {
                    'blue': 'bg-blue-100 text-blue-800 border-blue-500',
                    'green': 'bg-green-100 text-green-800 border-green-500',
                    'gray': 'bg-gray-100 text-gray-800 border-gray-500'
                };

                const carName = booking.carType === 'almera' ? 'Nissan Almera' : '‡∏£‡∏ñ EV (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)';
                const borderColor = isMine ? 'border-purple-600' : statusClasses[color].replace('bg-', 'border-');
                const backgroundColor = isMine ? 'bg-purple-50' : statusClasses[color].replace('border-l-4 border-', 'bg-');

                const bookingItem = document.createElement('div');
                bookingItem.className = `p-4 border-l-4 rounded-lg shadow-md ${backgroundColor} ${borderColor}`;

                let actionButtonsHtml = '';
                // allow edit/delete only for owner and only when not started
                if (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' && isMine) {
                    actionButtonsHtml = `
                        <button type="button" data-id="${booking.id}" data-carType="${booking.carType}" 
                            data-start="${booking.startTime}" data-end="${booking.endTime}"
                            data-purpose="${booking.purpose}" data-name="${booking.bookerName}" 
                            data-dept="${booking.bookerDepartment}"
                            class="ml-3 text-xs py-1 px-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 edit-booking-btn">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button type="button" data-id="${booking.id}"
                            class="ml-1 text-xs py-1 px-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 delete-booking-btn">
                            ‡∏•‡∏ö
                        </button>
                    `;
                }

                bookingItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-lg font-bold">${carName}</span>
                        <div class="flex items-center">
                            <span class="text-sm font-semibold py-1 px-3 rounded-full ${statusClasses[color].replace('border-', 'ring-1 ring-')}" style="border:none;">
                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}
                            </span>
                            ${actionButtonsHtml}
                        </div>
                    </div>
                    <p class="text-sm mb-1 text-gray-700">
                        <strong>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</strong> <span class="font-semibold text-gray-800">${booking.bookerName || 'N/A'}</span> 
                        <span class="text-gray-500 mx-2">|</span> 
                        <strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span class="font-semibold text-gray-800">${booking.bookerDepartment || 'N/A'}</span>
                    </p>
                    <p class="text-sm mb-1 text-truncate"><strong>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${booking.purpose}</p>
                    <p class="text-xs mt-2 text-gray-600">
                        <span class="font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°:</span> ${formatDateTime(booking.startTime)} 
                        <span class="mx-2 text-gray-500">‡∏ñ‡∏∂‡∏á</span> 
                        <span class="font-medium">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</span> ${formatDateTime(booking.endTime)}
                        <span class="mx-2 text-gray-400">|</span> 
                        <span class="font-medium">‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> ${formatDateTime(booking.bookingDate, true)}
                    </p>
                `;
                bookingsList.appendChild(bookingItem);
            });

            // Re-attach event listeners for newly rendered buttons
            document.querySelectorAll('.edit-booking-btn').forEach(button => {
                button.addEventListener('click', openEditModal);
            });
            document.querySelectorAll('.delete-booking-btn').forEach(button => {
                button.addEventListener('click', showDeleteConfirm);
            });
        }

        // --- Firestore Listeners Setup ---

        const setupPublicFirestoreListener = () => {
            if (!db) return;

            // Path: /artifacts/{appId}/public/data/company_bookings (Public Data)
            const publicBookingsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'company_bookings');
            const q = query(publicBookingsCollectionRef); 
            
            const loadingIndicator = document.getElementById('publicLoadingIndicator');
            const bookingsList = document.getElementById('companyBookingsList');

            onSnapshot(q, (snapshot) => {
                const bookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô JavaScript: ‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡πá‡∏ß‡πÑ‡∏õ‡∏ä‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ)
                bookings.sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime()); 
                
                if (loadingIndicator) { // Safe null check
                    loadingIndicator.classList.add('hidden');
                }
                renderPublicBookings(bookings);
            }, (error) => {
                console.error("Firestore Public onSnapshot Error:", error);
                if (bookingsList) { // Safe null check
                    bookingsList.innerHTML = `<p class="text-red-500 text-center p-4 bg-red-50 rounded-lg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ß‡∏°: ${error.message}</p>`;
                }
            });
        };
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alert)
        function showAlert(message, type = 'success') {
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            const alertTitle = document.getElementById('alertTitle');
            
            alertText.textContent = message;
            alertMessage.className = `alert p-4 rounded transition-opacity duration-300 ease-in-out`;
            
            if (type === 'success') {
                alertMessage.classList.remove('bg-red-100', 'border-red-500', 'text-red-700', 'bg-blue-100', 'border-blue-500', 'text-blue-700');
                alertMessage.classList.add('bg-green-100', 'border-l-4', 'border-green-500', 'text-green-700');
                alertTitle.textContent = '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
            } else if (type === 'error') {
                alertMessage.classList.remove('bg-green-100', 'border-green-500', 'text-green-700', 'bg-blue-100', 'border-blue-500', 'text-blue-700');
                alertMessage.classList.add('bg-red-100', 'border-l-4', 'border-red-500', 'text-red-700');
                alertTitle.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á!';
            } else {
                alertMessage.classList.remove('bg-green-100', 'border-green-500', 'text-green-700', 'bg-red-100', 'border-red-500', 'text-red-700');
                alertMessage.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500', 'text-blue-700');
                alertTitle.textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
            }

            alertMessage.classList.remove('hidden');
            setTimeout(() => {
                alertMessage.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                alertMessage.style.opacity = '0';
                setTimeout(() => {
                    alertMessage.classList.add('hidden');
                }, 300);
            }, 5000);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ 
        function validateDates(start, end) {
            // Use a small buffer to prevent immediate booking conflicts
            const now = new Date(new Date().getTime() - 60000); 
            const startTime = new Date(start);
            const endTime = new Date(end);

            if (startTime < now) {
                showAlert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤)', 'error');
                return false;
            }
            
            if (endTime <= startTime) {
                showAlert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ', 'error');
                return false;
            }
            return true;
        }

        // --- CONFLICT CHECKER FUNCTION ---
        function isTimeConflicting(newStart, newEnd, existingStart, existingEnd) {
            const newStartTime = new Date(newStart).getTime();
            const newEndTime = new Date(newEnd).getTime();
            const existingStartTime = new Date(existingStart).getTime();
            const existingEndTime = new Date(existingEnd).getTime();

            // Conflict if:
            // The new period and existing period overlap (they are not disjoint)
            // (New starts before existing ends AND New ends after existing starts)
            return (newStartTime < existingEndTime && newEndTime > existingStartTime);
        }

        async function checkForConflict(newStart, newEnd, carType) {
            // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firestore (‡πÉ‡∏ä‡πâ getDocs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡πâ‡∏ô)
            const publicCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'company_bookings');
            try {
                const snapshot = await getDocs(query(publicCollectionRef));
                const existingBookings = snapshot.docs.map(doc => doc.data());

                const conflictingBooking = existingBookings.find(booking => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á "‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"
                    const status = getUsageStatus(booking.startTime, booking.endTime).status;
                    if (booking.carType === carType && (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' || status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ')) {
                        return isTimeConflicting(newStart, newEnd, booking.startTime, booking.endTime);
                    }
                    return false;
                });

                if (conflictingBooking) {
                    const carName = conflictingBooking.carType === 'almera' ? 'Nissan Almera' : '‡∏£‡∏ñ EV (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)';
                    // MODIFIED MESSAGE
                    const conflictDetails = `‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ! ‡∏£‡∏ñ ${carName} ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢ ${conflictingBooking.bookerName} (‡πÅ‡∏ú‡∏ô‡∏Å ${conflictingBooking.bookerDepartment}) ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${formatDateTime(conflictingBooking.startTime)} ‡∏ñ‡∏∂‡∏á ${formatDateTime(conflictingBooking.endTime)} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô`;
                    showAlert(conflictDetails, 'error');
                    return true;
                }
                return false;

            } catch (error) {
                console.error("Error during conflict check:", error);
                showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô: ${error.message}`, 'error');
                return true; // Assume conflict if check fails to prevent accidental double-booking
            }
        }
        // --- END: CONFLICT CHECKER FUNCTION ---


        // --- EDIT MODAL FUNCTIONS ---
        const editModal = document.getElementById('editModal');
        const editBookingForm = document.getElementById('editBookingForm');
        
        function openEditModal(event) {
            const button = event.currentTarget;
            const bookingId = button.getAttribute('data-id');
            const carType = button.getAttribute('data-carType');
            const startTime = button.getAttribute('data-start');
            const endTime = button.getAttribute('data-end');
            const purpose = button.getAttribute('data-purpose');
            const bookerName = button.getAttribute('data-name');
            const bookerDepartment = button.getAttribute('data-dept');
            
            // Set values in the modal form
            document.getElementById('editBookingId').value = bookingId;
            document.getElementById('editCarName').textContent = carType === 'almera' ? 'Nissan Almera' : '‡∏£‡∏ñ EV (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)';
            document.getElementById('editStartTime').value = startTime.substring(0, 16); // format for datetime-local
            document.getElementById('editEndTime').value = endTime.substring(0, 16); // format for datetime-local
            document.getElementById('editPurpose').value = purpose;
            document.getElementById('editBookerName').value = bookerName;
            document.getElementById('editBookerDepartment').value = bookerDepartment;

            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        editBookingForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const bookingId = document.getElementById('editBookingId').value;
            const newStartTime = document.getElementById('editStartTime').value;
            const newEndTime = document.getElementById('editEndTime').value;
            const newPurpose = document.getElementById('editPurpose').value;
            
            const saveEditBtn = document.getElementById('saveEditBtn');

            if (!validateDates(newStartTime, newEndTime)) {
                return;
            }

            // Disable button and show loading
            saveEditBtn.disabled = true;
            saveEditBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            
            const publicCollectionPath = 'artifacts/' + appId + '/public/data/company_bookings';
            //const privateCollectionPath = 'artifacts/' + appId + '/users/' + userId + '/bookings'; // Not used in this simplified update

            try {
                // Find the existing booking in the public list to get all necessary data
                const existingBooking = latestPublicBookings.find(b => b.id === bookingId);
                
                if (!existingBooking) {
                     showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                     return;
                }

                // *** MODIFIED: Check for conflict BEFORE saving edit ***
                // Temporarily remove the booking being edited from the conflict check
                const bookingsExcludingCurrent = latestPublicBookings.filter(b => b.id !== bookingId);
                
                const isConflicting = bookingsExcludingCurrent.some(booking => {
                    const status = getUsageStatus(booking.startTime, booking.endTime).status;
                    if (booking.carType === existingBooking.carType && (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' || status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ')) {
                        return isTimeConflicting(newStartTime, newEndTime, booking.startTime, booking.endTime);
                    }
                    return false;
                });

                if (isConflicting) {
                    showAlert('‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤', 'error');
                    return; // Stop execution
                }
                // *** END MODIFIED ***

                // Prepare updated data
                const updatedData = {
                    startTime: newStartTime,
                    endTime: newEndTime,
                    purpose: newPurpose,
                    // Keep existing static data
                    carType: existingBooking.carType,
                    bookerName: existingBooking.bookerName,
                    bookerDepartment: existingBooking.bookerDepartment,
                    userId: existingBooking.userId,
                };

                // 1. Update Public Record (The primary source of truth for the public schedule)
                await updateDoc(doc(db, publicCollectionPath, bookingId), updatedData);
                
                showAlert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                closeEditModal();

            } catch (error) {
                console.error("Error updating document: ", error);
                // Important: Show error, especially if permission is denied by Firestore Security Rules
                showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${error.message} (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)`, 'error');
            } finally {
                saveEditBtn.disabled = false;
                saveEditBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            }
        });

        // Event Listeners for Modal
        document.getElementById('closeModalBtn').addEventListener('click', closeEditModal);
        
        // Close modal when clicking outside (overlay)
        editModal.addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });

        // --- DELETE CONFIRMATION FUNCTIONS ---
        const deleteConfirmContainer = document.getElementById('deleteConfirmContainer');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        function showDeleteConfirm(event) {
            const bookingId = event.currentTarget.getAttribute('data-id');
            confirmDeleteBtn.setAttribute('data-booking-id', bookingId);
            deleteConfirmContainer.classList.remove('hidden');
            deleteConfirmContainer.style.opacity = '1';
            deleteConfirmContainer.style.transform = 'translateY(0)';
        }

        function hideDeleteConfirm() {
            deleteConfirmContainer.style.opacity = '0';
            deleteConfirmContainer.style.transform = 'translateY(20px)';
            setTimeout(() => {
                 deleteConfirmContainer.classList.add('hidden');
            }, 300);
        }

        document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteConfirm);
        
        confirmDeleteBtn.addEventListener('click', async function(e) {
            const bookingId = e.currentTarget.getAttribute('data-booking-id');
            
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';

            const publicCollectionPath = 'artifacts/' + appId + '/public/data/company_bookings';
            // Since private document ID is different, we can only reliably delete the public one.
            
            try {
                // Delete Public Record
                await deleteDoc(doc(db, publicCollectionPath, bookingId));

                // Optional: Attempt to delete private record (Requires matching logic which is not present)
                // For simplicity and focus on public schedule, we rely on the public delete.
                
                showAlert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'success');
                hideDeleteConfirm();
            } catch (error) {
                console.error("Error deleting document: ", error);
                showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message} (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)`, 'error');
            } finally {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö';
            }
        });

        // --- INITIALIZATION ---
        
        // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÅ‡∏•‡∏∞ Listener
        
        // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô Host ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ
        const USER_FIREBASE_CONFIG_DATA = {
            apiKey: "AIzaSyAgTPzz6xqCOVYgWUK0z8-978qKUoDvTy8",
            authDomain: "onlinecarbooking-b623d.firebaseapp.com",
            projectId: "onlinecarbooking-b623d",
            storageBucket: "onlinecarbooking-b623d.firebasestorage.app",
            messagingSenderId: "39587745476",
            appId: "1:39587745476:web:30be6ad23ac47bc3c5c391",
            measurementId: "G-KCPHGGCJ56"
        };
        
        // ‡πÉ‡∏ä‡πâ config ‡∏à
